<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Gestione Concessionaria PERICAR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.9rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: white;
            color: #2c3e50;
            padding: 30px;
            text-align: center;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.8;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab.active {
            color: #2c3e50;
            background: white;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }

        .nav-tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 0.95rem;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(86, 171, 47, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(245, 87, 108, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.2);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .contract-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            font-family: Arial, sans-serif;
            font-size: 0.75rem;
            line-height: 1.2;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .contract-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
        }

        .contract-section {
            margin-bottom: 15px;
        }

        .contract-section h3 {
            background: #f8f9fa;
            padding: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            font-size: 0.85rem;
        }

        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .signature-box {
            text-align: center;
            padding: 10px 0;
        }

        .signature-line {
            border-bottom: 1px solid #333;
            margin-bottom: 8px;
            height: 30px;
        }

        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; }
            .nav-tabs, .btn { display: none; }
            .tab-content { display: block !important; padding: 0; }
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-danger {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://gestionalevero.netlify.app/logopericar.png" alt="PERICAR Logo" style="height: 80px; width: auto; margin-bottom: 15px;">
            <p>Sistema di Gestione Concessionaria - Corso Casale 99, Asti</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('clienti')">üë• Clienti</button>
            <button class="nav-tab" onclick="showTab('auto')">üöô Auto in Stock</button>
            <button class="nav-tab" onclick="showTab('contratti')">üìã Contratti</button>
            <button class="nav-tab" onclick="showTab('statistiche')">üìä Statistiche</button>
        </div>

        <!-- TAB CLIENTI -->
        <div id="clienti" class="tab-content active">
            <h2>Gestione Clienti</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Nome e Cognome</label>
                    <input type="text" id="nomeCliente" placeholder="Mario Rossi">
                </div>
                <div class="form-group">
                    <label>Luogo di Nascita</label>
                    <input type="text" id="luogoNascita" placeholder="Torino">
                </div>
                <div class="form-group">
                    <label>Residenza</label>
                    <input type="text" id="residenza" placeholder="Via Roma 123, Asti">
                </div>
                <div class="form-group">
                    <label>Codice Fiscale</label>
                    <input type="text" id="codiceFiscale" placeholder="RSSMRA80A01L219K">
                </div>
                <div class="form-group">
                    <label>Professione</label>
                    <input type="text" id="professione" placeholder="Impiegato">
                </div>
                <div class="form-group">
                    <label>Telefono</label>
                    <input type="text" id="telefono" placeholder="+39 333 1234567">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="emailCliente" placeholder="mario.rossi@email.com">
                </div>
            </div>

            <button class="btn btn-primary" onclick="aggiungiCliente()">‚ûï Aggiungi Cliente</button>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Telefono</th>
                        <th>Email</th>
                        <th>Codice Fiscale</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="tabellaClienti"></tbody>
            </table>
        </div>

        <!-- TAB AUTO -->
        <div id="auto" class="tab-content">
            <h2>Gestione Auto in Stock</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Marca</label>
                    <input type="text" id="marca" placeholder="BMW">
                </div>
                <div class="form-group">
                    <label>Modello</label>
                    <input type="text" id="modello" placeholder="Serie 3">
                </div>
                <div class="form-group">
                    <label>Versione</label>
                    <input type="text" id="versione" placeholder="320d xDrive">
                </div>
                <div class="form-group">
                    <label>Targa</label>
                    <input type="text" id="targa" placeholder="AB123CD">
                </div>
                <div class="form-group">
                    <label>Telaio</label>
                    <input type="text" id="telaio" placeholder="WBA123456789">
                </div>
                <div class="form-group">
                    <label>Data Immatricolazione</label>
                    <input type="date" id="dataImmatricolazione">
                </div>
                <div class="form-group">
                    <label>Chilometri</label>
                    <input type="number" id="chilometri" placeholder="50000">
                </div>
                <div class="form-group">
                    <label>Prezzo di Acquisto (‚Ç¨)</label>
                    <input type="number" id="prezzoAcquisto" placeholder="25000">
                </div>
                <div class="form-group">
                    <label>Prezzo di Vendita (‚Ç¨)</label>
                    <input type="number" id="prezzoVendita" placeholder="28000">
                </div>
                <div class="form-group">
                    <label>Costi Aggiuntivi (‚Ç¨)</label>
                    <input type="number" id="costiAggiuntivi" placeholder="500">
                </div>
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="tipoAuto">
                        <option value="NUOVO">NUOVO</option>
                        <option value="KM0">KM0</option>
                        <option value="USATO">USATO</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Stato</label>
                    <select id="statoAuto">
                        <option value="Disponibile">Disponibile</option>
                        <option value="Venduta">Venduta</option>
                        <option value="In Trattativa">In Trattativa</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-success" onclick="aggiungiAuto()">üöó Aggiungi Auto</button>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>Marca/Modello</th>
                        <th>Targa</th>
                        <th>Immatricolazione</th>
                        <th>Km</th>
                        <th>Tipo</th>
                        <th>Prezzo Vendita</th>
                        <th>Margine</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="tabellaAuto"></tbody>
            </table>
        </div>

        <!-- TAB CONTRATTI -->
        <div id="contratti" class="tab-content">
            <h2>Gestione Contratti</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Cliente</label>
                    <select id="clienteContratto">
                        <option value="">Seleziona Cliente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Auto da Vendere</label>
                    <select id="autoContratto">
                        <option value="">Seleziona Auto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Data Contratto</label>
                    <input type="date" id="dataContratto">
                </div>
                <div class="form-group">
                    <label>Luogo</label>
                    <input type="text" id="luogoContratto" value="Asti" placeholder="Asti">
                </div>
            </div>

            <h3>Auto in Permuta (Opzionale)</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Marca Permuta</label>
                    <input type="text" id="marcaPermuta" placeholder="Fiat">
                </div>
                <div class="form-group">
                    <label>Modello Permuta</label>
                    <input type="text" id="modelloPermuta" placeholder="Punto">
                </div>
                <div class="form-group">
                    <label>Targa Permuta</label>
                    <input type="text" id="targaPermuta" placeholder="EF456GH">
                </div>
                <div class="form-group">
                    <label>Telaio Permuta</label>
                    <input type="text" id="telaioPermuta" placeholder="ZFA123456789">
                </div>
                <div class="form-group">
                    <label>Data Immatricolazione Permuta</label>
                    <input type="date" id="dataImmatricolazionePermuta">
                </div>
                <div class="form-group">
                    <label>Km Permuta</label>
                    <input type="number" id="chilometriPermuta" placeholder="80000">
                </div>
                <div class="form-group">
                    <label>Versione Permuta</label>
                    <input type="text" id="versionePermuta" placeholder="1.2 Benzina">
                </div>
                <div class="form-group">
                    <label>Valutazione Permuta (‚Ç¨)</label>
                    <input type="number" id="valutazionePermuta" placeholder="8000">
                </div>
            </div>

            <h3>Dettagli Economici</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Deposito Cauzionale (‚Ç¨)</label>
                    <input type="number" id="depositoCauzionale" placeholder="1000">
                </div>
                <div class="form-group">
                    <label>Spese Voltura/Minivoltura (‚Ç¨)</label>
                    <input type="number" id="speseVoltura" placeholder="350">
                </div>
            </div>

            <button class="btn btn-primary" onclick="creaContratto()">üìã Crea Contratto</button>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Cliente</th>
                        <th>Auto</th>
                        <th>Prezzo</th>
                        <th>Permuta</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="tabellaContratti"></tbody>
            </table>
        </div>

        <!-- TAB STATISTICHE -->
        <div id="statistiche" class="tab-content">
            <h2>Statistiche e Conto Economico</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totaleAuto">0</h3>
                    <p>Auto in Stock</p>
                </div>
                <div class="stat-card">
                    <h3 id="totaleContratti">19</h3>
                    <p>Contratti Firmati</p>
                </div>
                <div class="stat-card">
                    <h3 id="fatturatoTotale">‚Ç¨132.020</h3>
                    <p>Fatturato Totale</p>
                </div>
            </div>

            <div class="contract-preview">
                <h3>üìä Conto Economico Stock Auto</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Auto</th>
                            <th>Prezzo Acquisto</th>
                            <th>Costi Aggiuntivi</th>
                            <th>Costo Totale</th>
                            <th>Prezzo Vendita</th>
                            <th>Margine</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="contoEconomicoStock"></tbody>
                </table>
            </div>

            <div class="contract-preview" style="margin-top: 30px;">
                <h3>üöó Auto Vendute</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Auto</th>
                            <th>Data Vendita</th>
                            <th>Cliente</th>
                            <th>Prezzo Vendita</th>
                            <th>Margine</th>
                        </tr>
                    </thead>
                    <tbody id="autoVendute"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL MODIFICA GENERALE -->
    <div id="modalModifica" class="modal">
        <div class="modal-content">
            <span class="close" onclick="chiudiModal()">&times;</span>
            <h2 id="titoloModifica">Modifica</h2>
            <div id="contenutoModifica"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-success" onclick="salvaModifica()">üíæ Salva</button>
                <button class="btn btn-danger" onclick="chiudiModal()">‚ùå Annulla</button>
            </div>
        </div>
    </div>

    <!-- MODAL CONTRATTO -->
    <div id="modalContratto" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="chiudiModalContratto()">&times;</span>
            <div id="contrattoCompleto"></div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="stampaContratto()">üñ®Ô∏è Stampa Contratto</button>
                <button class="btn btn-danger" onclick="chiudiModalContratto()">‚ùå Chiudi</button>
            </div>
        </div>
    </div>

    <script>
        // Dati globali
        let clienti = JSON.parse(localStorage.getItem('clienti')) || [];
        let auto = JSON.parse(localStorage.getItem('auto')) || [];
        let contratti = JSON.parse(localStorage.getItem('contratti')) || [];
        let oggettoInModifica = null;
        let tipoOggettoInModifica = '';

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            aggiornaTabelle();
            aggiornaStatistiche();
            aggiornaSelectClienti();
            aggiornaSelectAuto();
            
            // Imposta data odierna
            document.getElementById('dataContratto').value = new Date().toISOString().split('T')[0];
        });

        // Gestione tab
        function showTab(tabName) {
            // Nascondi tutti i tab
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostra tab selezionato
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // GESTIONE CLIENTI
        function aggiungiCliente() {
            const nome = document.getElementById('nomeCliente').value;
            const luogoNascita = document.getElementById('luogoNascita').value;
            const residenza = document.getElementById('residenza').value;
            const codiceFiscale = document.getElementById('codiceFiscale').value;
            const professione = document.getElementById('professione').value;
            const telefono = document.getElementById('telefono').value;
            const email = document.getElementById('emailCliente').value;

            if (!nome || !telefono) {
                alert('Nome e telefono sono obbligatori!');
                return;
            }

            const cliente = {
                id: Date.now(),
                nome,
                luogoNascita,
                residenza,
                codiceFiscale,
                professione,
                telefono,
                email
            };

            clienti.push(cliente);
            salvaClienti();
            aggiornaTabelle();
            aggiornaStatistiche();
            aggiornaSelectClienti();
            pulisciFormCliente();
        }

        function pulisciFormCliente() {
            document.getElementById('nomeCliente').value = '';
            document.getElementById('luogoNascita').value = '';
            document.getElementById('residenza').value = '';
            document.getElementById('codiceFiscale').value = '';
            document.getElementById('professione').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('emailCliente').value = '';
        }

        // GESTIONE AUTO
        function aggiungiAuto() {
            const marca = document.getElementById('marca').value;
            const modello = document.getElementById('modello').value;
            const versione = document.getElementById('versione').value;
            const targa = document.getElementById('targa').value;
            const telaio = document.getElementById('telaio').value;
            const dataImmatricolazione = document.getElementById('dataImmatricolazione').value;
            const chilometri = document.getElementById('chilometri').value;
            const prezzoAcquisto = parseFloat(document.getElementById('prezzoAcquisto').value) || 0;
            const prezzoVendita = parseFloat(document.getElementById('prezzoVendita').value) || 0;
            const tipo = document.getElementById('tipoAuto').value;
            const stato = document.getElementById('statoAuto').value;

            if (!marca || !modello || !targa) {
                alert('Marca, modello e targa sono obbligatori!');
                return;
            }

            const autoObj = {
                id: Date.now(),
                marca,
                modello,
                versione,
                targa,
                telaio,
                dataImmatricolazione,
                chilometri: parseInt(chilometri) || 0,
                prezzoAcquisto,
                prezzoVendita,
                costiAggiuntivi: parseFloat(document.getElementById('costiAggiuntivi').value) || 0,
                tipo,
                stato
            };

            auto.push(autoObj);
            salvaAuto();
            aggiornaTabelle();
            aggiornaStatistiche();
            aggiornaSelectAuto();
            pulisciFormAuto();
        }

        function pulisciFormAuto() {
            document.getElementById('marca').value = '';
            document.getElementById('modello').value = '';
            document.getElementById('versione').value = '';
            document.getElementById('targa').value = '';
            document.getElementById('telaio').value = '';
            document.getElementById('dataImmatricolazione').value = '';
            document.getElementById('chilometri').value = '';
            document.getElementById('prezzoAcquisto').value = '';
            document.getElementById('prezzoVendita').value = '';
            document.getElementById('costiAggiuntivi').value = '';
            document.getElementById('tipoAuto').value = 'NUOVO';
            document.getElementById('statoAuto').value = 'Disponibile';
        }

        // GESTIONE CONTRATTI
        function creaContratto() {
            const clienteId = document.getElementById('clienteContratto').value;
            const autoId = document.getElementById('autoContratto').value;
            const dataContratto = document.getElementById('dataContratto').value;
            const luogo = document.getElementById('luogoContratto').value;

            if (!clienteId || !autoId || !dataContratto) {
                alert('Cliente, auto e data sono obbligatori!');
                return;
            }

            const cliente = clienti.find(c => c.id == clienteId);
            const autoVenduta = auto.find(a => a.id == autoId);

            // Dati permuta (opzionali)
            const permuta = {
                marca: document.getElementById('marcaPermuta').value,
                modello: document.getElementById('modelloPermuta').value,
                targa: document.getElementById('targaPermuta').value,
                telaio: document.getElementById('telaioPermuta').value,
                dataImmatricolazione: document.getElementById('dataImmatricolazionePermuta').value,
                chilometri: parseInt(document.getElementById('chilometriPermuta').value) || 0,
                versione: document.getElementById('versionePermuta').value,
                valutazione: parseFloat(document.getElementById('valutazionePermuta').value) || 0
            };

            const contratto = {
                id: Date.now(),
                clienteId,
                autoId,
                dataContratto,
                luogo,
                permuta,
                depositoCauzionale: parseFloat(document.getElementById('depositoCauzionale').value) || 0,
                speseVoltura: parseFloat(document.getElementById('speseVoltura').value) || 0,
                cliente,
                auto: autoVenduta
            };

            contratti.push(contratto);
            
            // Aggiorna stato auto
            autoVenduta.stato = 'Venduta';
            
            salvaContratti();
            salvaAuto();
            aggiornaTabelle();
            aggiornaStatistiche();
            aggiornaSelectAuto();
            pulisciFormContratto();
            
            // Mostra contratto
            mostraContratto(contratto);
        }

        function pulisciFormContratto() {
            document.getElementById('clienteContratto').value = '';
            document.getElementById('autoContratto').value = '';
            document.getElementById('luogoContratto').value = 'Asti';
            document.getElementById('marcaPermuta').value = '';
            document.getElementById('modelloPermuta').value = '';
            document.getElementById('targaPermuta').value = '';
            document.getElementById('telaioPermuta').value = '';
            document.getElementById('dataImmatricolazionePermuta').value = '';
            document.getElementById('chilometriPermuta').value = '';
            document.getElementById('versionePermuta').value = '';
            document.getElementById('valutazionePermuta').value = '';
            document.getElementById('depositoCauzionale').value = '';
            document.getElementById('speseVoltura').value = '';
        }

        // MODIFICA GENERALE
        function modificaOggetto(tipo, id) {
            let oggetto;
            let campi = [];
            
            if (tipo === 'cliente') {
                oggetto = clienti.find(c => c.id == id);
                campi = [
                    {nome: 'nome', label: 'Nome e Cognome', tipo: 'text'},
                    {nome: 'luogoNascita', label: 'Luogo di Nascita', tipo: 'text'},
                    {nome: 'residenza', label: 'Residenza', tipo: 'text'},
                    {nome: 'codiceFiscale', label: 'Codice Fiscale', tipo: 'text'},
                    {nome: 'professione', label: 'Professione', tipo: 'text'},
                    {nome: 'telefono', label: 'Telefono', tipo: 'text'},
                    {nome: 'email', label: 'Email', tipo: 'email'}
                ];
            } else if (tipo === 'auto') {
                oggetto = auto.find(a => a.id == id);
                campi = [
                    {nome: 'marca', label: 'Marca', tipo: 'text'},
                    {nome: 'modello', label: 'Modello', tipo: 'text'},
                    {nome: 'versione', label: 'Versione', tipo: 'text'},
                    {nome: 'targa', label: 'Targa', tipo: 'text'},
                    {nome: 'telaio', label: 'Telaio', tipo: 'text'},
                    {nome: 'dataImmatricolazione', label: 'Data Immatricolazione', tipo: 'date'},
                    {nome: 'chilometri', label: 'Chilometri', tipo: 'number'},
                    {nome: 'prezzoAcquisto', label: 'Prezzo Acquisto (‚Ç¨)', tipo: 'number'},
                    {nome: 'prezzoVendita', label: 'Prezzo Vendita (‚Ç¨)', tipo: 'number'},
                    {nome: 'costiAggiuntivi', label: 'Costi Aggiuntivi (‚Ç¨)', tipo: 'number'},
                    {nome: 'tipo', label: 'Tipo', tipo: 'select', opzioni: ['NUOVO', 'KM0', 'USATO']},
                    {nome: 'stato', label: 'Stato', tipo: 'select', opzioni: ['Disponibile', 'Venduta', 'In Trattativa']}
                ];
            }
            
            if (!oggetto) return;
            
            oggettoInModifica = oggetto;
            tipoOggettoInModifica = tipo;
            
            document.getElementById('titoloModifica').textContent = `Modifica ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`;
            
            let html = '<div class="form-grid">';
            campi.forEach(campo => {
                html += `<div class="form-group">
                    <label>${campo.label}</label>`;
                
                if (campo.tipo === 'select') {
                    html += `<select id="modifica_${campo.nome}">`;
                    campo.opzioni.forEach(opzione => {
                        const selected = oggetto[campo.nome] === opzione ? 'selected' : '';
                        html += `<option value="${opzione}" ${selected}>${opzione}</option>`;
                    });
                    html += `</select>`;
                } else {
                    html += `<input type="${campo.tipo}" id="modifica_${campo.nome}" value="${oggetto[campo.nome] || ''}">`;
                }
                
                html += `</div>`;
            });
            html += '</div>';
            
            document.getElementById('contenutoModifica').innerHTML = html;
            document.getElementById('modalModifica').style.display = 'block';
        }

        function salvaModifica() {
            if (!oggettoInModifica) return;
            
            // Aggiorna tutti i campi dell'oggetto
            const inputs = document.getElementById('contenutoModifica').querySelectorAll('input, select');
            inputs.forEach(input => {
                const campo = input.id.replace('modifica_', '');
                if (input.type === 'number') {
                    oggettoInModifica[campo] = parseFloat(input.value) || 0;
                } else {
                    oggettoInModifica[campo] = input.value;
                }
            });
            
            // Salva nel localStorage
            if (tipoOggettoInModifica === 'cliente') {
                salvaClienti();
                aggiornaSelectClienti();
            } else if (tipoOggettoInModifica === 'auto') {
                salvaAuto();
                aggiornaSelectAuto();
            }
            
            aggiornaTabelle();
            aggiornaStatistiche();
            chiudiModal();
        }

        function chiudiModal() {
            document.getElementById('modalModifica').style.display = 'none';
            oggettoInModifica = null;
            tipoOggettoInModifica = '';
        }

        function modificaCostiAuto(id) {
            const autoObj = auto.find(a => a.id == id);
            if (!autoObj) return;
            
            oggettoInModifica = autoObj;
            tipoOggettoInModifica = 'auto';
            
            document.getElementById('titoloModifica').textContent = 'Modifica Costi Auto';
            
            const html = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>Auto</label>
                        <input type="text" value="${autoObj.marca} ${autoObj.modello} (${autoObj.targa})" readonly>
                    </div>
                    <div class="form-group">
                        <label>Prezzo Acquisto (‚Ç¨)</label>
                        <input type="number" id="modifica_prezzoAcquisto" value="${autoObj.prezzoAcquisto}">
                    </div>
                    <div class="form-group">
                        <label>Costi Aggiuntivi (‚Ç¨)</label>
                        <input type="number" id="modifica_costiAggiuntivi" value="${autoObj.costiAggiuntivi || 0}">
                    </div>
                    <div class="form-group">
                        <label>Prezzo Vendita (‚Ç¨)</label>
                        <input type="number" id="modifica_prezzoVendita" value="${autoObj.prezzoVendita}">
                    </div>
                    <div class="form-group">
                        <label>Descrizione Costi</label>
                        <textarea id="modifica_descrizioneCosti" placeholder="Es: Riparazione freni, Tagliando, Pneumatici...">${autoObj.descrizioneCosti || ''}</textarea>
                    </div>
                </div>
            `;
            
            document.getElementById('contenutoModifica').innerHTML = html;
            document.getElementById('modalModifica').style.display = 'block';
        }

        // ELIMINAZIONE
        function eliminaCliente(id) {
            if (confirm('Sei sicuro di voler eliminare questo cliente?')) {
                clienti = clienti.filter(c => c.id != id);
                salvaClienti();
                aggiornaTabelle();
                aggiornaStatistiche();
                aggiornaSelectClienti();
            }
        }

        function eliminaAuto(id) {
            if (confirm('Sei sicuro di voler eliminare questa auto?')) {
                auto = auto.filter(a => a.id != id);
                salvaAuto();
                aggiornaTabelle();
                aggiornaStatistiche();
                aggiornaSelectAuto();
            }
        }

        function eliminaContratto(id) {
            if (confirm('Sei sicuro di voler eliminare questo contratto?')) {
                const contratto = contratti.find(c => c.id == id);
                if (contratto) {
                    // Rimetti l'auto come disponibile
                    const autoContratto = auto.find(a => a.id == contratto.autoId);
                    if (autoContratto) {
                        autoContratto.stato = 'Disponibile';
                        salvaAuto();
                    }
                }
                
                contratti = contratti.filter(c => c.id != id);
                salvaContratti();
                aggiornaTabelle();
                aggiornaStatistiche();
                aggiornaSelectAuto();
            }
        }

        // AGGIORNAMENTO TABELLE
        function aggiornaTabelle() {
            aggiornaTabelliaClienti();
            aggiornaTabellaAuto();
            aggiornaTabellaContratti();
            aggiornaContoEconomicoStock();
        }

        function aggiornaTabelliaClienti() {
            const tbody = document.getElementById('tabellaClienti');
            tbody.innerHTML = '';
            
            clienti.forEach(cliente => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${cliente.nome}</td>
                    <td>${cliente.telefono}</td>
                    <td>${cliente.email || '-'}</td>
                    <td>${cliente.codiceFiscale || '-'}</td>
                    <td class="actions">
                        <button class="btn btn-warning" onclick="modificaOggetto('cliente', ${cliente.id})">‚úèÔ∏è Modifica</button>
                        <button class="btn btn-danger" onclick="eliminaCliente(${cliente.id})">üóëÔ∏è Elimina</button>
                    </td>
                `;
            });
        }

        function aggiornaTabellaAuto() {
            const tbody = document.getElementById('tabellaAuto');
            tbody.innerHTML = '';
            
            auto.filter(autoObj => autoObj.stato !== 'Venduta').forEach(autoObj => {
                const costoTotale = autoObj.prezzoAcquisto + (autoObj.costiAggiuntivi || 0);
                const margine = autoObj.prezzoVendita - costoTotale;
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${autoObj.marca} ${autoObj.modello}</td>
                    <td>${autoObj.targa}</td>
                    <td>${autoObj.dataImmatricolazione ? new Date(autoObj.dataImmatricolazione).toLocaleDateString('it-IT') : '-'}</td>
                    <td>${autoObj.chilometri.toLocaleString()}</td>
                    <td><span style="background: ${autoObj.tipo === 'NUOVO' ? '#28a745' : autoObj.tipo === 'KM0' ? '#ffc107' : '#6c757d'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">${autoObj.tipo}</span></td>
                    <td>‚Ç¨${autoObj.prezzoVendita.toLocaleString()}</td>
                    <td style="color: ${margine >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">‚Ç¨${margine.toLocaleString()}</td>
                    <td class="actions">
                        <button class="btn btn-warning" onclick="modificaOggetto('auto', ${autoObj.id})">‚úèÔ∏è Modifica</button>
                        <button class="btn btn-danger" onclick="eliminaAuto(${autoObj.id})">üóëÔ∏è Elimina</button>
                    </td>
                `;
            });
        }

        function aggiornaTabellaContratti() {
            const tbody = document.getElementById('tabellaContratti');
            tbody.innerHTML = '';
            
            contratti.forEach(contratto => {
                const row = tbody.insertRow();
                const permutaText = contratto.permuta.marca ? `${contratto.permuta.marca} ${contratto.permuta.modello} (‚Ç¨${contratto.permuta.valutazione.toLocaleString()})` : 'Nessuna';
                
                row.innerHTML = `
                    <td>${new Date(contratto.dataContratto).toLocaleDateString('it-IT')}</td>
                    <td>${contratto.cliente.nome}</td>
                    <td>${contratto.auto.marca} ${contratto.auto.modello}</td>
                    <td>‚Ç¨${contratto.auto.prezzoVendita.toLocaleString()}</td>
                    <td>${permutaText}</td>
                    <td class="actions">
                        <button class="btn btn-primary" onclick="mostraContratto(${JSON.stringify(contratto).replace(/"/g, '&quot;')})">üìã Visualizza</button>
                        <button class="btn btn-warning" onclick="modificaContratto(${contratto.id})">‚úèÔ∏è Modifica</button>
                        <button class="btn btn-danger" onclick="eliminaContratto(${contratto.id})">üóëÔ∏è Elimina</button>
                    </td>
                `;
            });
        }

        function aggiornaContoEconomicoStock() {
            const tbody = document.getElementById('contoEconomicoStock');
            tbody.innerHTML = '';
            
            auto.filter(autoObj => autoObj.stato !== 'Venduta').forEach(autoObj => {
                const costiAggiuntivi = autoObj.costiAggiuntivi || 0;
                const costoTotale = autoObj.prezzoAcquisto + costiAggiuntivi;
                const margine = autoObj.prezzoVendita - costoTotale;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${autoObj.marca} ${autoObj.modello} (${autoObj.targa})</td>
                    <td>‚Ç¨${autoObj.prezzoAcquisto.toLocaleString()}</td>
                    <td>‚Ç¨${costiAggiuntivi.toLocaleString()}</td>
                    <td>‚Ç¨${costoTotale.toLocaleString()}</td>
                    <td>‚Ç¨${autoObj.prezzoVendita.toLocaleString()}</td>
                    <td style="color: ${margine >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">‚Ç¨${margine.toLocaleString()}</td>
                    <td class="actions">
                        <button class="btn btn-warning" onclick="modificaCostiAuto(${autoObj.id})">üí∞ Costi</button>
                    </td>
                `;
            });
            
            // Aggiorna tabella auto vendute
            const tbodyVendute = document.getElementById('autoVendute');
            tbodyVendute.innerHTML = '';
            
            contratti.forEach(contratto => {
                const autoVenduta = contratto.auto;
                const costoTotale = autoVenduta.prezzoAcquisto + (autoVenduta.costiAggiuntivi || 0);
                const margine = autoVenduta.prezzoVendita - costoTotale;
                
                const row = tbodyVendute.insertRow();
                row.innerHTML = `
                    <td>${autoVenduta.marca} ${autoVenduta.modello} (${autoVenduta.targa})</td>
                    <td>${new Date(contratto.dataContratto).toLocaleDateString('it-IT')}</td>
                    <td>${contratto.cliente.nome}</td>
                    <td>‚Ç¨${autoVenduta.prezzoVendita.toLocaleString()}</td>
                    <td style="color: ${margine >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">‚Ç¨${margine.toLocaleString()}</td>
                `;
            });
        }

        // AGGIORNAMENTO SELECT
        function aggiornaSelectClienti() {
            const select = document.getElementById('clienteContratto');
            select.innerHTML = '<option value="">Seleziona Cliente</option>';
            
            clienti.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id;
                option.textContent = cliente.nome;
                select.appendChild(option);
            });
        }

        function aggiornaSelectAuto() {
            const select = document.getElementById('autoContratto');
            select.innerHTML = '<option value="">Seleziona Auto</option>';
            
            auto.filter(a => a.stato === 'Disponibile').forEach(autoObj => {
                const option = document.createElement('option');
                option.value = autoObj.id;
                option.textContent = `${autoObj.marca} ${autoObj.modello} (${autoObj.targa}) - ‚Ç¨${autoObj.prezzoVendita.toLocaleString()}`;
                select.appendChild(option);
            });
        }

        // STATISTICHE
        function aggiornaStatistiche() {
            const autoInStock = auto.filter(a => a.stato !== 'Venduta').length;
            document.getElementById('totaleAuto').textContent = autoInStock;
            document.getElementById('totaleContratti').textContent = 19 + contratti.length;
            
            const fatturatoContratti = contratti.reduce((sum, contratto) => sum + contratto.auto.prezzoVendita, 0);
            const fatturatoTotale = 132020 + fatturatoContratti;
            document.getElementById('fatturatoTotale').textContent = `‚Ç¨${fatturatoTotale.toLocaleString()}`;
        }

        // CONTRATTO
        function mostraContratto(contratto) {
            const totaleASaldo = contratto.auto.prezzoVendita - (contratto.permuta.valutazione || 0) - contratto.depositoCauzionale + contratto.speseVoltura;
            
            const html = `
                <div class="contract-preview">
                    <!-- Header con logo e titolo -->
                    <div style="text-align: center; margin-bottom: 4px;">
                        <img src="https://gestionalevero.netlify.app/logopericar2.png" alt="PERICAR Logo" style="height: 2.4cm; width: auto; margin-bottom: 2px;">
                        <div style="background: #dc3545; color: white; padding: 6px; margin: 0 -30px; font-size: 0.9rem; font-weight: bold; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">PROPOSTA D'ACQUISTO</div>
                        <div style="text-align: right; margin: 3px 0; font-size: 0.7rem;">
                            <strong>Luogo e data:</strong> ${contratto.luogo}, ${new Date(contratto.dataContratto).toLocaleDateString('it-IT')}
                        </div>
                    </div>

                    <!-- Layout principale con due colonne -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 10px;">
                        <!-- Colonna sinistra - Dati principali -->
                        <div>
                            <!-- Testo legale con dati cliente -->
                            <div style="margin-bottom: 10px; font-size: 0.7rem; line-height: 1.3;">
                                <p style="margin-bottom: 6px;">Il sottoscritto <strong>${contratto.cliente.nome}</strong>, nato a <strong>${contratto.cliente.luogoNascita || '___________'}</strong>, residente in <strong>${contratto.cliente.residenza || '___________'}</strong>, codice fiscale <strong>${contratto.cliente.codiceFiscale || '___________'}</strong>, professione <strong>${contratto.cliente.professione || '___________'}</strong>, telefono <strong>${contratto.cliente.telefono}</strong>,</p>
                                
                                <p style="margin: 6px 0; text-align: center; font-weight: bold;">
                                    conferisce alla spettabile <strong style="color: #cc0000;">PERICAR di Giacomo Perissinotto</strong>
                                </p>
                                
                                <p style="margin: 6px 0; text-align: center; font-weight: bold; color: #cc0000; font-size: 0.75rem;">
                                    L'ORDINE DI ACQUISTO DEL SEGUENTE VEICOLO:
                                </p>
                                
                                <p style="margin: 6px 0;">
                                    Marca <strong>${contratto.auto.marca}</strong>, modello <strong>${contratto.auto.modello}</strong>${contratto.auto.versione ? ', versione <strong>' + contratto.auto.versione + '</strong>' : ''}, targato <strong>${contratto.auto.targa}</strong>${contratto.auto.telaio ? ', numero di telaio <strong>' + contratto.auto.telaio + '</strong>' : ''}${contratto.auto.dataImmatricolazione ? ', immatricolato in data <strong>' + new Date(contratto.auto.dataImmatricolazione).toLocaleDateString('it-IT') + '</strong>' : ''}, con chilometri <strong>${contratto.auto.chilometri.toLocaleString()}</strong>.
                                </p>
                            </div>

                            <!-- Dati Permuta -->
                            <div style="margin-bottom: 8px;">
                                <h3 style="font-size: 0.8rem; margin-bottom: 5px; background: #f8f9fa; padding: 3px; border-left: 3px solid #cc0000; color: #cc0000; font-weight: bold;">RITIRO VEICOLO IN PERMUTA</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.7rem; border: 1px solid #ddd;">
                                    <tr>
                                        <td style="padding: 4px; border: 1px solid #eee; font-weight: bold; width: 25%;">Marca:</td>
                                        <td style="padding: 4px; border: 1px solid #eee; width: 75%;">${contratto.permuta.marca || '___________'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Modello:</td>
                                        <td style="padding: 4px; border: 1px solid #eee;">${contratto.permuta.modello || '___________'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Versione:</td>
                                        <td style="padding: 4px; border: 1px solid #eee;">${contratto.permuta.versione || '___________'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Targa:</td>
                                        <td style="padding: 4px; border: 1px solid #eee;">${contratto.permuta.targa || '___________'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Telaio:</td>
                                        <td style="padding: 4px; border: 1px solid #eee;">${contratto.permuta.telaio || '___________'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Immatricolazione:</td>
                                        <td style="padding: 4px; border: 1px solid #eee;">${contratto.permuta.dataImmatricolazione ? new Date(contratto.permuta.dataImmatricolazione).toLocaleDateString('it-IT') : '___________'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Km:</td>
                                        <td style="padding: 4px; border: 1px solid #eee;">${contratto.permuta.chilometri ? contratto.permuta.chilometri.toLocaleString() : '___________'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Valutazione:</td>
                                        <td style="padding: 4px; border: 1px solid #eee; font-weight: bold; color: #28a745;">${contratto.permuta.valutazione ? '‚Ç¨' + contratto.permuta.valutazione.toLocaleString() : '‚Ç¨___________'}</td>
                                    </tr>
                                </table>
                                <p style="margin-top: 3px; font-size: 0.65rem;">Importo determinato secondo lo stato d'uso attuale, salvo riduzione per deterioramenti successivi.</p>
                            </div>
                        </div>

                        <!-- Colonna destra - Conto Economico -->
                        <div>
                            <div style="border: 2px solid #dc3545; border-radius: 8px; padding: 10px; background: #fff;">
                                <h3 style="font-size: 0.85rem; margin-bottom: 8px; background: #dc3545; color: white; padding: 6px; margin: -10px -10px 8px -10px; border-radius: 6px 6px 0 0; text-align: center;">RIEPILOGO ECONOMICO</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 6px; font-weight: bold;">PREZZO VEICOLO</td>
                                        <td style="padding: 6px; text-align: right; font-weight: bold;">‚Ç¨${contratto.auto.prezzoVendita.toLocaleString()}</td>
                                    </tr>
                                    ${contratto.permuta.valutazione > 0 ? `
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 6px;">Valore ritiro</td>
                                        <td style="padding: 6px; text-align: right; color: #28a745;">-‚Ç¨${contratto.permuta.valutazione.toLocaleString()}</td>
                                    </tr>
                                    ` : ''}
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 6px;">Deposito cauzionale</td>
                                        <td style="padding: 6px; text-align: right; color: #28a745;">-‚Ç¨${contratto.depositoCauzionale.toLocaleString()}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 6px;">Spese voltura</td>
                                        <td style="padding: 6px; text-align: right;">‚Ç¨${contratto.speseVoltura.toLocaleString()}</td>
                                    </tr>
                                    <tr style="border-top: 2px solid #dc3545; background: #f8f9fa;">
                                        <td style="padding: 8px; font-weight: bold; font-size: 0.8rem;">TOTALE A SALDO</td>
                                        <td style="padding: 8px; text-align: right; font-weight: bold; font-size: 0.9rem; color: #dc3545;">‚Ç¨${totaleASaldo.toLocaleString()}</td>
                                    </tr>
                                </table>
                            </div>

                            <!-- Info Venditore -->
                            <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 6px; font-size: 0.7rem; text-align: center; border: 1px solid #ddd;">
                                <div style="font-weight: bold; margin-bottom: 2px;">PERICAR di Giacomo Perissinotto</div>
                                <div>P.IVA: 01671440053</div>
                                <div>Corso Casale 99, 14100 Asti (AT)</div>
                                <div>Tel: +39 339 6831296</div>
                                <div>giacomo@pericar.it</div>
                            </div>
                        </div>
                    </div>

                    <!-- Testo legale -->
                    <div style="margin: 6px 0; font-size: 0.65rem; line-height: 1.2;">
                        <p style="margin-bottom: 4px;">Il sottoscritto <strong>${contratto.cliente.nome}</strong> dichiara di essere stato informato di tutto quanto concerne l'acquisto del veicolo oggetto della presente proposta, nonch√© delle condizioni generali del contratto riportate a tergo, che dichiara di aver compreso e che accetta pienamente, e conferisce alla spettabile <strong>PERICAR di Giacomo Perissinotto</strong></p>
                        
                        <p style="margin: 4px 0; font-weight: bold;">L'ORDINE DI ACQUISTO DEL VEICOLO</p>
                        
                        <p style="margin: 4px 0;">nelle condizioni in cui si trova, accertato in sua presenza, alle condizioni a tergo riportate prendendo altres√¨ atto che il venditore ne effettua la vendita:</p>
                        
                        <div style="margin: 4px 0;">
                            <div style="margin-bottom: 2px;"><strong>‚òê IN QUANTO PROPRIETARIO DELLO STESSO</strong></div>
                            <div><strong>‚òê IN FORZA DEL MANDATO SPECIALE ALL'UOPO CONFERITO DAL SIG. ________________________</strong></div>
                        </div>
                    </div>

                    <!-- Firme -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 8px; padding-top: 6px; border-top: 1px solid #ddd;">
                        <div style="text-align: center;">
                            <div style="border-bottom: 1px solid #333; margin-bottom: 4px; height: 20px;"></div>
                            <strong style="font-size: 0.7rem;">Firma acquirente</strong>
                        </div>
                        <div style="text-align: center;">
                            <div style="border-bottom: 1px solid #333; margin-bottom: 4px; height: 20px;"></div>
                            <strong style="font-size: 0.7rem;">Firma venditore</strong>
                        </div>
                    </div>

                    <div style="page-break-before: always; margin-top: 20px;">
                        <h2 style="text-align: center; margin-bottom: 15px; font-size: 1rem;">CONDIZIONI GENERALI DI VENDITA</h2>
                        
                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 1 - Definizioni</h3>
                            <p>Ai fini del presente contratto si intende per: <strong>Buone condizioni:</strong> componente recentemente sostituito o revisionato; <strong>Condizioni standard:</strong> componente con usura conforme all'et√† del veicolo; <strong>Intervento consigliato:</strong> componente da ripristinare a breve termine; <strong>Intervento necessario:</strong> componente da sostituire immediatamente per sicurezza.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 2 - Regolamento generale</h3>
                            <p>Con la sottoscrizione del presente documento il compratore versa il deposito cauzionale indicato e accetta integralmente le presenti condizioni generali di vendita. L'ordine diventa definitivo e vincolante per entrambe le parti solo dopo l'accettazione scritta da parte del venditore. Il venditore si riserva il diritto di rifiutare l'ordine entro 48 ore dalla ricezione.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 3 - Prezzo e modalit√† di pagamento</h3>
                            <p>Il prezzo si intende Franco sede del venditore, salvo diversa pattuizione scritta. Il saldo deve essere corrisposto alla consegna del veicolo mediante bonifico bancario, assegno circolare o contanti nei limiti di legge. Eventuali finanziamenti sono soggetti ad approvazione dell'istituto di credito.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 4 - Consegna e ritiro del veicolo</h3>
                            <p>Il veicolo deve essere ritirato entro 10 giorni dalla data di disponibilit√† se gi√† presente, o entro 5 giorni dalla comunicazione di arrivo se ordinato. Il mancato ritiro nei termini stabiliti comporta la risoluzione automatica del contratto con incameramento del deposito cauzionale a titolo di penale. Il compratore √® tenuto a verificare lo stato del veicolo al momento del ritiro.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 5 - Garanzia di conformit√†</h3>
                            <p>Per i consumatori si applica la garanzia legale di conformit√† di 12 mesi prevista dal D.Lgs 206/2005. Il compratore dichiara di aver visionato personalmente il veicolo e di accettarlo nelle condizioni di fatto e di diritto in cui si trova. I difetti di conformit√† sono coperti solo se non derivanti da normale usura, uso improprio, mancata manutenzione o eventi accidentali. La responsabilit√† del venditore √® esclusa per danni derivanti da uso improprio del veicolo. Per gli acquirenti titolari di partita IVA si applica esclusivamente l'art. 1490 e seguenti del Codice Civile con espressa esclusione della garanzia di conformit√†.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 6 - Trattamento dati personali (GDPR 2016/679)</h3>
                            <p>I dati personali sono trattati per: adempimenti di obblighi legali, gestione rapporto clientela, attivit√† di marketing. Base giuridica: consenso, interesse legittimo, obbligo legale. Conservazione: 10 anni dalla cessazione rapporto. Diritti: accesso, rettifica, cancellazione, portabilit√†, opposizione. Titolare: PERICAR di Giacomo Perissinotto. Per esercitare i diritti: giacomo@pericar.it</p>
                            <div style="display: flex; gap: 15px; margin: 5px 0;">
                                <label style="font-size: 0.5rem;"><input type="checkbox"> NON acconsento al trattamento per finalit√† di marketing</label>
                                <label style="font-size: 0.5rem;"><input type="checkbox"> ACCONSENTO al trattamento per finalit√† di marketing</label>
                            </div>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 7 - Tributi e oneri</h3>
                            <p>Tutti i tributi, oneri fiscali, spese di trasferimento di propriet√† e assicurazione RC auto sono a carico del compratore. Il venditore fornisce assistenza per le pratiche amministrative dietro compenso delle spese sostenute.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 8 - Risoluzione controversie e foro competente</h3>
                            <p>Per i rapporti con i consumatori √® competente il foro del luogo di residenza del compratore. Per i rapporti commerciali √® competente esclusivamente il foro della sede del venditore. Le parti si impegnano a tentare la risoluzione amichevole delle controversie prima di adire l'autorit√† giudiziaria.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 9 - Diritto di recesso (solo consumatori)</h3>
                            <p>Il consumatore ha diritto di recedere dal contratto entro 14 giorni dalla consegna senza penali, restituendo il veicolo nelle stesse condizioni. Le spese di restituzione sono a carico del consumatore. Il diritto decade se il veicolo presenta segni di usura oltre la normale prova.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 10 - Clausole finali</h3>
                            <p>Eventuali modifiche devono essere concordate per iscritto. La nullit√† di singole clausole non comporta nullit√† dell'intero contratto. Il contratto √® regolato dalla legge italiana. Per quanto non espressamente previsto si applicano le norme del Codice Civile e del Codice del Consumo.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 11 - Condizioni di vendita per veicoli usati</h3>
                            <p>Il venditore dichiara che il veicolo oggetto della presente vendita √® stato sottoposto a regolare manutenzione e controllo tecnico. Tuttavia, trattandosi di veicolo usato, il compratore accetta espressamente che possano essere presenti segni di normale usura compatibili con l'et√† e i chilometri percorsi dal veicolo. Il venditore garantisce la regolarit√† della documentazione e l'assenza di vincoli o gravami non dichiarati.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 12 - Limitazione di responsabilit√†</h3>
                            <p>La responsabilit√† del venditore per vizi o difetti del veicolo √® limitata al valore del veicolo stesso. √à esclusa ogni responsabilit√† per danni indiretti, lucro cessante, danni a cose o persone derivanti dall'uso del veicolo. Il compratore si impegna a mantenere il veicolo in perfetta efficienza e a rispettare tutte le norme del Codice della Strada.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 13 - Passaggio di propriet√†</h3>
                            <p>Il passaggio di propriet√† del veicolo avverr√† mediante registrazione presso il PRA entro 60 giorni dalla data del contratto. Fino al perfezionamento del passaggio di propriet√†, il compratore si assume ogni responsabilit√† civile e penale derivante dall'uso del veicolo. Le spese per il passaggio di propriet√† sono a carico del compratore.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 14 - Clausola risolutiva espressa</h3>
                            <p>Il contratto si risolve di diritto, senza necessit√† di messa in mora, in caso di: mancato pagamento del saldo nei termini stabiliti; mancato ritiro del veicolo nei termini previsti; inadempimento di qualsiasi altra obbligazione contrattuale. In caso di risoluzione, il venditore ha diritto al risarcimento dei danni e all'incameramento del deposito cauzionale.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 15 - Normativa applicabile</h3>
                            <p>Il presente contratto √® regolato dalla legge italiana. Per i rapporti con i consumatori si applicano le disposizioni del Codice del Consumo (D.Lgs. 206/2005). Per i rapporti commerciali si applicano le disposizioni del Codice Civile. Ogni controversia sar√† devoluta alla competenza dell'Autorit√† Giudiziaria del foro di Asti.</p>
                        </div>

                        <div style="margin-top: 10px; padding: 6px; border: 1px solid #333; font-size: 0.5rem;">
                            <p><strong>APPROVAZIONE SPECIFICA (art. 1341-1342 c.c.):</strong> Il compratore dichiara di aver letto, compreso e di approvare espressamente i seguenti articoli delle condizioni generali di vendita: Art. 2 (regolamento generale), Art. 4 (consegna e ritiro), Art. 5 (garanzia di conformit√†), Art. 8 (foro competente), Art. 12 (limitazione di responsabilit√†), Art. 14 (clausola risolutiva espressa), Art. 15 (normativa applicabile).</p>
                        </div>

                        <div style="margin-top: 12px;">
                            <div style="text-align: right; margin-bottom: 8px; font-size: 0.6rem;">
                                <strong>${contratto.luogo}, ${new Date(contratto.dataContratto).toLocaleDateString('it-IT')}</strong>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                                <div class="signature-box">
                                    <div class="signature-line"></div>
                                    <strong style="font-size: 0.6rem;">Firma acquirente</strong>
                                </div>
                                <div class="signature-box">
                                    <div class="signature-line"></div>
                                    <strong style="font-size: 0.6rem;">Firma venditore</strong>
                                </div>
                            </div>
                        </div>

                        <div style="page-break-before: always; margin-top: 20px;">
                            <div style="margin-bottom: 10px; font-size: 0.55rem;">
                                <h3 style="font-size: 0.65rem; margin-bottom: 5px; text-align: center;">INFORMATIVA SULLA GARANZIA LEGALE DI CONFORMIT√Ä</h3>
                                <p><strong>Garanzia legale di conformit√† (art. 128 e ss. Codice del Consumo):</strong> Il venditore √® responsabile nei confronti del consumatore per qualsiasi difetto di conformit√† esistente al momento della consegna del bene. Il difetto di conformit√† che si manifesta entro 12 mesi dalla consegna si presume esistente gi√† a tale momento, salvo prova contraria.</p>
                                
                                <p style="margin-top: 6px;"><strong>Diritti del consumatore:</strong> In caso di difetto di conformit√†, il consumatore ha diritto al ripristino, senza spese, della conformit√† del bene mediante riparazione o sostituzione. Se riparazione e sostituzione sono impossibili o eccessivamente onerose, il consumatore pu√≤ chiedere una riduzione del prezzo o la risoluzione del contratto.</p>
                                
                                <p style="margin-top: 6px;"><strong>Termini per far valere i diritti:</strong> Il consumatore decade dai diritti se non denuncia il difetto di conformit√† entro 2 mesi dalla scoperta. I diritti si prescrivono in 26 mesi dalla consegna del bene.</p>
                                
                                <p style="margin-top: 6px;"><strong>Garanzia convenzionale:</strong> Eventuali garanzie convenzionali aggiuntive non limitano n√© escludono la garanzia legale di conformit√†.</p>
                            </div>

                            <div style="margin-top: 15px; padding: 6px; border: 1px solid #333; font-size: 0.5rem;">
                                <p><strong>DICHIARAZIONE:</strong> Dichiaro di aver ricevuto e compreso l'informativa sulla garanzia legale di conformit√† e sui miei diritti come consumatore.</p>
                            </div>

                            <div style="margin-top: 15px;">
                                <div style="text-align: right; margin-bottom: 8px; font-size: 0.6rem;">
                                    <strong>${contratto.luogo}, ${new Date(contratto.dataContratto).toLocaleDateString('it-IT')}</strong>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                                    <div class="signature-box">
                                        <div class="signature-line"></div>
                                        <strong style="font-size: 0.6rem;">Firma acquirente</strong>
                                    </div>
                                    <div class="signature-box">
                                        <div class="signature-line"></div>
                                        <strong style="font-size: 0.6rem;">Firma venditore</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('contrattoCompleto').innerHTML = html;
            document.getElementById('modalContratto').style.display = 'block';
        }

        function chiudiModalContratto() {
            document.getElementById('modalContratto').style.display = 'none';
        }

        function stampaContratto() {
            const printWindow = window.open('', '_blank');
            const contractContent = document.getElementById('contrattoCompleto').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Contratto</title>
                    <style>
                        body { font-family: Arial, sans-serif; font-size: 0.75rem; line-height: 1.2; margin: 15px; }
                        .contract-preview { background: white; }
                        .contract-header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .contract-section { margin-bottom: 10px; }
                        .contract-section h3 { background: #f8f9fa; padding: 6px; margin-bottom: 8px; border-left: 4px solid #667eea; font-size: 0.85rem; }
                        .signature-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; }
                        .signature-box { text-align: center; padding: 10px 0; }
                        .signature-line { border-bottom: 1px solid #333; margin-bottom: 8px; height: 30px; }
                        table { width: 100%; border-collapse: collapse; font-size: 0.7rem; }
                        td { padding: 6px; border-bottom: 1px solid #ddd; }
                        img { height: 3.5cm; width: auto; display: block; margin: 0 auto 10px auto; }
                        @page { margin: 1.5cm; size: A4; }
                        @media print {
                            body { font-size: 0.7rem; line-height: 1.1; }
                            .contract-preview { margin: 0; padding: 0; }
                            table { font-size: 0.65rem; }
                            h2 { font-size: 0.9rem; }
                            h3 { font-size: 0.55rem; }
                        }
                    </style>
                </head>
                <body>
                    ${contractContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        function modificaContratto(id) {
            const contratto = contratti.find(c => c.id == id);
            if (!contratto) return;
            
            // Popola i campi del form con i dati del contratto
            document.getElementById('clienteContratto').value = contratto.clienteId;
            document.getElementById('autoContratto').value = contratto.autoId;
            document.getElementById('dataContratto').value = contratto.dataContratto;
            document.getElementById('luogoContratto').value = contratto.luogo;
            
            // Dati permuta
            document.getElementById('marcaPermuta').value = contratto.permuta.marca || '';
            document.getElementById('modelloPermuta').value = contratto.permuta.modello || '';
            document.getElementById('targaPermuta').value = contratto.permuta.targa || '';
            document.getElementById('telaioPermuta').value = contratto.permuta.telaio || '';
            document.getElementById('dataImmatricolazionePermuta').value = contratto.permuta.dataImmatricolazione || '';
            document.getElementById('chilometriPermuta').value = contratto.permuta.chilometri || '';
            document.getElementById('versionePermuta').value = contratto.permuta.versione || '';
            document.getElementById('valutazionePermuta').value = contratto.permuta.valutazione || '';
            
            // Dettagli economici
            document.getElementById('depositoCauzionale').value = contratto.depositoCauzionale || '';
            document.getElementById('speseVoltura').value = contratto.speseVoltura || '';
            
            // Elimina il contratto esistente per permettere la modifica
            eliminaContratto(id);
            
            // Passa al tab contratti
            showTab('contratti');
            document.querySelector('[onclick="showTab(\'contratti\')"]').click();
            
            alert('Contratto caricato per la modifica. Modifica i dati e clicca "Crea Contratto" per salvare.');
        }

        // SALVATAGGIO DATI
        function salvaClienti() {
            localStorage.setItem('clienti', JSON.stringify(clienti));
        }

        function salvaAuto() {
            localStorage.setItem('auto', JSON.stringify(auto));
        }

        function salvaContratti() {
            localStorage.setItem('contratti', JSON.stringify(contratti));
        }

        // Chiudi modal cliccando fuori
        window.onclick = function(event) {
            const modalModifica = document.getElementById('modalModifica');
            const modalContratto = document.getElementById('modalContratto');
            
            if (event.target == modalModifica) {
                chiudiModal();
            }
            if (event.target == modalContratto) {
                chiudiModalContratto();
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96b7f38bf166bb00',t:'MTc1NDU4MjA1My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
