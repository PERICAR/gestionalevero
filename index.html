<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Gestione Concessionaria PERICAR</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.9rem;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: white;
            color: #1f2937;
            padding: 30px;
            text-align: center;
            border-bottom: 3px solid #1e40af;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.8;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab.active {
            color: #1f2937;
            background: white;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #1e40af;
        }

        .nav-tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 0.95rem;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #1e40af;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(30, 64, 175, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(5, 150, 105, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(217, 119, 6, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(220, 38, 38, 0.3);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(30, 64, 175, 0.2);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .contract-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            font-family: Arial, sans-serif;
            font-size: 0.75rem;
            line-height: 1.2;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .contract-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
        }

        .contract-section {
            margin-bottom: 15px;
        }

        .contract-section h3 {
            background: #f8f9fa;
            padding: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #1e40af;
            font-size: 0.85rem;
        }

        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .signature-box {
            text-align: center;
            padding: 10px 0;
        }

        .signature-line {
            border-bottom: 1px solid #333;
            margin-bottom: 8px;
            height: 30px;
        }

        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; }
            .nav-tabs, .btn { display: none; }
            .tab-content { display: block !important; padding: 0; }
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-danger {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e40af;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .connection-status {
            margin-top: 10px;
            font-size: 0.9rem;
            padding: 8px 15px;
            border-radius: 6px;
            display: inline-block;
        }

        .status-connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://gestionalevero.netlify.app/logopericar.png" alt="PERICAR Logo" style="height: 80px; width: auto; margin-bottom: 15px;">
            <p>Sistema di Gestione Concessionaria - Corso Casale 99, Asti</p>
            <div id="connectionStatus" class="connection-status status-connecting">
                <span class="loading"></span> Connessione al database...
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('clienti')">üë• Clienti</button>
            <button class="nav-tab" onclick="showTab('auto')">üöô Auto in Stock</button>
            <button class="nav-tab" onclick="showTab('contratti')">üìã Contratti</button>
            <button class="nav-tab" onclick="showTab('statistiche')">üìä Statistiche</button>
        </div>

        <!-- TAB CLIENTI -->
        <div id="clienti" class="tab-content active">
            <h2>Gestione Clienti</h2>
            
            <!-- FORM AGGIUNTA CLIENTE -->
            <div id="formAggiungiCliente" style="display: none; background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 30px; border: 2px solid #1e40af;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #1e40af;">‚ûï Aggiungi Nuovo Cliente</h3>
                    <button class="btn btn-danger" onclick="chiudiFormCliente()" style="padding: 8px 15px; font-size: 0.9rem;">‚ùå Chiudi</button>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nome e Cognome *</label>
                        <input type="text" id="nomeCliente" placeholder="Mario Rossi" required>
                    </div>
                    <div class="form-group">
                        <label>Data di Nascita</label>
                        <input type="date" id="dataNascita">
                    </div>
                    <div class="form-group">
                        <label>Luogo di Nascita</label>
                        <input type="text" id="luogoNascita" placeholder="Torino">
                    </div>
                    <div class="form-group">
                        <label>Residenza</label>
                        <input type="text" id="residenza" placeholder="Via Roma 123, Asti">
                    </div>
                    <div class="form-group">
                        <label>Codice Fiscale</label>
                        <input type="text" id="codiceFiscale" placeholder="RSSMRA80A01L219K" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Professione</label>
                        <input type="text" id="professione" placeholder="Impiegato">
                    </div>
                    <div class="form-group">
                        <label>Telefono *</label>
                        <input type="text" id="telefono" placeholder="+39 333 1234567" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="emailCliente" placeholder="mario.rossi@email.com">
                    </div>
                </div>

                <div style="text-align: center; margin-top: 25px;">
                    <button class="btn btn-success" onclick="aggiungiCliente()" style="padding: 15px 30px; font-size: 1.1rem;">üë§ Salva Cliente</button>
                </div>
            </div>

            <!-- PULSANTE AGGIUNGI CLIENTE E RICERCA -->
            <div style="margin-bottom: 25px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; justify-content: space-between;">
                <button class="btn btn-success" onclick="mostraFormCliente()" style="padding: 12px 25px; font-size: 1rem;">‚ûï Aggiungi Cliente</button>
                
                <div style="flex: 1; max-width: 400px;">
                    <input type="text" id="searchClienti" placeholder="üîç Cerca clienti per nome, telefono, email..." style="width: 100%; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;" onkeyup="filtraClienti()">
                </div>
            </div>

            <!-- TABELLA CLIENTI -->
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Telefono</th>
                        <th>Email</th>
                        <th>Codice Fiscale</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="tabellaClienti"></tbody>
            </table>
        </div>

        <!-- TAB AUTO -->
        <div id="auto" class="tab-content">
            <h2>Gestione Auto in Stock</h2>
            
            <!-- FORM AGGIUNTA AUTO -->
            <div id="formAggiungiAuto" style="display: none; background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 30px; border: 2px solid #1e40af;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #1e40af;">‚ûï Aggiungi Nuova Auto</h3>
                    <button class="btn btn-danger" onclick="chiudiFormAuto()" style="padding: 8px 15px; font-size: 0.9rem;">‚ùå Chiudi</button>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Marca *</label>
                        <input type="text" id="marca" placeholder="BMW" required>
                    </div>
                    <div class="form-group">
                        <label>Modello *</label>
                        <input type="text" id="modello" placeholder="Serie 3" required>
                    </div>
                    <div class="form-group">
                        <label>Versione</label>
                        <input type="text" id="versione" placeholder="320d xDrive">
                    </div>
                    <div class="form-group">
                        <label>Targa *</label>
                        <input type="text" id="targa" placeholder="AB123CD" style="text-transform: uppercase;" required>
                    </div>
                    <div class="form-group">
                        <label>Telaio</label>
                        <input type="text" id="telaio" placeholder="WBA123456789" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Data Immatricolazione</label>
                        <input type="date" id="dataImmatricolazione">
                    </div>
                    <div class="form-group">
                        <label>Chilometri</label>
                        <input type="number" id="chilometri" placeholder="50000" min="0">
                    </div>
                    <div class="form-group">
                        <label>Prezzo di Acquisto (‚Ç¨)</label>
                        <input type="number" id="prezzoAcquisto" placeholder="25000" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Prezzo di Vendita (‚Ç¨)</label>
                        <input type="number" id="prezzoVendita" placeholder="28000" min="0" step="0.01">
                    </div>
                </div>

                <h4>Costi Aggiuntivi</h4>
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd;">
                    <div class="form-grid" style="grid-template-columns: 2fr 1fr auto;">
                        <div class="form-group">
                            <label>Descrizione Costo</label>
                            <input type="text" id="descrizioneCostoAuto" placeholder="Es: Riparazione freni, Tagliando, Pneumatici...">
                        </div>
                        <div class="form-group">
                            <label>Importo (‚Ç¨)</label>
                            <input type="number" id="importoCostoAuto" placeholder="500" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="button" class="btn btn-success" onclick="aggiungiCostoAuto()" style="margin-top: 0;">‚ûï Aggiungi</button>
                        </div>
                    </div>
                    
                    <div id="listaCostiAuto" style="margin-top: 15px;"></div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Tipo</label>
                        <select id="tipoAuto">
                            <option value="USATO">USATO</option>
                            <option value="NUOVO">NUOVO</option>
                            <option value="KM0">KM0</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stato</label>
                        <select id="statoAuto">
                            <option value="Disponibile">Disponibile</option>
                            <option value="Venduta">Venduta</option>
                            <option value="In Trattativa">In Trattativa</option>
                        </select>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 25px;">
                    <button class="btn btn-success" onclick="aggiungiAuto()" style="padding: 15px 30px; font-size: 1.1rem;">üöó Salva Auto</button>
                </div>
            </div>

            <!-- PULSANTE AGGIUNGI AUTO E FILTRI -->
            <div style="margin-bottom: 25px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; justify-content: space-between;">
                <button class="btn btn-success" onclick="mostraFormAuto()" style="padding: 12px 25px; font-size: 1rem;">‚ûï Aggiungi Auto</button>
                
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <label style="font-weight: 600;">Visualizza:</label>
                        <select id="filtroStato" onchange="filtraPerStato()" style="padding: 8px 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 0.9rem;">
                            <option value="stock">üöó Auto in Stock</option>
                            <option value="vendute">‚úÖ Auto Vendute</option>
                            <option value="tutte">üìã Tutte le Auto</option>
                        </select>
                    </div>
                    <input type="text" id="searchAuto" placeholder="üîç Cerca auto per marca, modello, targa..." style="min-width: 300px; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;" onkeyup="filtraAuto()">
                </div>
            </div>

            <!-- TABELLA AUTO -->
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Marca/Modello</th>
                        <th>Targa</th>
                        <th>Immatricolazione</th>
                        <th>Km</th>
                        <th>Tipo</th>
                        <th>Stato</th>
                        <th>Prezzo Vendita</th>
                        <th>Margine</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="tabellaAuto"></tbody>
            </table>
        </div>

        <!-- TAB CONTRATTI -->
        <div id="contratti" class="tab-content">
            <h2>Gestione Contratti</h2>
            
            <!-- FORM CREAZIONE CONTRATTO -->
            <div id="formAggiungiContratto" style="display: none; background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 30px; border: 2px solid #1e40af;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #1e40af;">üìã Crea Nuovo Contratto</h3>
                    <button class="btn btn-danger" onclick="chiudiFormContratto()" style="padding: 8px 15px; font-size: 0.9rem;">‚ùå Chiudi</button>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Cliente *</label>
                        <select id="clienteContratto" required>
                            <option value="">Seleziona Cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Auto da Vendere *</label>
                        <select id="autoContratto" required>
                            <option value="">Seleziona Auto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data Contratto *</label>
                        <input type="date" id="dataContratto" required>
                    </div>
                    <div class="form-group">
                        <label>Luogo</label>
                        <input type="text" id="luogoContratto" value="Asti" placeholder="Asti">
                    </div>
                </div>

                <h4>Auto in Permuta (Opzionale)</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Marca Permuta</label>
                        <input type="text" id="marcaPermuta" placeholder="Fiat">
                    </div>
                    <div class="form-group">
                        <label>Modello Permuta</label>
                        <input type="text" id="modelloPermuta" placeholder="Punto">
                    </div>
                    <div class="form-group">
                        <label>Targa Permuta</label>
                        <input type="text" id="targaPermuta" placeholder="EF456GH" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Telaio Permuta</label>
                        <input type="text" id="telaioPermuta" placeholder="ZFA123456789" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Data Immatricolazione Permuta</label>
                        <input type="date" id="dataImmatricolazionePermuta">
                    </div>
                    <div class="form-group">
                        <label>Km Permuta</label>
                        <input type="number" id="chilometriPermuta" placeholder="80000" min="0">
                    </div>
                    <div class="form-group">
                        <label>Versione Permuta</label>
                        <input type="text" id="versionePermuta" placeholder="1.2 Benzina">
                    </div>
                    <div class="form-group">
                        <label>Valutazione Permuta (‚Ç¨)</label>
                        <input type="number" id="valutazionePermuta" placeholder="8000" min="0" step="0.01">
                    </div>
                </div>

                <h4>Dettagli Economici</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Deposito Cauzionale (‚Ç¨)</label>
                        <input type="number" id="depositoCauzionale" placeholder="1000" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Spese Voltura/Minivoltura (‚Ç¨)</label>
                        <input type="number" id="speseVoltura" placeholder="350" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Canale di Vendita</label>
                        <select id="canaleVendita">
                            <option value="Autoscout">Autoscout</option>
                            <option value="Subito">Subito</option>
                            <option value="Conoscenze">Conoscenze</option>
                            <option value="Ingresso spontaneo">Ingresso spontaneo</option>
                            <option value="Cip">Cip</option>
                        </select>
                    </div>
                </div>

                <h4>Sconto e Prezzo Finale</h4>
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd;">
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div class="form-group">
                            <label>Prezzo Base Auto (‚Ç¨)</label>
                            <input type="number" id="prezzoBaseAuto" readonly style="background: #e9ecef; font-weight: bold;" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Sconto Applicato (‚Ç¨)</label>
                            <input type="number" id="scontoApplicato" placeholder="0" onchange="calcolaPrezzoFinale()" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Prezzo Finale Auto (‚Ç¨)</label>
                            <input type="number" id="prezzoFinaleAuto" onchange="calcolaSconto()" style="font-weight: bold; color: #1e40af;" min="0" step="0.01">
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: #d1ecf1; border-radius: 6px; font-size: 0.9rem;">
                        <strong>üí° Suggerimento:</strong> Puoi inserire lo sconto o modificare direttamente il prezzo finale - il calcolo si aggiorna automaticamente!
                    </div>
                </div>

                <h4>Servizi/Accessori Aggiuntivi</h4>
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd;">
                    <div class="form-grid" style="grid-template-columns: 2fr 1fr auto;">
                        <div class="form-group">
                            <label>Descrizione</label>
                            <input type="text" id="descrizioneExtra" placeholder="Es: Assicurazione Kasko, Navigatore, Cerchi in lega...">
                        </div>
                        <div class="form-group">
                            <label>Prezzo (‚Ç¨)</label>
                            <input type="number" id="prezzoExtra" placeholder="500" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="button" class="btn btn-success" onclick="aggiungiExtra()" style="margin-top: 0;">‚ûï Aggiungi</button>
                        </div>
                    </div>
                    
                    <div id="listaExtra" style="margin-top: 15px;"></div>
                </div>

                <div style="text-align: center; margin-top: 25px;">
                    <button class="btn btn-success" onclick="creaContratto()" style="padding: 15px 30px; font-size: 1.1rem;">üìã Crea Contratto</button>
                </div>
            </div>

            <!-- PULSANTE CREA CONTRATTO E RICERCA -->
            <div style="margin-bottom: 25px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; justify-content: space-between;">
                <button class="btn btn-success" onclick="mostraFormContratto()" style="padding: 12px 25px; font-size: 1rem;">üìã Crea Contratto</button>
                
                <div style="flex: 1; max-width: 400px;">
                    <input type="text" id="searchContratti" placeholder="üîç Cerca contratti per cliente, auto, data..." style="width: 100%; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;" onkeyup="filtraContratti()">
                </div>
            </div>

            <!-- TABELLA CONTRATTI -->
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Cliente</th>
                        <th>Auto</th>
                        <th>Prezzo</th>
                        <th>Permuta</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="tabellaContratti"></tbody>
            </table>
        </div>

        <!-- TAB STATISTICHE -->
        <div id="statistiche" class="tab-content">
            <h2>Statistiche e Conto Economico</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totaleAuto">0</h3>
                    <p>Auto in Stock</p>
                </div>
                <div class="stat-card">
                    <h3 id="totaleContratti">0</h3>
                    <p>Contratti Firmati</p>
                </div>
                <div class="stat-card">
                    <h3 id="fatturatoTotale">‚Ç¨0</h3>
                    <p>Fatturato Totale</p>
                </div>
                <div class="stat-card">
                    <h3 id="valoreStock">‚Ç¨0</h3>
                    <p>Valore Stock Presente</p>
                </div>
                <div class="stat-card">
                    <h3 id="margineComplessivo">‚Ç¨0</h3>
                    <p>Margine Complessivo</p>
                </div>
            </div>

            <div class="contract-preview">
                <h3>üìä Statistiche Canali di Vendita</h3>
                <div id="statisticheCanali" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;"></div>
            </div>

            <div class="contract-preview">
                <h3>üìà Andamento Vendite Mensili</h3>
                <div id="graficoVendite" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- MODAL MODIFICA GENERALE -->
    <div id="modalModifica" class="modal">
        <div class="modal-content">
            <span class="close" onclick="chiudiModal()">&times;</span>
            <h2 id="titoloModifica">Modifica</h2>
            <div id="contenutoModifica"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-success" onclick="salvaModifica()">üíæ Salva</button>
                <button class="btn btn-danger" onclick="chiudiModal()">‚ùå Annulla</button>
            </div>
        </div>
    </div>

    <!-- MODAL CONTRATTO -->
    <div id="modalContratto" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="chiudiModalContratto()">&times;</span>
            <div id="contrattoCompleto"></div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="stampaContratto()">üñ®Ô∏è Stampa Contratto</button>
                <button class="btn btn-danger" onclick="chiudiModalContratto()">‚ùå Chiudi</button>
            </div>
        </div>
    </div>

    <!-- MODAL GESTIONE SPESE -->
    <div id="modalSpese" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="chiudiModalSpese()">&times;</span>
            <h2 id="titoloSpese">Gestione Spese Auto</h2>
            
            <div id="infoAuto" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
            
            <h3>Aggiungi Nuova Spesa</h3>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <div class="form-group">
                    <label>Data Spesa</label>
                    <input type="date" id="dataSpesa">
                </div>
                <div class="form-group">
                    <label>Importo (‚Ç¨)</label>
                    <input type="number" id="importoSpesa" placeholder="150" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="categoriaSpesa">
                        <option value="Riparazione">Riparazione</option>
                        <option value="Manutenzione">Manutenzione</option>
                        <option value="Pneumatici">Pneumatici</option>
                        <option value="Carrozzeria">Carrozzeria</option>
                        <option value="Revisione">Revisione</option>
                        <option value="Bollo">Bollo</option>
                        <option value="Assicurazione">Assicurazione</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Descrizione</label>
                <textarea id="descrizioneSpesa" placeholder="Descrizione dettagliata della spesa..." style="min-height: 60px;"></textarea>
            </div>
            
            <button class="btn btn-success" onclick="aggiungiSpesa()">‚ûï Aggiungi Spesa</button>
            
            <h3 style="margin-top: 30px;">Spese Registrate</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Categoria</th>
                        <th>Importo</th>
                        <th>Descrizione</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="tabellaSpese"></tbody>
            </table>
            
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-danger" onclick="chiudiModalSpese()">‚ùå Chiudi</button>
            </div>
        </div>
    </div>

    <!-- MODAL DETTAGLIO MARGINE -->
    <div id="modalDettaglioMargine" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="chiudiModalDettaglioMargine()">&times;</span>
            <h2 id="titoloDettaglioMargine">üìä Dettaglio Calcolo Margine</h2>
            
            <div id="infoAutoMargine" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
            
            <div style="background: white; border: 2px solid #1e40af; border-radius: 10px; padding: 20px;">
                <h3 style="text-align: center; margin-bottom: 15px; color: #1e40af;">CALCOLO MARGINE DETTAGLIATO</h3>
                
                <table class="data-table" style="margin-bottom: 0;">
                    <tbody id="tabellaDettaglioMargine"></tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-danger" onclick="chiudiModalDettaglioMargine()">‚ùå Chiudi</button>
            </div>
        </div>
    </div>

    <script>
        // ‚úÖ CREDENZIALI SUPABASE CONFIGURATE
        const SUPABASE_URL = 'https://fcfeylrovatqvskbfyem.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjZmV5bHJvdmF0cXZza2JmeWVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NzY4MzQsImV4cCI6MjA3MDM1MjgzNH0.ZoxNn-GBy2D84fOUdgmjgP9A_6PKf1cHAFR8uQTavx8';
        
        // Inizializza Supabase
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Dati globali
        let clienti = [];
        let auto = [];
        let contratti = [];
        let oggettoInModifica = null;
        let tipoOggettoInModifica = '';
        let autoCorrente = null;
        let extraItems = [];
        let costiAutoItems = [];
        let isConnected = false;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', async function() {
            await inizializzaApp();
        });

        async function inizializzaApp() {
            try {
                // Testa la connessione
                const { data, error } = await supabaseClient.from('clienti').select('count').limit(1);
                
                if (error) {
                    throw error;
                }
                
                isConnected = true;
                document.getElementById('connectionStatus').className = 'connection-status status-connected';
                document.getElementById('connectionStatus').innerHTML = '‚úÖ Database connesso e sincronizzato';
                
                // Carica i dati
                await caricaDatiSupabase();
                
            } catch (error) {
                console.error('Errore connessione Supabase:', error);
                isConnected = false;
                document.getElementById('connectionStatus').className = 'connection-status status-offline';
                document.getElementById('connectionStatus').innerHTML = '‚ùå Modalit√† offline - I dati sono salvati localmente';
                
                // Fallback a localStorage
                caricaDatiLocali();
            }
            
            // Aggiorna interfaccia
            aggiornaTabelle();
            aggiornaStatistiche();
            aggiornaSelectClienti();
            aggiornaSelectAuto();
            aggiornaListaExtra();
            aggiornaListaCostiAuto();
            
            // Imposta data odierna
            const oggi = new Date().toISOString().split('T')[0];
            document.getElementById('dataContratto').value = oggi;
            
            // Event listener per aggiornare i prezzi quando si seleziona un'auto
            const autoSelect = document.getElementById('autoContratto');
            if (autoSelect) {
                autoSelect.addEventListener('change', function() {
                    const autoId = this.value;
                    if (autoId) {
                        const autoSelezionata = auto.find(a => a.id == autoId);
                        if (autoSelezionata) {
                            document.getElementById('prezzoBaseAuto').value = autoSelezionata.prezzo_vendita;
                            document.getElementById('prezzoFinaleAuto').value = autoSelezionata.prezzo_vendita;
                            document.getElementById('scontoApplicato').value = 0;
                        }
                    } else {
                        document.getElementById('prezzoBaseAuto').value = '';
                        document.getElementById('prezzoFinaleAuto').value = '';
                        document.getElementById('scontoApplicato').value = '';
                    }
                });
            }
        }

        // FUNZIONI SALVATAGGIO SUPABASE
        async function caricaDatiSupabase() {
            try {
                // Carica clienti
                const { data: clientiData, error: clientiError } = await supabaseClient
                    .from('clienti')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (clientiError) throw clientiError;
                clienti = clientiData || [];
                
                // Carica auto
                const { data: autoData, error: autoError } = await supabaseClient
                    .from('auto')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (autoError) throw autoError;
                auto = autoData || [];
                
                // Carica contratti
                const { data: contrattiData, error: contrattiError } = await supabaseClient
                    .from('contratti')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (contrattiError) throw contrattiError;
                contratti = contrattiData || [];
                
                console.log('‚úÖ Dati caricati da Supabase:', {
                    clienti: clienti.length,
                    auto: auto.length,
                    contratti: contratti.length
                });
                
            } catch (error) {
                console.error('‚ùå Errore caricamento da Supabase:', error);
                throw error;
            }
        }

        async function salvaDatiSupabase() {
            if (!isConnected) {
                console.log('üì± Modalit√† offline - salvataggio su localStorage');
                salvaDatiLocali();
                return;
            }
            
            try {
                // Nota: In un'implementazione reale, dovresti salvare solo i record modificati
                // Qui per semplicit√† salviamo tutto con upsert
                
                console.log('üíæ Sincronizzazione con Supabase...');
                
                // Salva clienti
                if (clienti.length > 0) {
                    const { error: clientiError } = await supabaseClient
                        .from('clienti')
                        .upsert(clienti, { onConflict: 'id' });
                    
                    if (clientiError) throw clientiError;
                }
                
                // Salva auto
                if (auto.length > 0) {
                    const { error: autoError } = await supabaseClient
                        .from('auto')
                        .upsert(auto, { onConflict: 'id' });
                    
                    if (autoError) throw autoError;
                }
                
                // Salva contratti
                if (contratti.length > 0) {
                    const { error: contrattiError } = await supabaseClient
                        .from('contratti')
                        .upsert(contratti, { onConflict: 'id' });
                    
                    if (contrattiError) throw contrattiError;
                }
                
                console.log('‚úÖ Dati sincronizzati con Supabase');
                
            } catch (error) {
                console.error('‚ùå Errore sincronizzazione Supabase:', error);
                // Fallback a localStorage
                salvaDatiLocali();
                
                // Mostra notifica errore
                mostrarNotifica('Errore sincronizzazione - Dati salvati localmente', 'warning');
            }
        }

        // FUNZIONI SALVATAGGIO LOCALE (fallback)
        function salvaDatiLocali() {
            localStorage.setItem('pericar_clienti', JSON.stringify(clienti));
            localStorage.setItem('pericar_auto', JSON.stringify(auto));
            localStorage.setItem('pericar_contratti', JSON.stringify(contratti));
            console.log('üíæ Dati salvati in localStorage');
        }

        function caricaDatiLocali() {
            const clientiSalvati = localStorage.getItem('pericar_clienti');
            const autoSalvate = localStorage.getItem('pericar_auto');
            const contrattiSalvati = localStorage.getItem('pericar_contratti');
            
            clienti = clientiSalvati ? JSON.parse(clientiSalvati) : [];
            auto = autoSalvate ? JSON.parse(autoSalvate) : [];
            contratti = contrattiSalvati ? JSON.parse(contrattiSalvati) : [];
            
            console.log('üì± Dati caricati da localStorage:', {
                clienti: clienti.length,
                auto: auto.length,
                contratti: contratti.length
            });
        }

        // FUNZIONE NOTIFICHE
        function mostrarNotifica(messaggio, tipo = 'success') {
            const notifica = document.createElement('div');
            notifica.className = `alert alert-${tipo}`;
            notifica.style.position = 'fixed';
            notifica.style.top = '20px';
            notifica.style.right = '20px';
            notifica.style.zIndex = '9999';
            notifica.style.minWidth = '300px';
            notifica.textContent = messaggio;
            
            document.body.appendChild(notifica);
            
            setTimeout(() => {
                notifica.remove();
            }, 3000);
        }

        // Gestione tab
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // GESTIONE CLIENTI
        async function aggiungiCliente() {
            const nome = document.getElementById('nomeCliente').value.trim();
            const dataNascita = document.getElementById('dataNascita').value;
            const luogoNascita = document.getElementById('luogoNascita').value.trim();
            const residenza = document.getElementById('residenza').value.trim();
            const codiceFiscale = document.getElementById('codiceFiscale').value.trim().toUpperCase();
            const professione = document.getElementById('professione').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const email = document.getElementById('emailCliente').value.trim();

            if (!nome || !telefono) {
                mostrarNotifica('Nome e telefono sono obbligatori!', 'danger');
                return;
            }

            // Verifica duplicati
            const clienteEsistente = clienti.find(c => 
                c.telefono === telefono || 
                (codiceFiscale && c.codice_fiscale === codiceFiscale)
            );
            
            if (clienteEsistente) {
                mostrarNotifica('Cliente gi√† esistente con questo telefono o codice fiscale!', 'danger');
                return;
            }

            const cliente = {
                id: Date.now(),
                nome,
                data_nascita: dataNascita || null,
                luogo_nascita: luogoNascita || null,
                residenza: residenza || null,
                codice_fiscale: codiceFiscale || null,
                professione: professione || null,
                telefono,
                email: email || null,
                created_at: new Date().toISOString()
            };

            clienti.push(cliente);
            await salvaDatiSupabase();
            aggiornaTabelle();
            aggiornaStatistiche();
            aggiornaSelectClienti();
            pulisciFormCliente();
            chiudiFormCliente();
            
            mostrarNotifica('‚úÖ Cliente aggiunto con successo!', 'success');
        }

        function pulisciFormCliente() {
            document.getElementById('nomeCliente').value = '';
            document.getElementById('dataNascita').value = '';
            document.getElementById('luogoNascita').value = '';
            document.getElementById('residenza').value = '';
            document.getElementById('codiceFiscale').value = '';
            document.getElementById('professione').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('emailCliente').value = '';
        }

        // GESTIONE FORM CLIENTI
        function mostraFormCliente() {
            document.getElementById('formAggiungiCliente').style.display = 'block';
            document.getElementById('formAggiungiCliente').scrollIntoView({ behavior: 'smooth' });
        }

        function chiudiFormCliente() {
            document.getElementById('formAggiungiCliente').style.display = 'none';
            pulisciFormCliente();
        }

        // GESTIONE FORM CONTRATTI
        function mostraFormContratto() {
            if (clienti.length === 0) {
                mostrarNotifica('Aggiungi almeno un cliente prima di creare un contratto!', 'warning');
                return;
            }
            
            const autoDisponibili = auto.filter(a => a.stato === 'Disponibile');
            if (autoDisponibili.length === 0) {
                mostrarNotifica('Nessuna auto disponibile per la vendita!', 'warning');
                return;
            }
            
            document.getElementById('formAggiungiContratto').style.display = 'block';
            document.getElementById('formAggiungiContratto').scrollIntoView({ behavior: 'smooth' });
        }

        function chiudiFormContratto() {
            document.getElementById('formAggiungiContratto').style.display = 'none';
            pulisciFormContratto();
        }

        // GESTIONE FORM AUTO
        function mostraFormAuto() {
            document.getElementById('formAggiungiAuto').style.display = 'block';
            document.getElementById('formAggiungiAuto').scrollIntoView({ behavior: 'smooth' });
        }

        function chiudiFormAuto() {
            document.getElementById('formAggiungiAuto').style.display = 'none';
            pulisciFormAuto();
        }

        // GESTIONE AUTO
        async function aggiungiAuto() {
            const marca = document.getElementById('marca').value.trim();
            const modello = document.getElementById('modello').value.trim();
            const versione = document.getElementById('versione').value.trim();
            const targa = document.getElementById('targa').value.trim().toUpperCase();
            const telaio = document.getElementById('telaio').value.trim().toUpperCase();
            const dataImmatricolazione = document.getElementById('dataImmatricolazione').value;
            const chilometri = parseInt(document.getElementById('chilometri').value) || 0;
            const prezzoAcquisto = parseFloat(document.getElementById('prezzoAcquisto').value) || 0;
            const prezzoVendita = parseFloat(document.getElementById('prezzoVendita').value) || 0;
            const tipo = document.getElementById('tipoAuto').value;
            const stato = document.getElementById('statoAuto').value;

            if (!marca || !modello || !targa) {
                mostrarNotifica('Marca, modello e targa sono obbligatori!', 'danger');
                return;
            }

            // Verifica duplicati
            const autoEsistente = auto.find(a => a.targa === targa);
            if (autoEsistente) {
                mostrarNotifica('Auto gi√† esistente con questa targa!', 'danger');
                return;
            }

            // Converti i costi iniziali in spese
            const speseIniziali = costiAutoItems.map(costo => ({
                id: Date.now() + Math.random(),
                data: dataImmatricolazione || new Date().toISOString().split('T')[0],
                importo: costo.importo,
                categoria: 'Costo Iniziale',
                descrizione: costo.descrizione,
                isInitialCost: true
            }));

            const autoObj = {
                id: Date.now(),
                marca,
                modello,
                versione: versione || null,
                targa,
                telaio: telaio || null,
                data_immatricolazione: dataImmatricolazione || null,
                chilometri,
                prezzo_acquisto: prezzoAcquisto,
                prezzo_vendita: prezzoVendita,
                tipo,
                stato,
                spese_aggiuntive: speseIniziali,
                is_permuta: false,
                created_at: new Date().toISOString()
            };

            auto.push(autoObj);
            await salvaDatiSupabase();
            aggiornaTabelle();
            aggiornaStatistiche();
            aggiornaSelectAuto();
            pulisciFormAuto();
            chiudiFormAuto();
            
            mostrarNotifica('‚úÖ Auto aggiunta con successo!', 'success');
        }

        function pulisciFormAuto() {
            document.getElementById('marca').value = '';
            document.getElementById('modello').value = '';
            document.getElementById('versione').value = '';
            document.getElementById('targa').value = '';
            document.getElementById('telaio').value = '';
            document.getElementById('dataImmatricolazione').value = '';
            document.getElementById('chilometri').value = '';
            document.getElementById('prezzoAcquisto').value = '';
            document.getElementById('prezzoVendita').value = '';
            document.getElementById('descrizioneCostoAuto').value = '';
            document.getElementById('importoCostoAuto').value = '';
            document.getElementById('tipoAuto').value = 'USATO';
            document.getElementById('statoAuto').value = 'Disponibile';
            costiAutoItems = [];
            aggiornaListaCostiAuto();
        }

        // GESTIONE CONTRATTI
        async function creaContratto() {
            const clienteId = document.getElementById('clienteContratto').value;
            const autoId = document.getElementById('autoContratto').value;
            const dataContratto = document.getElementById('dataContratto').value;
            const luogo = document.getElementById('luogoContratto').value.trim();

            if (!clienteId || !autoId || !dataContratto) {
                mostrarNotifica('Cliente, auto e data sono obbligatori!', 'danger');
                return;
            }

            const cliente = clienti.find(c => c.id == clienteId);
            const autoVenduta = auto.find(a => a.id == autoId);

            if (!cliente || !autoVenduta) {
                mostrarNotifica('Errore: Cliente o auto non trovati!', 'danger');
                return;
            }

            // Dati permuta (opzionali)
            const permuta = {
                marca: document.getElementById('marcaPermuta').value.trim(),
                modello: document.getElementById('modelloPermuta').value.trim(),
                targa: document.getElementById('targaPermuta').value.trim().toUpperCase(),
                telaio: document.getElementById('telaioPermuta').value.trim().toUpperCase(),
                data_immatricolazione: document.getElementById('dataImmatricolazionePermuta').value,
                chilometri: parseInt(document.getElementById('chilometriPermuta').value) || 0,
                versione: document.getElementById('versionePermuta').value.trim(),
                valutazione: parseFloat(document.getElementById('valutazionePermuta').value) || 0
            };

            let permutaAutoId = null;

            // Se c'√® una permuta con dati completi, aggiungila automaticamente allo stock
            if (permuta.marca && permuta.modello && permuta.targa && permuta.valutazione > 0) {
                // Verifica che la targa permuta non esista gi√†
                const targaEsistente = auto.find(a => a.targa === permuta.targa);
                if (targaEsistente) {
                    mostrarNotifica('La targa della permuta esiste gi√† nel sistema!', 'danger');
                    return;
                }

                const autoPermuta = {
                    id: Date.now() + 1,
                    marca: permuta.marca,
                    modello: permuta.modello,
                    versione: permuta.versione || null,
                    targa: permuta.targa,
                    telaio: permuta.telaio || null,
                    data_immatricolazione: permuta.data_immatricolazione || null,
                    chilometri: permuta.chilometri,
                    prezzo_acquisto: permuta.valutazione,
                    prezzo_vendita: Math.round(permuta.valutazione * 1.15), // 15% di margine suggerito
                    tipo: 'USATO',
                    stato: 'Disponibile',
                    spese_aggiuntive: [],
                    is_permuta: true,
                    contratto_originale: null,
                    created_at: new Date().toISOString()
                };
                
                auto.push(autoPermuta);
                permutaAutoId = autoPermuta.id;
            }

            const contratto = {
                id: Date.now(),
                cliente_id: parseInt(clienteId),
                auto_id: parseInt(autoId),
                data_contratto: dataContratto,
                luogo: luogo || 'Asti',
                permuta,
                permuta_auto_id: permutaAutoId,
                deposito_cauzionale: parseFloat(document.getElementById('depositoCauzionale').value) || 0,
                spese_voltura: parseFloat(document.getElementById('speseVoltura').value) || 0,
                canale_vendita: document.getElementById('canaleVendita').value,
                sconto_applicato: parseFloat(document.getElementById('scontoApplicato').value) || 0,
                prezzo_finale_auto: parseFloat(document.getElementById('prezzoFinaleAuto').value) || autoVenduta.prezzo_vendita,
                extra_items: [...extraItems],
                cliente,
                auto: autoVenduta,
                created_at: new Date().toISOString()
            };

            // Collega l'auto permuta al contratto
            if (permutaAutoId) {
                const autoPermuta = auto.find(a => a.id == permutaAutoId);
                if (autoPermuta) {
                    autoPermuta.contratto_originale = contratto.id;
                }
            }

            contratti.push(contratto);
            
            // Aggiorna stato auto venduta
            autoVenduta.stato = 'Venduta';
            
            await salvaDatiSupabase();
            aggiornaTabelle();
            aggiornaStatistiche();
            aggiornaSelectAuto();
            pulisciFormContratto();
            chiudiFormContratto();
            
            // Mostra messaggio appropriato
            if (permutaAutoId) {
                mostrarNotifica('‚úÖ Contratto creato! La permuta √® stata aggiunta allo stock.', 'success');
            } else {
                mostrarNotifica('‚úÖ Contratto creato con successo!', 'success');
            }
            
            // Mostra contratto
            setTimeout(() => {
                mostraContratto(contratto);
            }, 500);
        }

        function pulisciFormContratto() {
            document.getElementById('clienteContratto').value = '';
            document.getElementById('autoContratto').value = '';
            document.getElementById('luogoContratto').value = 'Asti';
            document.getElementById('marcaPermuta').value = '';
            document.getElementById('modelloPermuta').value = '';
            document.getElementById('targaPermuta').value = '';
            document.getElementById('telaioPermuta').value = '';
            document.getElementById('dataImmatricolazionePermuta').value = '';
            document.getElementById('chilometriPermuta').value = '';
            document.getElementById('versionePermuta').value = '';
            document.getElementById('valutazionePermuta').value = '';
            document.getElementById('depositoCauzionale').value = '';
            document.getElementById('speseVoltura').value = '';
            document.getElementById('canaleVendita').value = 'Autoscout';
            document.getElementById('scontoApplicato').value = '';
            document.getElementById('prezzoFinaleAuto').value = '';
            document.getElementById('prezzoBaseAuto').value = '';
            document.getElementById('descrizioneExtra').value = '';
            document.getElementById('prezzoExtra').value = '';
            extraItems = [];
            aggiornaListaExtra();
        }

        // GESTIONE COSTI AUTO
        function aggiungiCostoAuto() {
            const descrizione = document.getElementById('descrizioneCostoAuto').value.trim();
            const importo = parseFloat(document.getElementById('importoCostoAuto').value) || 0;
            
            if (!descrizione || importo <= 0) {
                mostrarNotifica('Descrizione e importo sono obbligatori!', 'danger');
                return;
            }
            
            const costo = {
                id: Date.now(),
                descrizione,
                importo
            };
            
            costiAutoItems.push(costo);
            aggiornaListaCostiAuto();
            
            // Pulisci campi
            document.getElementById('descrizioneCostoAuto').value = '';
            document.getElementById('importoCostoAuto').value = '';
        }

        function rimuoviCostoAuto(id) {
            costiAutoItems = costiAutoItems.filter(item => item.id !== id);
            aggiornaListaCostiAuto();
        }

        function aggiornaListaCostiAuto() {
            const container = document.getElementById('listaCostiAuto');
            
            if (costiAutoItems.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic; margin: 0;">Nessun costo aggiuntivo inserito</p>';
                return;
            }
            
            let html = '<div style="border: 1px solid #ddd; border-radius: 6px; overflow: hidden;">';
            html += '<div style="background: #e9ecef; padding: 8px; font-weight: bold; display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px;">';
            html += '<div>Descrizione</div><div style="text-align: right;">Importo</div><div style="width: 60px;"></div>';
            html += '</div>';
            
            costiAutoItems.forEach(item => {
                html += `<div style="padding: 8px; border-top: 1px solid #eee; display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px; align-items: center;">
                    <div>${item.descrizione}</div>
                    <div style="text-align: right; font-weight: bold;">‚Ç¨${item.importo.toLocaleString()}</div>
                    <div><button class="btn btn-danger" onclick="rimuoviCostoAuto(${item.id})" style="padding: 4px 8px; font-size: 0.8rem;">üóëÔ∏è</button></div>
                </div>`;
            });
            
            const totale = costiAutoItems.reduce((sum, item) => sum + item.importo, 0);
            html += `<div style="padding: 8px; border-top: 2px solid #ddd; background: #f8f9fa; display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px; font-weight: bold;">
                <div>TOTALE COSTI</div>
                <div style="text-align: right; color: #dc3545;">‚Ç¨${totale.toLocaleString()}</div>
                <div></div>
            </div>`;
            
            html += '</div>';
            container.innerHTML = html;
        }

        // GESTIONE SERVIZI/ACCESSORI AGGIUNTIVI
        function aggiungiExtra() {
            const descrizione = document.getElementById('descrizioneExtra').value.trim();
            const prezzo = parseFloat(document.getElementById('prezzoExtra').value) || 0;
            
            if (!descrizione || prezzo <= 0) {
                mostrarNotifica('Descrizione e prezzo sono obbligatori!', 'danger');
                return;
            }
            
            const extra = {
                id: Date.now(),
                descrizione,
                prezzo
            };
            
            extraItems.push(extra);
            aggiornaListaExtra();
            
            // Pulisci campi
            document.getElementById('descrizioneExtra').value = '';
            document.getElementById('prezzoExtra').value = '';
        }

        function rimuoviExtra(id) {
            extraItems = extraItems.filter(item => item.id !== id);
            aggiornaListaExtra();
        }

        function aggiornaListaExtra() {
            const container = document.getElementById('listaExtra');
            
            if (extraItems.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic; margin: 0;">Nessun servizio/accessorio aggiunto</p>';
                return;
            }
            
            let html = '<div style="border: 1px solid #ddd; border-radius: 6px; overflow: hidden;">';
            html += '<div style="background: #e9ecef; padding: 8px; font-weight: bold; display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px;">';
            html += '<div>Descrizione</div><div style="text-align: right;">Prezzo</div><div style="width: 60px;"></div>';
            html += '</div>';
            
            extraItems.forEach(item => {
                html += `<div style="padding: 8px; border-top: 1px solid #eee; display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px; align-items: center;">
                    <div>${item.descrizione}</div>
                    <div style="text-align: right; font-weight: bold;">‚Ç¨${item.prezzo.toLocaleString()}</div>
                    <div><button class="btn btn-danger" onclick="rimuoviExtra(${item.id})" style="padding: 4px 8px; font-size: 0.8rem;">üóëÔ∏è</button></div>
                </div>`;
            });
            
            const totale = extraItems.reduce((sum, item) => sum + item.prezzo, 0);
            html += `<div style="padding: 8px; border-top: 2px solid #ddd; background: #f8f9fa; display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px; font-weight: bold;">
                <div>TOTALE EXTRA</div>
                <div style="text-align: right; color: #1e40af;">‚Ç¨${totale.toLocaleString()}</div>
                <div></div>
            </div>`;
            
            html += '</div>';
            container.innerHTML = html;
        }

        // MODIFICA GENERALE
        function modificaOggetto(tipo, id) {
            let oggetto;
            let campi = [];
            
            if (tipo === 'cliente') {
                oggetto = clienti.find(c => c.id == id);
                campi = [
                    {nome: 'nome', label: 'Nome e Cognome', tipo: 'text'},
                    {nome: 'data_nascita', label: 'Data di Nascita', tipo: 'date'},
                    {nome: 'luogo_nascita', label: 'Luogo di Nascita', tipo: 'text'},
                    {nome: 'residenza', label: 'Residenza', tipo: 'text'},
                    {nome: 'codice_fiscale', label: 'Codice Fiscale', tipo: 'text'},
                    {nome: 'professione', label: 'Professione', tipo: 'text'},
                    {nome: 'telefono', label: 'Telefono', tipo: 'text'},
                    {nome: 'email', label: 'Email', tipo: 'email'}
                ];
            } else if (tipo === 'auto') {
                oggetto = auto.find(a => a.id == id);
                campi = [
                    {nome: 'marca', label: 'Marca', tipo: 'text'},
                    {nome: 'modello', label: 'Modello', tipo: 'text'},
                    {nome: 'versione', label: 'Versione', tipo: 'text'},
                    {nome: 'targa', label: 'Targa', tipo: 'text'},
                    {nome: 'telaio', label: 'Telaio', tipo: 'text'},
                    {nome: 'data_immatricolazione', label: 'Data Immatricolazione', tipo: 'date'},
                    {nome: 'chilometri', label: 'Chilometri', tipo: 'number'},
                    {nome: 'prezzo_acquisto', label: 'Prezzo Acquisto (‚Ç¨)', tipo: 'number'},
                    {nome: 'prezzo_vendita', label: 'Prezzo Vendita (‚Ç¨)', tipo: 'number'},
                    {nome: 'tipo', label: 'Tipo', tipo: 'select', opzioni: ['NUOVO', 'KM0', 'USATO']},
                    {nome: 'stato', label: 'Stato', tipo: 'select', opzioni: ['Disponibile', 'Venduta', 'In Trattativa']}
                ];
            }
            
            if (!oggetto) {
                mostrarNotifica('Oggetto non trovato!', 'danger');
                return;
            }
            
            oggettoInModifica = oggetto;
            tipoOggettoInModifica = tipo;
            
            document.getElementById('titoloModifica').textContent = `Modifica ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`;
            
            let html = '<div class="form-grid">';
            campi.forEach(campo => {
                html += `<div class="form-group">
                    <label>${campo.label}</label>`;
                
                if (campo.tipo === 'select') {
                    html += `<select id="modifica_${campo.nome}">`;
                    campo.opzioni.forEach(opzione => {
                        const selected = oggetto[campo.nome] === opzione ? 'selected' : '';
                        html += `<option value="${opzione}" ${selected}>${opzione}</option>`;
                    });
                    html += `</select>`;
                } else {
                    const value = oggetto[campo.nome] || '';
                    html += `<input type="${campo.tipo}" id="modifica_${campo.nome}" value="${value}">`;
                }
                
                html += `</div>`;
            });
            html += '</div>';
            
            document.getElementById('contenutoModifica').innerHTML = html;
            document.getElementById('modalModifica').style.display = 'block';
        }

        async function salvaModifica() {
            if (!oggettoInModifica) return;
            
            // Aggiorna tutti i campi dell'oggetto
            const inputs = document.getElementById('contenutoModifica').querySelectorAll('input, select');
            inputs.forEach(input => {
                const campo = input.id.replace('modifica_', '');
                if (input.type === 'number') {
                    oggettoInModifica[campo] = parseFloat(input.value) || 0;
                } else {
                    oggettoInModifica[campo] = input.value || null;
                }
            });
            
            await salvaDatiSupabase();
            aggiornaTabelle();
            aggiornaStatistiche();
            
            if (tipoOggettoInModifica === 'cliente') {
                aggiornaSelectClienti();
            } else if (tipoOggettoInModifica === 'auto') {
                aggiornaSelectAuto();
            }
            
            chiudiModal();
            mostrarNotifica('‚úÖ Modifiche salvate con successo!', 'success');
        }

        function chiudiModal() {
            document.getElementById('modalModifica').style.display = 'none';
            oggettoInModifica = null;
            tipoOggettoInModifica = '';
        }

        // ELIMINAZIONE
        async function eliminaCliente(id) {
            if (!confirm('Sei sicuro di voler eliminare questo cliente?')) return;
            
            // Verifica se il cliente ha contratti
            const contrattiCliente = contratti.filter(c => c.cliente_id == id);
            if (contrattiCliente.length > 0) {
                mostrarNotifica('Impossibile eliminare: il cliente ha contratti associati!', 'danger');
                return;
            }
            
            clienti = clienti.filter(c => c.id != id);
            
            if (isConnected) {
                try {
                    await supabaseClient.from('clienti').delete().eq('id', id);
                } catch (error) {
                    console.error('Errore eliminazione cliente da Supabase:', error);
                }
            }
            
            await salvaDatiSupabase();
            aggiornaTabelle();
            aggiornaStatistiche();
            aggiornaSelectClienti();
            mostrarNotifica('‚úÖ Cliente eliminato con successo!', 'success');
        }

        async function eliminaAuto(id) {
            if (!confirm('Sei sicuro di voler eliminare questa auto?')) return;
            
            // Verifica se l'auto ha contratti
            const contrattiAuto = contratti.filter(c => c.auto_id == id);
            if (contrattiAuto.length > 0) {
                mostrarNotifica('Impossibile eliminare: l\'auto ha contratti associati!', 'danger');
                return;
            }
            
            auto = auto.filter(a => a.id != id);
            
            if (isConnected) {
                try {
                    await supabaseClient.from('auto').delete().eq('id', id);
                } catch (error) {
                    console.error('Errore eliminazione auto da Supabase:', error);
                }
            }
            
            await salvaDatiSupabase();
            aggiornaTabelle();
            aggiornaStatistiche();
            aggiornaSelectAuto();
            mostrarNotifica('‚úÖ Auto eliminata con successo!', 'success');
        }

        async function eliminaContratto(id) {
            if (!confirm('Sei sicuro di voler eliminare questo contratto?')) return;
            
            const contratto = contratti.find(c => c.id == id);
            if (contratto) {
                // Rimetti l'auto venduta come disponibile
                const autoContratto = auto.find(a => a.id == contratto.auto_id);
                if (autoContratto) {
                    autoContratto.stato = 'Disponibile';
                }
                
                // Rimuovi l'auto permuta dallo stock se esiste
                if (contratto.permuta_auto_id) {
                    auto = auto.filter(a => a.id != contratto.permuta_auto_id);
                    console.log('Permuta rimossa dallo stock automaticamente');
                }
            }
            
            contratti = contratti.filter(c => c.id != id);
            
            if (isConnected) {
                try {
                    await supabaseClient.from('contratti').delete().eq('id', id);
                } catch (error) {
                    console.error('Errore eliminazione contratto da Supabase:', error);
                }
            }
            
            await salvaDatiSupabase();
            aggiornaTabelle();
            aggiornaStatistiche();
            aggiornaSelectAuto();
            mostrarNotifica('‚úÖ Contratto eliminato con successo!', 'success');
        }

        // FUNZIONI DI RICERCA
        function filtraClienti() {
            const searchTerm = document.getElementById('searchClienti').value.toLowerCase();
            const rows = document.querySelectorAll('#tabellaClienti tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function filtraAuto() {
            const searchTerm = document.getElementById('searchAuto').value.toLowerCase();
            const rows = document.querySelectorAll('#tabellaAuto tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function filtraPerStato() {
            aggiornaTabellaAuto();
        }

        function filtraContratti() {
            const searchTerm = document.getElementById('searchContratti').value.toLowerCase();
            const rows = document.querySelectorAll('#tabellaContratti tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // AGGIORNAMENTO TABELLE
        function aggiornaTabelle() {
            aggiornaTabelliaClienti();
            aggiornaTabellaAuto();
            aggiornaTabellaContratti();
        }

        function aggiornaTabelliaClienti() {
            const tbody = document.getElementById('tabellaClienti');
            tbody.innerHTML = '';
            
            clienti.forEach(cliente => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${cliente.nome}</td>
                    <td>${cliente.telefono}</td>
                    <td>${cliente.email || '-'}</td>
                    <td>${cliente.codice_fiscale || '-'}</td>
                    <td class="actions">
                        <button class="btn btn-warning" onclick="modificaOggetto('cliente', ${cliente.id})">‚úèÔ∏è Modifica</button>
                        <button class="btn btn-danger" onclick="eliminaCliente(${cliente.id})">üóëÔ∏è Elimina</button>
                    </td>
                `;
            });
        }

        function aggiornaTabellaAuto() {
            const tbody = document.getElementById('tabellaAuto');
            tbody.innerHTML = '';
            
            // Determina quali auto mostrare in base al filtro
            const filtroStato = document.getElementById('filtroStato').value;
            let autoFiltrate;
            
            if (filtroStato === 'stock') {
                autoFiltrate = auto.filter(autoObj => autoObj.stato !== 'Venduta');
            } else if (filtroStato === 'vendute') {
                autoFiltrate = auto.filter(autoObj => autoObj.stato === 'Venduta');
            } else {
                autoFiltrate = auto;
            }
            
            autoFiltrate.forEach(autoObj => {
                const speseAggiuntiveTotali = (autoObj.spese_aggiuntive || []).reduce((sum, spesa) => sum + spesa.importo, 0);
                const costoTotale = autoObj.prezzo_acquisto + speseAggiuntiveTotali;
                const margine = autoObj.prezzo_vendita - costoTotale;
                const row = tbody.insertRow();
                
                const statoColor = autoObj.stato === 'Disponibile' ? '#28a745' : 
                                 autoObj.stato === 'Venduta' ? '#dc3545' : '#ffc107';
                
                // Gestione data immatricolazione sicura
                let dataImmatricolazioneFormatted = '-';
                if (autoObj.data_immatricolazione) {
                    try {
                        const data = new Date(autoObj.data_immatricolazione);
                        if (!isNaN(data.getTime())) {
                            dataImmatricolazioneFormatted = data.toLocaleDateString('it-IT');
                        }
                    } catch (error) {
                        console.warn('Errore formattazione data immatricolazione:', autoObj.data_immatricolazione);
                    }
                }
                
                row.innerHTML = `
                    <td>
                        ${autoObj.marca} ${autoObj.modello}
                        ${autoObj.is_permuta ? ' <span style="background: #17a2b8; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem;">üîÑ PERMUTA</span>' : ''}
                    </td>
                    <td>${autoObj.targa}</td>
                    <td>${dataImmatricolazioneFormatted}</td>
                    <td>${autoObj.chilometri.toLocaleString()}</td>
                    <td><span style="background: ${autoObj.tipo === 'NUOVO' ? '#28a745' : autoObj.tipo === 'KM0' ? '#ffc107' : '#6c757d'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">${autoObj.tipo}</span></td>
                    <td><span style="background: ${statoColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">${autoObj.stato}</span></td>
                    <td>‚Ç¨${autoObj.prezzo_vendita.toLocaleString()}</td>
                    <td style="color: ${margine >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">
                        ‚Ç¨${margine.toLocaleString()}
                        <button class="btn btn-primary" onclick="mostraDettaglioMargine(${autoObj.id})" style="padding: 2px 6px; font-size: 0.7rem; margin-left: 8px;">üìä</button>
                    </td>
                    <td class="actions">
                        <button class="btn btn-warning" onclick="modificaOggetto('auto', ${autoObj.id})">‚úèÔ∏è Modifica</button>
                        ${autoObj.stato !== 'Venduta' ? `<button class="btn btn-primary" onclick="gestisciSpese(${autoObj.id})">üìã Spese</button>` : ''}
                        <button class="btn btn-danger" onclick="eliminaAuto(${autoObj.id})">üóëÔ∏è Elimina</button>
                    </td>
                `;
            });
        }

        function aggiornaTabellaContratti() {
            const tbody = document.getElementById('tabellaContratti');
            tbody.innerHTML = '';
            
            contratti.forEach(contratto => {
                const row = tbody.insertRow();
                const permutaText = contratto.permuta.marca ? `${contratto.permuta.marca} ${contratto.permuta.modello} (‚Ç¨${contratto.permuta.valutazione.toLocaleString()})` : 'Nessuna';
                const totaleExtra = (contratto.extra_items || []).reduce((sum, item) => sum + item.prezzo, 0);
                const prezzoBaseAuto = contratto.prezzo_finale_auto || contratto.auto.prezzo_vendita;
                const prezzoTotale = prezzoBaseAuto + totaleExtra;
                
                row.innerHTML = `
                    <td>${new Date(contratto.data_contratto).toLocaleDateString('it-IT')}</td>
                    <td>${contratto.cliente.nome}</td>
                    <td>${contratto.auto.marca} ${contratto.auto.modello}</td>
                    <td>
                        ‚Ç¨${prezzoTotale.toLocaleString()}
                        ${(contratto.sconto_applicato || 0) > 0 ? `<br><small style="color: #dc3545;">(-‚Ç¨${contratto.sconto_applicato.toLocaleString()} sconto)</small>` : ''}
                        ${totaleExtra > 0 ? `<br><small style="color: #666;">(+‚Ç¨${totaleExtra.toLocaleString()} extra)</small>` : ''}
                    </td>
                    <td>${permutaText}</td>
                    <td class="actions">
                        <button class="btn btn-primary" onclick="mostraContratto(${JSON.stringify(contratto).replace(/"/g, '&quot;')})">üìã Visualizza</button>
                        <button class="btn btn-danger" onclick="eliminaContratto(${contratto.id})">üóëÔ∏è Elimina</button>
                    </td>
                `;
            });
        }

        // AGGIORNAMENTO SELECT
        function aggiornaSelectClienti() {
            const select = document.getElementById('clienteContratto');
            select.innerHTML = '<option value="">Seleziona Cliente</option>';
            
            clienti.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id;
                option.textContent = cliente.nome;
                select.appendChild(option);
            });
        }

        function aggiornaSelectAuto() {
            const select = document.getElementById('autoContratto');
            select.innerHTML = '<option value="">Seleziona Auto</option>';
            
            auto.filter(a => a.stato === 'Disponibile').forEach(autoObj => {
                const option = document.createElement('option');
                option.value = autoObj.id;
                option.textContent = `${autoObj.marca} ${autoObj.modello} (${autoObj.targa}) - ‚Ç¨${autoObj.prezzo_vendita.toLocaleString()}`;
                select.appendChild(option);
            });
        }

        // FUNZIONI CALCOLO SCONTO
        function calcolaPrezzoFinale() {
            const prezzoBase = parseFloat(document.getElementById('prezzoBaseAuto').value) || 0;
            const sconto = parseFloat(document.getElementById('scontoApplicato').value) || 0;
            const prezzoFinale = prezzoBase - sconto;
            
            document.getElementById('prezzoFinaleAuto').value = prezzoFinale > 0 ? prezzoFinale : 0;
        }

        function calcolaSconto() {
            const prezzoBase = parseFloat(document.getElementById('prezzoBaseAuto').value) || 0;
            const prezzoFinale = parseFloat(document.getElementById('prezzoFinaleAuto').value) || 0;
            const sconto = prezzoBase - prezzoFinale;
            
            document.getElementById('scontoApplicato').value = sconto > 0 ? sconto : 0;
        }

        // STATISTICHE
        function aggiornaStatistiche() {
            const autoInStock = auto.filter(a => a.stato !== 'Venduta').length;
            document.getElementById('totaleAuto').textContent = autoInStock;
            document.getElementById('totaleContratti').textContent = contratti.length;
            
            // Calcola fatturato totale
            const fatturatoContratti = contratti.reduce((sum, contratto) => {
                const totaleExtra = (contratto.extra_items || []).reduce((sum, item) => sum + item.prezzo, 0);
                const prezzoFinale = contratto.prezzo_finale_auto || contratto.auto.prezzo_vendita;
                return sum + prezzoFinale + totaleExtra;
            }, 0);
            
            document.getElementById('fatturatoTotale').textContent = `‚Ç¨${fatturatoContratti.toLocaleString()}`;
            
            // Calcola valore stock presente
            const valoreStock = auto.filter(a => a.stato !== 'Venduta').reduce((sum, autoObj) => sum + (autoObj.prezzo_vendita || 0), 0);
            document.getElementById('valoreStock').textContent = `‚Ç¨${valoreStock.toLocaleString()}`;
            
            // Calcola margine complessivo
            const margineComplessivo = contratti.reduce((sum, contratto) => {
                const autoVenduta = contratto.auto;
                const speseAggiuntiveTotali = (autoVenduta.spese_aggiuntive || []).reduce((sum, spesa) => sum + spesa.importo, 0);
                const costoTotale = autoVenduta.prezzo_acquisto + speseAggiuntiveTotali;
                const prezzoFinale = contratto.prezzo_finale_auto || autoVenduta.prezzo_vendita;
                const totaleExtra = (contratto.extra_items || []).reduce((sum, item) => sum + item.prezzo, 0);
                const ricavoTotale = prezzoFinale + totaleExtra;
                return sum + (ricavoTotale - costoTotale);
            }, 0);
            
            document.getElementById('margineComplessivo').textContent = `‚Ç¨${margineComplessivo.toLocaleString()}`;
            
            // Aggiorna statistiche canali
            aggiornaStatisticheCanali();
            aggiornaGraficoVendite();
        }
        
        function aggiornaStatisticheCanali() {
            // Conta vendite per canale
            const canali = {};
            contratti.forEach(contratto => {
                const canale = contratto.canale_vendita || 'Autoscout';
                canali[canale] = (canali[canale] || 0) + 1;
            });
            
            const totaleVendite = contratti.length;
            
            // Mostra statistiche
            const container = document.getElementById('statisticheCanali');
            container.innerHTML = '';
            
            if (totaleVendite === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">Nessun contratto presente</p>';
                return;
            }
            
            Object.entries(canali).forEach(([canale, count]) => {
                const percentuale = ((count / totaleVendite) * 100).toFixed(1);
                const colore = {
                    'Autoscout': '#1e40af',
                    'Subito': '#dc2626',
                    'Conoscenze': '#059669',
                    'Ingresso spontaneo': '#d97706',
                    'Cip': '#7c3aed'
                }[canale] || '#6b7280';
                
                container.innerHTML += `
                    <div style="background: ${colore}; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <h4 style="margin: 0 0 5px 0; font-size: 1.1rem;">${percentuale}%</h4>
                        <p style="margin: 0; font-size: 0.9rem;">${canale}</p>
                        <small style="opacity: 0.8;">${count} vendite</small>
                    </div>
                `;
            });
        }

        function aggiornaGraficoVendite() {
            const container = document.getElementById('graficoVendite');
            
            if (contratti.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">Nessun dato disponibile</p>';
                return;
            }
            
            // Raggruppa contratti per mese
            const venditePerMese = {};
            contratti.forEach(contratto => {
                const data = new Date(contratto.data_contratto);
                const mese = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                venditePerMese[mese] = (venditePerMese[mese] || 0) + 1;
            });
            
            // Crea grafico semplice
            let html = '<div style="display: flex; align-items: end; gap: 10px; height: 200px; padding: 20px; background: white; border-radius: 8px; border: 1px solid #ddd;">';
            
            const maxVendite = Math.max(...Object.values(venditePerMese));
            
            Object.entries(venditePerMese).sort().forEach(([mese, vendite]) => {
                const altezza = (vendite / maxVendite) * 150;
                const [anno, meseNum] = mese.split('-');
                const nomiMesi = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
                const nomeCorto = nomiMesi[parseInt(meseNum) - 1];
                
                html += `
                    <div style="display: flex; flex-direction: column; align-items: center; min-width: 60px;">
                        <div style="background: #1e40af; width: 40px; height: ${altezza}px; border-radius: 4px 4px 0 0; display: flex; align-items: end; justify-content: center; color: white; font-size: 0.8rem; font-weight: bold; padding-bottom: 5px;">
                            ${vendite}
                        </div>
                        <div style="font-size: 0.8rem; margin-top: 5px; text-align: center;">
                            <div>${nomeCorto}</div>
                            <div style="font-size: 0.7rem; color: #666;">${anno}</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // GESTIONE SPESE AUTO
        function gestisciSpese(autoId) {
            autoCorrente = auto.find(a => a.id == autoId);
            if (!autoCorrente) return;
            
            // Inizializza array spese se non esiste
            if (!autoCorrente.spese_aggiuntive) {
                autoCorrente.spese_aggiuntive = [];
            }
            
            const speseAggiuntiveTotali = (autoCorrente.spese_aggiuntive || []).reduce((sum, spesa) => sum + spesa.importo, 0);
            const costoTotale = autoCorrente.prezzo_acquisto + speseAggiuntiveTotali;
            const margine = autoCorrente.prezzo_vendita - costoTotale;
            
            document.getElementById('infoAuto').innerHTML = `
                <h3>${autoCorrente.marca} ${autoCorrente.modello} (${autoCorrente.targa})</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div><strong>Prezzo Acquisto:</strong> ‚Ç¨${autoCorrente.prezzo_acquisto.toLocaleString()}</div>
                    <div><strong>Spese Totali:</strong> ‚Ç¨${speseAggiuntiveTotali.toLocaleString()}</div>
                    <div><strong>Costo Totale:</strong> ‚Ç¨${costoTotale.toLocaleString()}</div>
                    <div><strong>Prezzo Vendita:</strong> ‚Ç¨${autoCorrente.prezzo_vendita.toLocaleString()}</div>
                    <div style="color: ${margine >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold;"><strong>Margine:</strong> ‚Ç¨${margine.toLocaleString()}</div>
                </div>
            `;
            
            // Imposta data odierna
            document.getElementById('dataSpesa').value = new Date().toISOString().split('T')[0];
            
            aggiornaTabellaSpese();
            document.getElementById('modalSpese').style.display = 'block';
        }

        async function aggiungiSpesa() {
            if (!autoCorrente) return;
            
            const data = document.getElementById('dataSpesa').value;
            const importo = parseFloat(document.getElementById('importoSpesa').value);
            const categoria = document.getElementById('categoriaSpesa').value;
            const descrizione = document.getElementById('descrizioneSpesa').value.trim();
            
            if (!data || !importo || importo <= 0) {
                mostrarNotifica('Data e importo sono obbligatori!', 'danger');
                return;
            }
            
            const spesa = {
                id: Date.now(),
                data,
                importo,
                categoria,
                descrizione,
                isInitialCost: false
            };
            
            autoCorrente.spese_aggiuntive.push(spesa);
            await salvaDatiSupabase();
            aggiornaTabellaSpese();
            aggiornaTabelle();
            aggiornaStatistiche();
            
            // Aggiorna info auto nel modal
            gestisciSpese(autoCorrente.id);
            
            // Pulisci form
            document.getElementById('importoSpesa').value = '';
            document.getElementById('descrizioneSpesa').value = '';
            document.getElementById('categoriaSpesa').value = 'Riparazione';
            
            mostrarNotifica('‚úÖ Spesa aggiunta con successo!', 'success');
        }

        function aggiornaTabellaSpese() {
            if (!autoCorrente) return;
            
            const tbody = document.getElementById('tabellaSpese');
            tbody.innerHTML = '';
            
            const spese = autoCorrente.spese_aggiuntive || [];
            let totaleSpese = 0;
            
            // Ordina spese per data (pi√π recenti prima)
            spese.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            spese.forEach(spesa => {
                totaleSpese += spesa.importo;
                const row = tbody.insertRow();
                
                // Colore diverso per i costi iniziali
                const categoriaColor = spesa.isInitialCost ? '#1e40af' : '#6c757d';
                const categoriaText = spesa.isInitialCost ? 'Costo Iniziale' : spesa.categoria;
                
                row.innerHTML = `
                    <td>${new Date(spesa.data).toLocaleDateString('it-IT')}</td>
                    <td><span style="background: ${categoriaColor}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem;">${categoriaText}</span></td>
                    <td style="font-weight: bold;">‚Ç¨${spesa.importo.toLocaleString()}</td>
                    <td>${spesa.descrizione || '-'}</td>
                    <td class="actions">
                        ${!spesa.isInitialCost ? `<button class="btn btn-danger" onclick="eliminaSpesa(${spesa.id})" style="padding: 4px 8px; font-size: 0.8rem;">üóëÔ∏è</button>` : ''}
                    </td>
                `;
            });
            
            // Aggiungi riga totale
            if (spese.length > 0) {
                const row = tbody.insertRow();
                row.style.background = '#f8f9fa';
                row.style.fontWeight = 'bold';
                row.innerHTML = `
                    <td colspan="2"><strong>TOTALE COSTI E SPESE</strong></td>
                    <td style="color: #dc3545;"><strong>‚Ç¨${totaleSpese.toLocaleString()}</strong></td>
                    <td colspan="2"></td>
                `;
            }
        }

        async function eliminaSpesa(spesaId) {
            if (!autoCorrente || !confirm('Sei sicuro di voler eliminare questa spesa?')) return;
            
            autoCorrente.spese_aggiuntive = autoCorrente.spese_aggiuntive.filter(s => s.id != spesaId);
            await salvaDatiSupabase();
            aggiornaTabellaSpese();
            aggiornaTabelle();
            aggiornaStatistiche();
            
            // Aggiorna info auto nel modal
            gestisciSpese(autoCorrente.id);
            
            mostrarNotifica('‚úÖ Spesa eliminata con successo!', 'success');
        }

        function chiudiModalSpese() {
            document.getElementById('modalSpese').style.display = 'none';
            autoCorrente = null;
        }

        // DETTAGLIO MARGINE
        function mostraDettaglioMargine(autoId) {
            const autoObj = auto.find(a => a.id == autoId);
            if (!autoObj) return;
            
            const speseAggiuntiveTotali = (autoObj.spese_aggiuntive || []).reduce((sum, spesa) => sum + spesa.importo, 0);
            const costoTotale = autoObj.prezzo_acquisto + speseAggiuntiveTotali;
            const margine = autoObj.prezzo_vendita - costoTotale;
            
            // Info auto
            document.getElementById('infoAutoMargine').innerHTML = `
                <h3>${autoObj.marca} ${autoObj.modello} (${autoObj.targa})</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                    <div><strong>Tipo:</strong> ${autoObj.tipo}</div>
                    <div><strong>Stato:</strong> ${autoObj.stato}</div>
                    <div><strong>Km:</strong> ${autoObj.chilometri.toLocaleString()}</div>
                    <div><strong>Immatricolazione:</strong> ${autoObj.data_immatricolazione ? new Date(autoObj.data_immatricolazione).toLocaleDateString('it-IT') : 'N/D'}</div>
                </div>
            `;
            
            // Tabella dettaglio
            const tbody = document.getElementById('tabellaDettaglioMargine');
            tbody.innerHTML = '';
            
            // Prezzo vendita
            let row = tbody.insertRow();
            row.innerHTML = `
                <td style="padding: 12px; font-weight: bold; background: #e8f5e8;">üí∞ PREZZO DI VENDITA</td>
                <td style="padding: 12px; text-align: right; font-weight: bold; background: #e8f5e8; color: #28a745;">+‚Ç¨${autoObj.prezzo_vendita.toLocaleString()}</td>
            `;
            
            // Prezzo acquisto
            row = tbody.insertRow();
            row.innerHTML = `
                <td style="padding: 12px;">üè™ Prezzo di acquisto</td>
                <td style="padding: 12px; text-align: right; color: #dc3545;">-‚Ç¨${autoObj.prezzo_acquisto.toLocaleString()}</td>
            `;
            
            // Spese e costi
            if (speseAggiuntiveTotali > 0) {
                row = tbody.insertRow();
                row.innerHTML = `
                    <td style="padding: 12px;">üìã Spese e costi sostenuti</td>
                    <td style="padding: 12px; text-align: right; color: #dc3545;">-‚Ç¨${speseAggiuntiveTotali.toLocaleString()}</td>
                `;
                
                // Dettaglio spese
                (autoObj.spese_aggiuntive || []).forEach(spesa => {
                    const icona = spesa.isInitialCost ? 'üîß' : 'üìã';
                    row = tbody.insertRow();
                    row.innerHTML = `
                        <td style="padding: 8px 12px 8px 30px; font-size: 0.9rem; color: #666;">${icona} ${spesa.descrizione || spesa.categoria} (${new Date(spesa.data).toLocaleDateString('it-IT')})</td>
                        <td style="padding: 8px 12px; text-align: right; font-size: 0.9rem; color: #666;">-‚Ç¨${spesa.importo.toLocaleString()}</td>
                    `;
                });
            }
            
            // Totale costi
            row = tbody.insertRow();
            row.innerHTML = `
                <td style="padding: 12px; font-weight: bold; background: #ffe6e6; border-top: 2px solid #ddd;">üìä TOTALE COSTI E SPESE</td>
                <td style="padding: 12px; text-align: right; font-weight: bold; background: #ffe6e6; color: #dc3545; border-top: 2px solid #ddd;">-‚Ç¨${costoTotale.toLocaleString()}</td>
            `;
            
            // Margine finale
            row = tbody.insertRow();
            row.style.background = margine >= 0 ? '#d4edda' : '#f8d7da';
            row.innerHTML = `
                <td style="padding: 15px; font-weight: bold; font-size: 1.1rem; border-top: 3px solid #333;">${margine >= 0 ? '‚úÖ' : '‚ùå'} MARGINE NETTO</td>
                <td style="padding: 15px; text-align: right; font-weight: bold; font-size: 1.2rem; color: ${margine >= 0 ? '#155724' : '#721c24'}; border-top: 3px solid #333;">${margine >= 0 ? '+' : ''}‚Ç¨${margine.toLocaleString()}</td>
            `;
            
            // Percentuale margine
            const percentualeMargine = autoObj.prezzo_vendita > 0 ? ((margine / autoObj.prezzo_vendita) * 100).toFixed(1) : 0;
            row = tbody.insertRow();
            row.innerHTML = `
                <td style="padding: 10px; font-style: italic; color: #666;">üìà Percentuale margine sul prezzo di vendita</td>
                <td style="padding: 10px; text-align: right; font-style: italic; color: ${margine >= 0 ? '#28a745' : '#dc3545'};">${percentualeMargine}%</td>
            `;
            
            document.getElementById('modalDettaglioMargine').style.display = 'block';
        }

        function chiudiModalDettaglioMargine() {
            document.getElementById('modalDettaglioMargine').style.display = 'none';
        }

        // CONTRATTO
        function mostraContratto(contratto) {
            const totaleExtra = (contratto.extra_items || []).reduce((sum, item) => sum + item.prezzo, 0);
            const prezzoBaseAuto = contratto.auto.prezzo_vendita;
            const scontoApplicato = contratto.sconto_applicato || 0;
            const prezzoFinaleAuto = contratto.prezzo_finale_auto || prezzoBaseAuto;
            const totaleASaldo = prezzoFinaleAuto + totaleExtra - (contratto.permuta.valutazione || 0) - contratto.deposito_cauzionale + contratto.spese_voltura;
            
            const html = `
                <div class="contract-preview">
                    <!-- Header con logo e info azienda -->
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 20px; margin-bottom: 20px; align-items: start;">
                        <div style="text-align: center;">
                            <img src="https://gestionalevero.netlify.app/logopericar2.png" alt="PERICAR Logo" style="height: 80px; width
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96e78afa0134723e',t:'MTc1NTA4MTA4Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
