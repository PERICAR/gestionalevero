<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Gestione Concessionaria PERICAR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.9rem;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: white;
            color: #1f2937;
            padding: 30px;
            text-align: center;
            border-bottom: 3px solid #1e40af;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.8;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab.active {
            color: #1f2937;
            background: white;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #1e40af;
        }

        .nav-tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 0.95rem;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #1e40af;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(30, 64, 175, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(5, 150, 105, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(217, 119, 6, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(220, 38, 38, 0.3);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(30, 64, 175, 0.2);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .contract-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            font-family: Arial, sans-serif;
            font-size: 0.75rem;
            line-height: 1.2;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .contract-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
        }

        .contract-section {
            margin-bottom: 15px;
        }

        .contract-section h3 {
            background: #f8f9fa;
            padding: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #1e40af;
            font-size: 0.85rem;
        }

        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .signature-box {
            text-align: center;
            padding: 10px 0;
        }

        .signature-line {
            border-bottom: 1px solid #333;
            margin-bottom: 8px;
            height: 30px;
        }

        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; }
            .nav-tabs, .btn { display: none; }
            .tab-content { display: block !important; padding: 0; }
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-danger {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://gestionalevero.netlify.app/logopericar.png" alt="PERICAR Logo" style="height: 80px; width: auto; margin-bottom: 15px;">
            <p>Sistema di Gestione Concessionaria - Corso Casale 99, Asti</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('clienti')">👥 Clienti</button>
            <button class="nav-tab" onclick="showTab('auto')">🚙 Auto in Stock</button>
            <button class="nav-tab" onclick="showTab('contratti')">📋 Contratti</button>
            <button class="nav-tab" onclick="showTab('statistiche')">📊 Statistiche</button>
        </div>

        <!-- TAB CLIENTI -->
        <div id="clienti" class="tab-content active">
            <h2>Gestione Clienti</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Nome e Cognome</label>
                    <input type="text" id="nomeCliente" placeholder="Mario Rossi">
                </div>
                <div class="form-group">
                    <label>Luogo di Nascita</label>
                    <input type="text" id="luogoNascita" placeholder="Torino">
                </div>
                <div class="form-group">
                    <label>Residenza</label>
                    <input type="text" id="residenza" placeholder="Via Roma 123, Asti">
                </div>
                <div class="form-group">
                    <label>Codice Fiscale</label>
                    <input type="text" id="codiceFiscale" placeholder="RSSMRA80A01L219K">
                </div>
                <div class="form-group">
                    <label>Professione</label>
                    <input type="text" id="professione" placeholder="Impiegato">
                </div>
                <div class="form-group">
                    <label>Telefono</label>
                    <input type="text" id="telefono" placeholder="+39 333 1234567">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="emailCliente" placeholder="mario.rossi@email.com">
                </div>
            </div>

            <button class="btn btn-primary" onclick="aggiungiCliente()">➕ Aggiungi Cliente</button>

            <div style="margin: 20px 0;">
                <input type="text" id="searchClienti" placeholder="🔍 Cerca clienti per nome, telefono, email..." style="width: 100%; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;" onkeyup="filtraClienti()">
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Telefono</th>
                        <th>Email</th>
                        <th>Codice Fiscale</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="tabellaClienti"></tbody>
            </table>
        </div>

        <!-- TAB AUTO -->
        <div id="auto" class="tab-content">
            <h2>Gestione Auto in Stock</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Marca</label>
                    <input type="text" id="marca" placeholder="BMW">
                </div>
                <div class="form-group">
                    <label>Modello</label>
                    <input type="text" id="modello" placeholder="Serie 3">
                </div>
                <div class="form-group">
                    <label>Versione</label>
                    <input type="text" id="versione" placeholder="320d xDrive">
                </div>
                <div class="form-group">
                    <label>Targa</label>
                    <input type="text" id="targa" placeholder="AB123CD">
                </div>
                <div class="form-group">
                    <label>Telaio</label>
                    <input type="text" id="telaio" placeholder="WBA123456789">
                </div>
                <div class="form-group">
                    <label>Data Immatricolazione</label>
                    <input type="date" id="dataImmatricolazione">
                </div>
                <div class="form-group">
                    <label>Chilometri</label>
                    <input type="number" id="chilometri" placeholder="50000">
                </div>
                <div class="form-group">
                    <label>Prezzo di Acquisto (€)</label>
                    <input type="number" id="prezzoAcquisto" placeholder="25000">
                </div>
                <div class="form-group">
                    <label>Prezzo di Vendita (€)</label>
                    <input type="number" id="prezzoVendita" placeholder="28000">
                </div>
                <div class="form-group">
                    <label>Costi Aggiuntivi (€)</label>
                    <input type="number" id="costiAggiuntivi" placeholder="500">
                </div>
                <div class="form-group">
                    <label>Descrizione Costi</label>
                    <textarea id="descrizioneCosti" placeholder="Es: Riparazione freni, Tagliando, Pneumatici..." style="min-height: 60px; resize: vertical;"></textarea>
                </div>
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="tipoAuto">
                        <option value="NUOVO">NUOVO</option>
                        <option value="KM0">KM0</option>
                        <option value="USATO">USATO</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Stato</label>
                    <select id="statoAuto">
                        <option value="Disponibile">Disponibile</option>
                        <option value="Venduta">Venduta</option>
                        <option value="In Trattativa">In Trattativa</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-success" onclick="aggiungiAuto()">🚗 Aggiungi Auto</button>

            <div style="margin: 20px 0; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="font-weight: 600;">Visualizza:</label>
                    <select id="filtroStato" onchange="filtraPerStato()" style="padding: 8px 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 0.9rem;">
                        <option value="stock">🚗 Auto in Stock</option>
                        <option value="vendute">✅ Auto Vendute</option>
                        <option value="tutte">📋 Tutte le Auto</option>
                    </select>
                </div>
                <input type="text" id="searchAuto" placeholder="🔍 Cerca auto per marca, modello, targa..." style="flex: 1; min-width: 300px; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;" onkeyup="filtraAuto()">
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>Marca/Modello</th>
                        <th>Targa</th>
                        <th>Immatricolazione</th>
                        <th>Km</th>
                        <th>Tipo</th>
                        <th>Stato</th>
                        <th>Prezzo Vendita</th>
                        <th>Margine</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="tabellaAuto"></tbody>
            </table>
        </div>

        <!-- TAB CONTRATTI -->
        <div id="contratti" class="tab-content">
            <h2>Gestione Contratti</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Cliente</label>
                    <select id="clienteContratto">
                        <option value="">Seleziona Cliente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Auto da Vendere</label>
                    <select id="autoContratto">
                        <option value="">Seleziona Auto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Data Contratto</label>
                    <input type="date" id="dataContratto">
                </div>
                <div class="form-group">
                    <label>Luogo</label>
                    <input type="text" id="luogoContratto" value="Asti" placeholder="Asti">
                </div>
            </div>

            <h3>Auto in Permuta (Opzionale)</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Marca Permuta</label>
                    <input type="text" id="marcaPermuta" placeholder="Fiat">
                </div>
                <div class="form-group">
                    <label>Modello Permuta</label>
                    <input type="text" id="modelloPermuta" placeholder="Punto">
                </div>
                <div class="form-group">
                    <label>Targa Permuta</label>
                    <input type="text" id="targaPermuta" placeholder="EF456GH">
                </div>
                <div class="form-group">
                    <label>Telaio Permuta</label>
                    <input type="text" id="telaioPermuta" placeholder="ZFA123456789">
                </div>
                <div class="form-group">
                    <label>Data Immatricolazione Permuta</label>
                    <input type="date" id="dataImmatricolazionePermuta">
                </div>
                <div class="form-group">
                    <label>Km Permuta</label>
                    <input type="number" id="chilometriPermuta" placeholder="80000">
                </div>
                <div class="form-group">
                    <label>Versione Permuta</label>
                    <input type="text" id="versionePermuta" placeholder="1.2 Benzina">
                </div>
                <div class="form-group">
                    <label>Valutazione Permuta (€)</label>
                    <input type="number" id="valutazionePermuta" placeholder="8000">
                </div>
            </div>

            <h3>Dettagli Economici</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Deposito Cauzionale (€)</label>
                    <input type="number" id="depositoCauzionale" placeholder="1000">
                </div>
                <div class="form-group">
                    <label>Spese Voltura/Minivoltura (€)</label>
                    <input type="number" id="speseVoltura" placeholder="350">
                </div>
            </div>

            <h3>Servizi/Accessori Aggiuntivi</h3>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div class="form-grid" style="grid-template-columns: 2fr 1fr auto;">
                    <div class="form-group">
                        <label>Descrizione</label>
                        <input type="text" id="descrizioneExtra" placeholder="Es: Assicurazione Kasko, Navigatore, Cerchi in lega...">
                    </div>
                    <div class="form-group">
                        <label>Prezzo (€)</label>
                        <input type="number" id="prezzoExtra" placeholder="500">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-success" onclick="aggiungiExtra()" style="margin-top: 0;">➕ Aggiungi</button>
                    </div>
                </div>
                
                <div id="listaExtra" style="margin-top: 15px;"></div>
            </div>

            <button class="btn btn-primary" onclick="creaContratto()">📋 Crea Contratto</button>

            <div style="margin: 20px 0;">
                <input type="text" id="searchContratti" placeholder="🔍 Cerca contratti per cliente, auto, data..." style="width: 100%; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;" onkeyup="filtraContratti()">
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Cliente</th>
                        <th>Auto</th>
                        <th>Prezzo</th>
                        <th>Permuta</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="tabellaContratti"></tbody>
            </table>
        </div>

        <!-- TAB STATISTICHE -->
        <div id="statistiche" class="tab-content">
            <h2>Statistiche e Conto Economico</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totaleAuto">0</h3>
                    <p>Auto in Stock</p>
                </div>
                <div class="stat-card">
                    <h3 id="totaleContratti">19</h3>
                    <p>Contratti Firmati</p>
                </div>
                <div class="stat-card">
                    <h3 id="fatturatoTotale">€132.020</h3>
                    <p>Fatturato Totale</p>
                </div>
            </div>

            <div class="contract-preview">
                <h3>📊 Conto Economico Stock Auto</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Auto</th>
                            <th>Prezzo Acquisto</th>
                            <th>Costi Aggiuntivi</th>
                            <th>Costo Totale</th>
                            <th>Prezzo Vendita</th>
                            <th>Margine</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="contoEconomicoStock"></tbody>
                </table>
            </div>

            <div class="contract-preview" style="margin-top: 30px;">
                <h3>🚗 Auto Vendute</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Auto</th>
                            <th>Data Vendita</th>
                            <th>Cliente</th>
                            <th>Prezzo Vendita</th>
                            <th>Margine</th>
                        </tr>
                    </thead>
                    <tbody id="autoVendute"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL MODIFICA GENERALE -->
    <div id="modalModifica" class="modal">
        <div class="modal-content">
            <span class="close" onclick="chiudiModal()">&times;</span>
            <h2 id="titoloModifica">Modifica</h2>
            <div id="contenutoModifica"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-success" onclick="salvaModifica()">💾 Salva</button>
                <button class="btn btn-danger" onclick="chiudiModal()">❌ Annulla</button>
            </div>
        </div>
    </div>

    <!-- MODAL CONTRATTO -->
    <div id="modalContratto" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="chiudiModalContratto()">&times;</span>
            <div id="contrattoCompleto"></div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="stampaContratto()">🖨️ Stampa Contratto</button>
                <button class="btn btn-danger" onclick="chiudiModalContratto()">❌ Chiudi</button>
            </div>
        </div>
    </div>

    <!-- MODAL GESTIONE SPESE -->
    <div id="modalSpese" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="chiudiModalSpese()">&times;</span>
            <h2 id="titoloSpese">Gestione Spese Auto</h2>
            
            <div id="infoAuto" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
            
            <h3>Aggiungi Nuova Spesa</h3>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <div class="form-group">
                    <label>Data Spesa</label>
                    <input type="date" id="dataSpesa">
                </div>
                <div class="form-group">
                    <label>Importo (€)</label>
                    <input type="number" id="importoSpesa" placeholder="150">
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="categoriaSpesa">
                        <option value="Riparazione">Riparazione</option>
                        <option value="Manutenzione">Manutenzione</option>
                        <option value="Pneumatici">Pneumatici</option>
                        <option value="Carrozzeria">Carrozzeria</option>
                        <option value="Revisione">Revisione</option>
                        <option value="Bollo">Bollo</option>
                        <option value="Assicurazione">Assicurazione</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Descrizione</label>
                <textarea id="descrizioneSpesa" placeholder="Descrizione dettagliata della spesa..." style="min-height: 60px;"></textarea>
            </div>
            
            <button class="btn btn-success" onclick="aggiungiSpesa()">➕ Aggiungi Spesa</button>
            
            <h3 style="margin-top: 30px;">Spese Registrate</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Categoria</th>
                        <th>Importo</th>
                        <th>Descrizione</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="tabellaSpese"></tbody>
            </table>
            
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-danger" onclick="chiudiModalSpese()">❌ Chiudi</button>
            </div>
        </div>
    </div>

    <script>
        // Dati globali
        let clienti = JSON.parse(localStorage.getItem('clienti')) || [];
        let auto = JSON.parse(localStorage.getItem('auto')) || [];
        let contratti = JSON.parse(localStorage.getItem('contratti')) || [];
        let oggettoInModifica = null;
        let tipoOggettoInModifica = '';
        let autoCorrente = null;
        let extraItems = []; // Array per servizi/accessori aggiuntivi

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            aggiornaTabelle();
            aggiornaStatistiche();
            aggiornaSelectClienti();
            aggiornaSelectAuto();
            aggiornaListaExtra();
            
            // Imposta data odierna
            document.getElementById('dataContratto').value = new Date().toISOString().split('T')[0];
        });

        // Gestione tab
        function showTab(tabName) {
            // Nascondi tutti i tab
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostra tab selezionato
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // GESTIONE CLIENTI
        function aggiungiCliente() {
            const nome = document.getElementById('nomeCliente').value;
            const luogoNascita = document.getElementById('luogoNascita').value;
            const residenza = document.getElementById('residenza').value;
            const codiceFiscale = document.getElementById('codiceFiscale').value;
            const professione = document.getElementById('professione').value;
            const telefono = document.getElementById('telefono').value;
            const email = document.getElementById('emailCliente').value;

            if (!nome || !telefono) {
                alert('Nome e telefono sono obbligatori!');
                return;
            }

            const cliente = {
                id: Date.now(),
                nome,
                luogoNascita,
                residenza,
                codiceFiscale,
                professione,
                telefono,
                email
            };

            clienti.push(cliente);
            salvaClienti();
            aggiornaTabelle();
            aggiornaStatistiche();
            aggiornaSelectClienti();
            pulisciFormCliente();
        }

        function pulisciFormCliente() {
            document.getElementById('nomeCliente').value = '';
            document.getElementById('luogoNascita').value = '';
            document.getElementById('residenza').value = '';
            document.getElementById('codiceFiscale').value = '';
            document.getElementById('professione').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('emailCliente').value = '';
        }

        // GESTIONE AUTO
        function aggiungiAuto() {
            const marca = document.getElementById('marca').value;
            const modello = document.getElementById('modello').value;
            const versione = document.getElementById('versione').value;
            const targa = document.getElementById('targa').value;
            const telaio = document.getElementById('telaio').value;
            const dataImmatricolazione = document.getElementById('dataImmatricolazione').value;
            const chilometri = document.getElementById('chilometri').value;
            const prezzoAcquisto = parseFloat(document.getElementById('prezzoAcquisto').value) || 0;
            const prezzoVendita = parseFloat(document.getElementById('prezzoVendita').value) || 0;
            const tipo = document.getElementById('tipoAuto').value;
            const stato = document.getElementById('statoAuto').value;

            if (!marca || !modello || !targa) {
                alert('Marca, modello e targa sono obbligatori!');
                return;
            }

            const autoObj = {
                id: Date.now(),
                marca,
                modello,
                versione,
                targa,
                telaio,
                dataImmatricolazione,
                chilometri: parseInt(chilometri) || 0,
                prezzoAcquisto,
                prezzoVendita,
                costiAggiuntivi: parseFloat(document.getElementById('costiAggiuntivi').value) || 0,
                descrizioneCosti: document.getElementById('descrizioneCosti').value,
                tipo,
                stato,
                speseAggiuntive: [] // Array per tracciare spese successive
            };

            auto.push(autoObj);
            salvaAuto();
            aggiornaTabelle();
            aggiornaStatistiche();
            aggiornaSelectAuto();
            pulisciFormAuto();
        }

        function pulisciFormAuto() {
            document.getElementById('marca').value = '';
            document.getElementById('modello').value = '';
            document.getElementById('versione').value = '';
            document.getElementById('targa').value = '';
            document.getElementById('telaio').value = '';
            document.getElementById('dataImmatricolazione').value = '';
            document.getElementById('chilometri').value = '';
            document.getElementById('prezzoAcquisto').value = '';
            document.getElementById('prezzoVendita').value = '';
            document.getElementById('costiAggiuntivi').value = '';
            document.getElementById('descrizioneCosti').value = '';
            document.getElementById('tipoAuto').value = 'NUOVO';
            document.getElementById('statoAuto').value = 'Disponibile';
        }

        // GESTIONE CONTRATTI
        function creaContratto() {
            const clienteId = document.getElementById('clienteContratto').value;
            const autoId = document.getElementById('autoContratto').value;
            const dataContratto = document.getElementById('dataContratto').value;
            const luogo = document.getElementById('luogoContratto').value;

            if (!clienteId || !autoId || !dataContratto) {
                alert('Cliente, auto e data sono obbligatori!');
                return;
            }

            const cliente = clienti.find(c => c.id == clienteId);
            const autoVenduta = auto.find(a => a.id == autoId);

            // Dati permuta (opzionali)
            const permuta = {
                marca: document.getElementById('marcaPermuta').value,
                modello: document.getElementById('modelloPermuta').value,
                targa: document.getElementById('targaPermuta').value,
                telaio: document.getElementById('telaioPermuta').value,
                dataImmatricolazione: document.getElementById('dataImmatricolazionePermuta').value,
                chilometri: parseInt(document.getElementById('chilometriPermuta').value) || 0,
                versione: document.getElementById('versionePermuta').value,
                valutazione: parseFloat(document.getElementById('valutazionePermuta').value) || 0
            };

            const contratto = {
                id: Date.now(),
                clienteId,
                autoId,
                dataContratto,
                luogo,
                permuta,
                depositoCauzionale: parseFloat(document.getElementById('depositoCauzionale').value) || 0,
                speseVoltura: parseFloat(document.getElementById('speseVoltura').value) || 0,
                extraItems: [...extraItems], // Copia degli extra items
                cliente,
                auto: autoVenduta
            };

            contratti.push(contratto);
            
            // Aggiorna stato auto
            autoVenduta.stato = 'Venduta';
            
            salvaContratti();
            salvaAuto();
            aggiornaTabelle();
            aggiornaStatistiche();
            aggiornaSelectAuto();
            pulisciFormContratto();
            
            // Mostra contratto
            mostraContratto(contratto);
        }

        function pulisciFormContratto() {
            document.getElementById('clienteContratto').value = '';
            document.getElementById('autoContratto').value = '';
            document.getElementById('luogoContratto').value = 'Asti';
            document.getElementById('marcaPermuta').value = '';
            document.getElementById('modelloPermuta').value = '';
            document.getElementById('targaPermuta').value = '';
            document.getElementById('telaioPermuta').value = '';
            document.getElementById('dataImmatricolazionePermuta').value = '';
            document.getElementById('chilometriPermuta').value = '';
            document.getElementById('versionePermuta').value = '';
            document.getElementById('valutazionePermuta').value = '';
            document.getElementById('depositoCauzionale').value = '';
            document.getElementById('speseVoltura').value = '';
            document.getElementById('descrizioneExtra').value = '';
            document.getElementById('prezzoExtra').value = '';
            extraItems = [];
            aggiornaListaExtra();
        }

        // GESTIONE SERVIZI/ACCESSORI AGGIUNTIVI
        function aggiungiExtra() {
            const descrizione = document.getElementById('descrizioneExtra').value.trim();
            const prezzo = parseFloat(document.getElementById('prezzoExtra').value) || 0;
            
            if (!descrizione || prezzo <= 0) {
                alert('Descrizione e prezzo sono obbligatori!');
                return;
            }
            
            const extra = {
                id: Date.now(),
                descrizione,
                prezzo
            };
            
            extraItems.push(extra);
            aggiornaListaExtra();
            
            // Pulisci campi
            document.getElementById('descrizioneExtra').value = '';
            document.getElementById('prezzoExtra').value = '';
        }

        function rimuoviExtra(id) {
            extraItems = extraItems.filter(item => item.id !== id);
            aggiornaListaExtra();
        }

        function aggiornaListaExtra() {
            const container = document.getElementById('listaExtra');
            
            if (extraItems.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic; margin: 0;">Nessun servizio/accessorio aggiunto</p>';
                return;
            }
            
            let html = '<div style="border: 1px solid #ddd; border-radius: 6px; overflow: hidden;">';
            html += '<div style="background: #e9ecef; padding: 8px; font-weight: bold; display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px;">';
            html += '<div>Descrizione</div><div style="text-align: right;">Prezzo</div><div style="width: 60px;"></div>';
            html += '</div>';
            
            extraItems.forEach(item => {
                html += `<div style="padding: 8px; border-top: 1px solid #eee; display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px; align-items: center;">
                    <div>${item.descrizione}</div>
                    <div style="text-align: right; font-weight: bold;">€${item.prezzo.toLocaleString()}</div>
                    <div><button class="btn btn-danger" onclick="rimuoviExtra(${item.id})" style="padding: 4px 8px; font-size: 0.8rem;">🗑️</button></div>
                </div>`;
            });
            
            const totale = extraItems.reduce((sum, item) => sum + item.prezzo, 0);
            html += `<div style="padding: 8px; border-top: 2px solid #ddd; background: #f8f9fa; display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px; font-weight: bold;">
                <div>TOTALE EXTRA</div>
                <div style="text-align: right; color: #1e40af;">€${totale.toLocaleString()}</div>
                <div></div>
            </div>`;
            
            html += '</div>';
            container.innerHTML = html;
        }

        // MODIFICA GENERALE
        function modificaOggetto(tipo, id) {
            let oggetto;
            let campi = [];
            
            if (tipo === 'cliente') {
                oggetto = clienti.find(c => c.id == id);
                campi = [
                    {nome: 'nome', label: 'Nome e Cognome', tipo: 'text'},
                    {nome: 'luogoNascita', label: 'Luogo di Nascita', tipo: 'text'},
                    {nome: 'residenza', label: 'Residenza', tipo: 'text'},
                    {nome: 'codiceFiscale', label: 'Codice Fiscale', tipo: 'text'},
                    {nome: 'professione', label: 'Professione', tipo: 'text'},
                    {nome: 'telefono', label: 'Telefono', tipo: 'text'},
                    {nome: 'email', label: 'Email', tipo: 'email'}
                ];
            } else if (tipo === 'auto') {
                oggetto = auto.find(a => a.id == id);
                campi = [
                    {nome: 'marca', label: 'Marca', tipo: 'text'},
                    {nome: 'modello', label: 'Modello', tipo: 'text'},
                    {nome: 'versione', label: 'Versione', tipo: 'text'},
                    {nome: 'targa', label: 'Targa', tipo: 'text'},
                    {nome: 'telaio', label: 'Telaio', tipo: 'text'},
                    {nome: 'dataImmatricolazione', label: 'Data Immatricolazione', tipo: 'date'},
                    {nome: 'chilometri', label: 'Chilometri', tipo: 'number'},
                    {nome: 'prezzoAcquisto', label: 'Prezzo Acquisto (€)', tipo: 'number'},
                    {nome: 'prezzoVendita', label: 'Prezzo Vendita (€)', tipo: 'number'},
                    {nome: 'costiAggiuntivi', label: 'Costi Aggiuntivi (€)', tipo: 'number'},
                    {nome: 'tipo', label: 'Tipo', tipo: 'select', opzioni: ['NUOVO', 'KM0', 'USATO']},
                    {nome: 'stato', label: 'Stato', tipo: 'select', opzioni: ['Disponibile', 'Venduta', 'In Trattativa']}
                ];
            }
            
            if (!oggetto) return;
            
            oggettoInModifica = oggetto;
            tipoOggettoInModifica = tipo;
            
            document.getElementById('titoloModifica').textContent = `Modifica ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`;
            
            let html = '<div class="form-grid">';
            campi.forEach(campo => {
                html += `<div class="form-group">
                    <label>${campo.label}</label>`;
                
                if (campo.tipo === 'select') {
                    html += `<select id="modifica_${campo.nome}">`;
                    campo.opzioni.forEach(opzione => {
                        const selected = oggetto[campo.nome] === opzione ? 'selected' : '';
                        html += `<option value="${opzione}" ${selected}>${opzione}</option>`;
                    });
                    html += `</select>`;
                } else {
                    html += `<input type="${campo.tipo}" id="modifica_${campo.nome}" value="${oggetto[campo.nome] || ''}">`;
                }
                
                html += `</div>`;
            });
            html += '</div>';
            
            document.getElementById('contenutoModifica').innerHTML = html;
            document.getElementById('modalModifica').style.display = 'block';
        }

        function salvaModifica() {
            if (!oggettoInModifica) return;
            
            // Aggiorna tutti i campi dell'oggetto
            const inputs = document.getElementById('contenutoModifica').querySelectorAll('input, select');
            inputs.forEach(input => {
                const campo = input.id.replace('modifica_', '');
                if (input.type === 'number') {
                    oggettoInModifica[campo] = parseFloat(input.value) || 0;
                } else {
                    oggettoInModifica[campo] = input.value;
                }
            });
            
            // Salva nel localStorage
            if (tipoOggettoInModifica === 'cliente') {
                salvaClienti();
                aggiornaSelectClienti();
            } else if (tipoOggettoInModifica === 'auto') {
                salvaAuto();
                aggiornaSelectAuto();
            }
            
            aggiornaTabelle();
            aggiornaStatistiche();
            chiudiModal();
        }

        function chiudiModal() {
            document.getElementById('modalModifica').style.display = 'none';
            oggettoInModifica = null;
            tipoOggettoInModifica = '';
        }

        function modificaCostiAuto(id) {
            const autoObj = auto.find(a => a.id == id);
            if (!autoObj) return;
            
            oggettoInModifica = autoObj;
            tipoOggettoInModifica = 'auto';
            
            document.getElementById('titoloModifica').textContent = 'Modifica Costi Auto';
            
            const html = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>Auto</label>
                        <input type="text" value="${autoObj.marca} ${autoObj.modello} (${autoObj.targa})" readonly>
                    </div>
                    <div class="form-group">
                        <label>Prezzo Acquisto (€)</label>
                        <input type="number" id="modifica_prezzoAcquisto" value="${autoObj.prezzoAcquisto}">
                    </div>
                    <div class="form-group">
                        <label>Costi Aggiuntivi (€)</label>
                        <input type="number" id="modifica_costiAggiuntivi" value="${autoObj.costiAggiuntivi || 0}">
                    </div>
                    <div class="form-group">
                        <label>Prezzo Vendita (€)</label>
                        <input type="number" id="modifica_prezzoVendita" value="${autoObj.prezzoVendita}">
                    </div>
                    <div class="form-group">
                        <label>Descrizione Costi</label>
                        <textarea id="modifica_descrizioneCosti" placeholder="Es: Riparazione freni, Tagliando, Pneumatici...">${autoObj.descrizioneCosti || ''}</textarea>
                    </div>
                </div>
            `;
            
            document.getElementById('contenutoModifica').innerHTML = html;
            document.getElementById('modalModifica').style.display = 'block';
        }

        // ELIMINAZIONE
        function eliminaCliente(id) {
            if (confirm('Sei sicuro di voler eliminare questo cliente?')) {
                clienti = clienti.filter(c => c.id != id);
                salvaClienti();
                aggiornaTabelle();
                aggiornaStatistiche();
                aggiornaSelectClienti();
            }
        }

        function eliminaAuto(id) {
            if (confirm('Sei sicuro di voler eliminare questa auto?')) {
                auto = auto.filter(a => a.id != id);
                salvaAuto();
                aggiornaTabelle();
                aggiornaStatistiche();
                aggiornaSelectAuto();
            }
        }

        function eliminaContratto(id) {
            if (confirm('Sei sicuro di voler eliminare questo contratto?')) {
                const contratto = contratti.find(c => c.id == id);
                if (contratto) {
                    // Rimetti l'auto come disponibile
                    const autoContratto = auto.find(a => a.id == contratto.autoId);
                    if (autoContratto) {
                        autoContratto.stato = 'Disponibile';
                        salvaAuto();
                    }
                }
                
                contratti = contratti.filter(c => c.id != id);
                salvaContratti();
                aggiornaTabelle();
                aggiornaStatistiche();
                aggiornaSelectAuto();
            }
        }

        // FUNZIONI DI RICERCA
        function filtraClienti() {
            const searchTerm = document.getElementById('searchClienti').value.toLowerCase();
            const rows = document.querySelectorAll('#tabellaClienti tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function filtraAuto() {
            const searchTerm = document.getElementById('searchAuto').value.toLowerCase();
            const rows = document.querySelectorAll('#tabellaAuto tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function filtraPerStato() {
            aggiornaTabellaAuto();
        }

        function filtraContratti() {
            const searchTerm = document.getElementById('searchContratti').value.toLowerCase();
            const rows = document.querySelectorAll('#tabellaContratti tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // AGGIORNAMENTO TABELLE
        function aggiornaTabelle() {
            aggiornaTabelliaClienti();
            aggiornaTabellaAuto();
            aggiornaTabellaContratti();
            aggiornaContoEconomicoStock();
        }

        function aggiornaTabelliaClienti() {
            const tbody = document.getElementById('tabellaClienti');
            tbody.innerHTML = '';
            
            clienti.forEach(cliente => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${cliente.nome}</td>
                    <td>${cliente.telefono}</td>
                    <td>${cliente.email || '-'}</td>
                    <td>${cliente.codiceFiscale || '-'}</td>
                    <td class="actions">
                        <button class="btn btn-warning" onclick="modificaOggetto('cliente', ${cliente.id})">✏️ Modifica</button>
                        <button class="btn btn-danger" onclick="eliminaCliente(${cliente.id})">🗑️ Elimina</button>
                    </td>
                `;
            });
        }

        function aggiornaTabellaAuto() {
            const tbody = document.getElementById('tabellaAuto');
            tbody.innerHTML = '';
            
            // Determina quali auto mostrare in base al filtro
            const filtroStato = document.getElementById('filtroStato').value;
            let autoFiltrate;
            
            if (filtroStato === 'stock') {
                autoFiltrate = auto.filter(autoObj => autoObj.stato !== 'Venduta');
            } else if (filtroStato === 'vendute') {
                autoFiltrate = auto.filter(autoObj => autoObj.stato === 'Venduta');
            } else {
                autoFiltrate = auto;
            }
            
            autoFiltrate.forEach(autoObj => {
                const speseAggiuntiveTotali = (autoObj.speseAggiuntive || []).reduce((sum, spesa) => sum + spesa.importo, 0);
                const costoTotale = autoObj.prezzoAcquisto + (autoObj.costiAggiuntivi || 0) + speseAggiuntiveTotali;
                const margine = autoObj.prezzoVendita - costoTotale;
                const row = tbody.insertRow();
                
                const statoColor = autoObj.stato === 'Disponibile' ? '#28a745' : 
                                 autoObj.stato === 'Venduta' ? '#dc3545' : '#ffc107';
                
                row.innerHTML = `
                    <td>${autoObj.marca} ${autoObj.modello}</td>
                    <td>${autoObj.targa}</td>
                    <td>${autoObj.dataImmatricolazione ? new Date(autoObj.dataImmatricolazione).toLocaleDateString('it-IT') : '-'}</td>
                    <td>${autoObj.chilometri.toLocaleString()}</td>
                    <td><span style="background: ${autoObj.tipo === 'NUOVO' ? '#28a745' : autoObj.tipo === 'KM0' ? '#ffc107' : '#6c757d'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">${autoObj.tipo}</span></td>
                    <td><span style="background: ${statoColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">${autoObj.stato}</span></td>
                    <td>€${autoObj.prezzoVendita.toLocaleString()}</td>
                    <td style="color: ${margine >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">€${margine.toLocaleString()}</td>
                    <td class="actions">
                        <button class="btn btn-warning" onclick="modificaOggetto('auto', ${autoObj.id})">✏️ Modifica</button>
                        ${autoObj.stato !== 'Venduta' ? `<button class="btn btn-primary" onclick="gestisciSpese(${autoObj.id})">💰 Spese</button>` : `<button class="btn btn-success" onclick="stampaReportAuto(${autoObj.id})">📊 Report</button>`}
                        <button class="btn btn-danger" onclick="eliminaAuto(${autoObj.id})">🗑️ Elimina</button>
                    </td>
                `;
            });
        }

        function aggiornaTabellaContratti() {
            const tbody = document.getElementById('tabellaContratti');
            tbody.innerHTML = '';
            
            contratti.forEach(contratto => {
                const row = tbody.insertRow();
                const permutaText = contratto.permuta.marca ? `${contratto.permuta.marca} ${contratto.permuta.modello} (€${contratto.permuta.valutazione.toLocaleString()})` : 'Nessuna';
                const totaleExtra = (contratto.extraItems || []).reduce((sum, item) => sum + item.prezzo, 0);
                const prezzoTotale = contratto.auto.prezzoVendita + totaleExtra;
                
                row.innerHTML = `
                    <td>${new Date(contratto.dataContratto).toLocaleDateString('it-IT')}</td>
                    <td>${contratto.cliente.nome}</td>
                    <td>${contratto.auto.marca} ${contratto.auto.modello}</td>
                    <td>€${prezzoTotale.toLocaleString()}${totaleExtra > 0 ? `<br><small style="color: #666;">(+€${totaleExtra.toLocaleString()} extra)</small>` : ''}</td>
                    <td>${permutaText}</td>
                    <td class="actions">
                        <button class="btn btn-primary" onclick="mostraContratto(${JSON.stringify(contratto).replace(/"/g, '&quot;')})">📋 Visualizza</button>
                        <button class="btn btn-warning" onclick="modificaContratto(${contratto.id})">✏️ Modifica</button>
                        <button class="btn btn-danger" onclick="eliminaContratto(${contratto.id})">🗑️ Elimina</button>
                    </td>
                `;
            });
        }

        function aggiornaContoEconomicoStock() {
            const tbody = document.getElementById('contoEconomicoStock');
            tbody.innerHTML = '';
            
            auto.filter(autoObj => autoObj.stato !== 'Venduta').forEach(autoObj => {
                const costiAggiuntivi = autoObj.costiAggiuntivi || 0;
                const costoTotale = autoObj.prezzoAcquisto + costiAggiuntivi;
                const margine = autoObj.prezzoVendita - costoTotale;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${autoObj.marca} ${autoObj.modello} (${autoObj.targa})</td>
                    <td>€${autoObj.prezzoAcquisto.toLocaleString()}</td>
                    <td>€${costiAggiuntivi.toLocaleString()}</td>
                    <td>€${costoTotale.toLocaleString()}</td>
                    <td>€${autoObj.prezzoVendita.toLocaleString()}</td>
                    <td style="color: ${margine >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">€${margine.toLocaleString()}</td>
                    <td class="actions">
                        <button class="btn btn-warning" onclick="modificaCostiAuto(${autoObj.id})">💰 Costi</button>
                    </td>
                `;
            });
            
            // Aggiorna tabella auto vendute
            const tbodyVendute = document.getElementById('autoVendute');
            tbodyVendute.innerHTML = '';
            
            contratti.forEach(contratto => {
                const autoVenduta = contratto.auto;
                const costoTotale = autoVenduta.prezzoAcquisto + (autoVenduta.costiAggiuntivi || 0);
                const margine = autoVenduta.prezzoVendita - costoTotale;
                
                const row = tbodyVendute.insertRow();
                row.innerHTML = `
                    <td>${autoVenduta.marca} ${autoVenduta.modello} (${autoVenduta.targa})</td>
                    <td>${new Date(contratto.dataContratto).toLocaleDateString('it-IT')}</td>
                    <td>${contratto.cliente.nome}</td>
                    <td>€${autoVenduta.prezzoVendita.toLocaleString()}</td>
                    <td style="color: ${margine >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">€${margine.toLocaleString()}</td>
                `;
            });
        }

        // AGGIORNAMENTO SELECT
        function aggiornaSelectClienti() {
            const select = document.getElementById('clienteContratto');
            select.innerHTML = '<option value="">Seleziona Cliente</option>';
            
            clienti.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id;
                option.textContent = cliente.nome;
                select.appendChild(option);
            });
        }

        function aggiornaSelectAuto() {
            const select = document.getElementById('autoContratto');
            select.innerHTML = '<option value="">Seleziona Auto</option>';
            
            auto.filter(a => a.stato === 'Disponibile').forEach(autoObj => {
                const option = document.createElement('option');
                option.value = autoObj.id;
                option.textContent = `${autoObj.marca} ${autoObj.modello} (${autoObj.targa}) - €${autoObj.prezzoVendita.toLocaleString()}`;
                select.appendChild(option);
            });
        }

        // STATISTICHE
        function aggiornaStatistiche() {
            const autoInStock = auto.filter(a => a.stato !== 'Venduta').length;
            document.getElementById('totaleAuto').textContent = autoInStock;
            document.getElementById('totaleContratti').textContent = 19 + contratti.length;
            
            const fatturatoContratti = contratti.reduce((sum, contratto) => sum + contratto.auto.prezzoVendita, 0);
            const fatturatoTotale = 132020 + fatturatoContratti;
            document.getElementById('fatturatoTotale').textContent = `€${fatturatoTotale.toLocaleString()}`;
        }

        // CONTRATTO
        function mostraContratto(contratto) {
            const totaleExtra = (contratto.extraItems || []).reduce((sum, item) => sum + item.prezzo, 0);
            const totaleASaldo = contratto.auto.prezzoVendita + totaleExtra - (contratto.permuta.valutazione || 0) - contratto.depositoCauzionale + contratto.speseVoltura;
            
            const html = `
                <div class="contract-preview">
                    <!-- Header con logo e titolo -->
                    <div style="text-align: center; margin-bottom: 4px; margin-top: -15px;">
                        <img src="https://gestionalevero.netlify.app/logopericar2.png" alt="PERICAR Logo" style="height: 3.1cm; width: auto; margin-bottom: 2px;">
                        <div style="background: #dc3545; color: white; padding: 6px; margin: 0 -30px; font-size: 0.9rem; font-weight: bold; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">PROPOSTA D'ACQUISTO</div>
                        <div style="text-align: right; margin: 3px 0; font-size: 0.7rem;">
                            <strong>Luogo e data:</strong> ${contratto.luogo}, ${new Date(contratto.dataContratto).toLocaleDateString('it-IT')}
                        </div>
                    </div>

                    <!-- Dati Cliente -->
                    <div style="margin-bottom: 12px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.7rem; border: 1px solid #ddd;">
                            <tr>
                                <td style="padding: 4px; border: 1px solid #eee; font-weight: bold; width: 20%;">Il sottoscritto:</td>
                                <td style="padding: 4px; border: 1px solid #eee; width: 30%;">${contratto.cliente.nome}</td>
                                <td style="padding: 4px; border: 1px solid #eee; font-weight: bold; width: 20%;">Luogo nascita:</td>
                                <td style="padding: 4px; border: 1px solid #eee; width: 30%;">${contratto.cliente.luogoNascita || '___________'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Residenza:</td>
                                <td style="padding: 4px; border: 1px solid #eee;" colspan="3">${contratto.cliente.residenza || '___________'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Codice Fiscale:</td>
                                <td style="padding: 4px; border: 1px solid #eee;">${contratto.cliente.codiceFiscale || '___________'}</td>
                                <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Professione:</td>
                                <td style="padding: 4px; border: 1px solid #eee;">${contratto.cliente.professione || '___________'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Telefono:</td>
                                <td style="padding: 4px; border: 1px solid #eee;">${contratto.cliente.telefono}</td>
                                <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Email:</td>
                                <td style="padding: 4px; border: 1px solid #eee;">${contratto.cliente.email || '___________'}</td>
                            </tr>
                        </table>
                    </div>

                    <!-- Testo introduttivo -->
                    <div style="margin-bottom: 10px; font-size: 0.7rem; line-height: 1.3; text-align: center;">
                        <p style="margin: 6px 0; font-weight: bold;">
                            conferisce alla spettabile <strong style="color: #cc0000;">PERICAR di Giacomo Perissinotto</strong>
                        </p>
                        
                        <p style="margin: 6px 0; font-weight: bold; color: #cc0000; font-size: 0.75rem;">
                            L'ORDINE DI ACQUISTO DEL SEGUENTE VEICOLO:
                        </p>
                    </div>

                    <!-- Dati Veicolo -->
                    <div style="margin-bottom: 12px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.7rem; border: 1px solid #ddd;">
                            <tr>
                                <td style="padding: 4px; border: 1px solid #eee; font-weight: bold; width: 20%;">Marca:</td>
                                <td style="padding: 4px; border: 1px solid #eee; width: 30%;">${contratto.auto.marca}</td>
                                <td style="padding: 4px; border: 1px solid #eee; font-weight: bold; width: 20%;">Modello:</td>
                                <td style="padding: 4px; border: 1px solid #eee; width: 30%;">${contratto.auto.modello}</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Versione:</td>
                                <td style="padding: 4px; border: 1px solid #eee;">${contratto.auto.versione || '___________'}</td>
                                <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Targa:</td>
                                <td style="padding: 4px; border: 1px solid #eee;">${contratto.auto.targa}</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Telaio:</td>
                                <td style="padding: 4px; border: 1px solid #eee;">${contratto.auto.telaio || '___________'}</td>
                                <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Immatricolazione:</td>
                                <td style="padding: 4px; border: 1px solid #eee;">${contratto.auto.dataImmatricolazione ? new Date(contratto.auto.dataImmatricolazione).toLocaleDateString('it-IT') : '___________'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Chilometri:</td>
                                <td style="padding: 4px; border: 1px solid #eee;">${contratto.auto.chilometri.toLocaleString()}</td>
                                <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Prezzo:</td>
                                <td style="padding: 4px; border: 1px solid #eee; font-weight: bold; color: #dc3545;">€${contratto.auto.prezzoVendita.toLocaleString()}</td>
                            </tr>
                        </table>
                    </div>

                    <!-- Layout con due colonne per permuta e riepilogo -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                        <!-- Colonna sinistra - Dati Permuta -->
                        <div>
                            <div style="margin-bottom: 8px;">
                                <h3 style="font-size: 0.8rem; margin-bottom: 5px; background: #dc3545; color: white; padding: 6px; margin: 0 -10px 8px -10px; font-weight: bold; text-align: center;">RITIRO VEICOLO IN PERMUTA</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.7rem; border: 1px solid #ddd;">
                                    <tr>
                                        <td style="padding: 4px; border: 1px solid #eee; font-weight: bold; width: 35%;">Marca:</td>
                                        <td style="padding: 4px; border: 1px solid #eee; width: 65%;">${contratto.permuta.marca || '___________'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Modello:</td>
                                        <td style="padding: 4px; border: 1px solid #eee;">${contratto.permuta.modello || '___________'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Versione:</td>
                                        <td style="padding: 4px; border: 1px solid #eee;">${contratto.permuta.versione || '___________'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Targa:</td>
                                        <td style="padding: 4px; border: 1px solid #eee;">${contratto.permuta.targa || '___________'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Telaio:</td>
                                        <td style="padding: 4px; border: 1px solid #eee;">${contratto.permuta.telaio || '___________'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Immatricolazione:</td>
                                        <td style="padding: 4px; border: 1px solid #eee;">${contratto.permuta.dataImmatricolazione ? new Date(contratto.permuta.dataImmatricolazione).toLocaleDateString('it-IT') : '___________'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Km:</td>
                                        <td style="padding: 4px; border: 1px solid #eee;">${contratto.permuta.chilometri ? contratto.permuta.chilometri.toLocaleString() : '___________'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px; border: 1px solid #eee; font-weight: bold;">Valutazione:</td>
                                        <td style="padding: 4px; border: 1px solid #eee; font-weight: bold; color: #28a745;">${contratto.permuta.valutazione ? '€' + contratto.permuta.valutazione.toLocaleString() : '€___________'}</td>
                                    </tr>
                                </table>
                                <p style="margin-top: 3px; font-size: 0.65rem;">Importo determinato secondo lo stato d'uso attuale, salvo riduzione per deterioramenti successivi.</p>
                            </div>
                        </div>

                        <!-- Colonna destra - Conto Economico -->
                        <div>
                            <div style="border: 2px solid #dc3545; border-radius: 8px; padding: 10px; background: #fff;">
                                <h3 style="font-size: 0.85rem; margin-bottom: 8px; background: #dc3545; color: white; padding: 6px; margin: -10px -10px 8px -10px; border-radius: 6px 6px 0 0; text-align: center;">RIEPILOGO ECONOMICO</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 6px; font-weight: bold;">PREZZO VEICOLO</td>
                                        <td style="padding: 6px; text-align: right; font-weight: bold;">€${contratto.auto.prezzoVendita.toLocaleString()}</td>
                                    </tr>
                                    ${(contratto.extraItems || []).map(item => `
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 6px;">${item.descrizione}</td>
                                        <td style="padding: 6px; text-align: right;">€${item.prezzo.toLocaleString()}</td>
                                    </tr>
                                    `).join('')}
                                    ${totaleExtra > 0 ? `
                                    <tr style="border-bottom: 1px solid #ddd; background: #f0f8ff;">
                                        <td style="padding: 6px; font-weight: bold;">SUBTOTALE</td>
                                        <td style="padding: 6px; text-align: right; font-weight: bold;">€${(contratto.auto.prezzoVendita + totaleExtra).toLocaleString()}</td>
                                    </tr>
                                    ` : ''}
                                    ${contratto.permuta.valutazione > 0 ? `
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 6px;">Valore ritiro</td>
                                        <td style="padding: 6px; text-align: right; color: #28a745;">-€${contratto.permuta.valutazione.toLocaleString()}</td>
                                    </tr>
                                    ` : ''}
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 6px;">Deposito cauzionale</td>
                                        <td style="padding: 6px; text-align: right; color: #28a745;">-€${contratto.depositoCauzionale.toLocaleString()}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 6px;">Spese voltura</td>
                                        <td style="padding: 6px; text-align: right;">€${contratto.speseVoltura.toLocaleString()}</td>
                                    </tr>
                                    <tr style="border-top: 2px solid #dc3545; background: #f8f9fa;">
                                        <td style="padding: 8px; font-weight: bold; font-size: 0.8rem;">TOTALE A SALDO</td>
                                        <td style="padding: 8px; text-align: right; font-weight: bold; font-size: 0.9rem; color: #dc3545;">€${totaleASaldo.toLocaleString()}</td>
                                    </tr>
                                </table>

                                <!-- Firme sotto i calcoli -->
                                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div style="text-align: center;">
                                            <div style="border-bottom: 2px solid #333; margin-bottom: 8px; height: 40px;"></div>
                                            <strong style="font-size: 0.85rem;">Firma acquirente</strong>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="border-bottom: 2px solid #333; margin-bottom: 8px; height: 40px;"></div>
                                            <strong style="font-size: 0.85rem;">Firma venditore</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Info Venditore -->
                            <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 6px; font-size: 0.7rem; text-align: center; border: 1px solid #ddd;">
                                <div style="font-weight: bold; margin-bottom: 2px;">PERICAR di Giacomo Perissinotto</div>
                                <div>P.IVA: 01671440053</div>
                                <div>Corso Casale 99, 14100 Asti (AT)</div>
                                <div>Tel: +39 339 6831296</div>
                                <div>giacomo@pericar.it</div>
                            </div>
                        </div>
                    </div>

                    <!-- Testo legale -->
                    <div style="margin: 6px 0; font-size: 0.65rem; line-height: 1.2;">
                        <p style="margin-bottom: 4px;">Il sottoscritto <strong>${contratto.cliente.nome}</strong> dichiara di essere stato informato di tutto quanto concerne l'acquisto del veicolo oggetto della presente proposta, nonché delle condizioni generali del contratto riportate a tergo, che dichiara di aver compreso e che accetta pienamente, e conferisce alla spettabile <strong>PERICAR di Giacomo Perissinotto</strong></p>
                        
                        <p style="margin: 4px 0; font-weight: bold;">L'ORDINE DI ACQUISTO DEL VEICOLO</p>
                        
                        <p style="margin: 4px 0;">nelle condizioni in cui si trova, accertato in sua presenza, alle condizioni a tergo riportate prendendo altresì atto che il venditore ne effettua la vendita:</p>
                        
                        <div style="margin: 4px 0;">
                            <div style="margin-bottom: 2px;"><strong>☐ IN QUANTO PROPRIETARIO DELLO STESSO</strong></div>
                            <div><strong>☐ IN FORZA DEL MANDATO SPECIALE ALL'UOPO CONFERITO DAL SIG. ________________________</strong></div>
                        </div>
                    </div>

                        </div>
                    </div>

                    <!-- Spazio per note -->
                    <div style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <div style="font-size: 0.7rem; font-weight: bold; margin-bottom: 8px;">NOTE:</div>
                        <div style="border-bottom: 1px solid #ccc; height: 20px;"></div>
                    </div>

                    <div style="page-break-before: always; margin-top: 10px;">
                        <h2 style="text-align: center; margin-bottom: 15px; font-size: 1rem;">CONDIZIONI GENERALI DI VENDITA</h2>
                        
                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 1 - Definizioni</h3>
                            <p>Ai fini del presente contratto si intende per: <strong>Buone condizioni:</strong> componente recentemente sostituito o revisionato; <strong>Condizioni standard:</strong> componente con usura conforme all'età del veicolo; <strong>Intervento consigliato:</strong> componente da ripristinare a breve termine; <strong>Intervento necessario:</strong> componente da sostituire immediatamente per sicurezza.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 2 - Regolamento generale</h3>
                            <p>Con la sottoscrizione del presente documento il compratore versa il deposito cauzionale indicato e accetta integralmente le presenti condizioni generali di vendita. L'ordine diventa definitivo e vincolante per entrambe le parti solo dopo l'accettazione scritta da parte del venditore. Il venditore si riserva il diritto di rifiutare l'ordine entro 48 ore dalla ricezione.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 3 - Prezzo e modalità di pagamento</h3>
                            <p>Il prezzo si intende Franco sede del venditore, salvo diversa pattuizione scritta. Il saldo deve essere corrisposto alla consegna del veicolo mediante bonifico bancario, assegno circolare o contanti nei limiti di legge. Eventuali finanziamenti sono soggetti ad approvazione dell'istituto di credito.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 4 - Consegna e ritiro del veicolo</h3>
                            <p>Il veicolo deve essere ritirato entro 10 giorni dalla data di disponibilità se già presente, o entro 5 giorni dalla comunicazione di arrivo se ordinato. Il mancato ritiro nei termini stabiliti comporta la risoluzione automatica del contratto con incameramento del deposito cauzionale a titolo di penale. Il compratore è tenuto a verificare lo stato del veicolo al momento del ritiro.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 5 - Garanzia di conformità</h3>
                            <p>Per i consumatori si applica la garanzia legale di conformità di 12 mesi prevista dal D.Lgs 206/2005. Il compratore dichiara di aver visionato personalmente il veicolo e di accettarlo nelle condizioni di fatto e di diritto in cui si trova. I difetti di conformità sono coperti solo se non derivanti da normale usura, uso improprio, mancata manutenzione o eventi accidentali. La responsabilità del venditore è esclusa per danni derivanti da uso improprio del veicolo. Per gli acquirenti titolari di partita IVA si applica esclusivamente l'art. 1490 e seguenti del Codice Civile con espressa esclusione della garanzia di conformità.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 6 - Trattamento dati personali (GDPR 2016/679)</h3>
                            <p>Ai sensi del Regolamento UE 2016/679 (GDPR), il Titolare del trattamento PERICAR di Giacomo Perissinotto, con sede in Corso Casale 99, 14100 Asti, informa che i dati personali raccolti saranno trattati per le seguenti finalità: a) adempimento di obblighi contrattuali e di legge; b) gestione del rapporto commerciale; c) attività di marketing diretto (previo consenso). Base giuridica del trattamento: esecuzione del contratto, adempimento di obblighi legali, consenso dell'interessato per il marketing. I dati saranno conservati per 10 anni dalla cessazione del rapporto contrattuale per finalità fiscali e contabili. L'interessato ha diritto di accedere ai propri dati, di chiederne la rettifica, la cancellazione, la limitazione del trattamento, la portabilità e di opporsi al trattamento. Per esercitare tali diritti: giacomo@pericar.it. È possibile proporre reclamo al Garante per la Protezione dei Dati Personali.</p>
                            <div style="display: flex; gap: 15px; margin: 5px 0;">
                                <label style="font-size: 0.5rem;"><input type="checkbox"> NON acconsento al trattamento per finalità di marketing</label>
                                <label style="font-size: 0.5rem;"><input type="checkbox"> ACCONSENTO al trattamento per finalità di marketing</label>
                            </div>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 7 - Tributi e oneri</h3>
                            <p>Tutti i tributi, oneri fiscali, imposte di bollo, spese di trasferimento di proprietà, tasse automobilistiche, assicurazione RC auto obbligatoria e ogni altro onere relativo al veicolo sono a carico esclusivo del compratore. Il venditore fornisce assistenza per le pratiche amministrative presso gli uffici competenti (PRA, Motorizzazione, ACI) dietro rimborso delle spese effettivamente sostenute e compenso per il servizio prestato secondo tariffario vigente. Il compratore è tenuto a provvedere alla copertura assicurativa RC auto prima del ritiro del veicolo.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 8 - Risoluzione controversie e foro competente</h3>
                            <p>Per i rapporti con i consumatori, ai sensi dell'art. 33 del Codice del Consumo, è competente il foro del luogo di residenza o domicilio del compratore. Per i rapporti commerciali tra imprenditori è competente esclusivamente il Tribunale di Asti. Le parti si impegnano a tentare preventivamente la risoluzione amichevole delle controversie attraverso procedure di mediazione presso organismi di conciliazione riconosciuti prima di adire l'autorità giudiziaria. È esclusa la competenza arbitrale salvo diverso accordo scritto tra le parti.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 9 - Diritto di recesso (solo consumatori)</h3>
                            <p>Il consumatore, ai sensi degli artt. 52 e seguenti del Codice del Consumo, ha diritto di recedere dal contratto entro 14 giorni lavorativi dalla consegna del veicolo senza dover fornire alcuna motivazione e senza sostenere penali. Il recesso deve essere comunicato per iscritto tramite raccomandata A/R o PEC. Il veicolo deve essere restituito nelle stesse condizioni in cui è stato consegnato, salvo il deterioramento derivante dalla normale manipolazione per stabilirne la natura e le caratteristiche. Le spese di restituzione sono a carico del consumatore. Il diritto di recesso decade se il veicolo presenta segni di usura, danni o modifiche oltre la normale prova d'uso.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 10 - Clausole finali e modifiche contrattuali</h3>
                            <p>Eventuali modifiche, integrazioni o deroghe al presente contratto devono essere concordate per iscritto e sottoscritte da entrambe le parti per avere validità. La nullità, invalidità o inefficacia di singole clausole non comporta nullità dell'intero contratto, che rimane valido ed efficace nelle parti non viziate. Il contratto è regolato dalla legge italiana. Per quanto non espressamente previsto si applicano le norme del Codice Civile, del Codice del Consumo e della normativa speciale in materia automobilistica. Gli accordi verbali non hanno valore contrattuale.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 11 - Condizioni specifiche per veicoli usati</h3>
                            <p>Il venditore dichiara che il veicolo oggetto della presente vendita è stato sottoposto a regolare manutenzione ordinaria e straordinaria e ai controlli tecnici previsti dalla legge. Tuttavia, trattandosi di veicolo usato, il compratore accetta espressamente che possano essere presenti segni di normale usura, piccoli graffi, ammaccature minori e deterioramenti compatibili con l'età, i chilometri percorsi e l'uso normale del veicolo. Il venditore garantisce la regolarità della documentazione, l'assenza di vincoli, gravami, pignoramenti o fermi amministrativi non dichiarati e la provenienza lecita del veicolo. È esclusa ogni responsabilità per vizi occulti non rilevabili con ordinaria diligenza al momento della consegna.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 12 - Limitazione di responsabilità</h3>
                            <p>La responsabilità del venditore per vizi, difetti o non conformità del veicolo è limitata al valore del veicolo stesso e comunque non può eccedere il prezzo di vendita. È espressamente esclusa ogni responsabilità del venditore per danni indiretti, consequenziali, lucro cessante, perdite di profitto, danni morali, danni a cose o persone derivanti dall'uso del veicolo successivamente alla consegna. Il compratore si impegna a mantenere il veicolo in perfetta efficienza tecnica e di sicurezza, a effettuare regolare manutenzione e a rispettare tutte le norme del Codice della Strada e della circolazione stradale. Il venditore non risponde di sanzioni, multe o violazioni commesse dal compratore.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 13 - Passaggio di proprietà e responsabilità</h3>
                            <p>Il passaggio di proprietà del veicolo avverrà mediante registrazione presso il Pubblico Registro Automobilistico (PRA) entro 60 giorni dalla data del contratto, salvo diversi accordi scritti. Il compratore si impegna a fornire tempestivamente tutta la documentazione necessaria per il perfezionamento delle pratiche. Fino al completamento del passaggio di proprietà presso il PRA, il compratore si assume ogni responsabilità civile, penale, amministrativa e fiscale derivante dalla proprietà, detenzione e uso del veicolo, incluse sanzioni per violazioni del Codice della Strada, tasse automobilistiche e ogni altro onere. Le spese per il passaggio di proprietà, IPT, emolumenti ACI e ogni altra spesa connessa sono a carico del compratore.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 14 - Clausola risolutiva espressa</h3>
                            <p>Ai sensi e per gli effetti dell'art. 1456 del Codice Civile, il contratto si risolve automaticamente di diritto, senza necessità di messa in mora o diffida, nei seguenti casi: a) mancato pagamento del saldo del prezzo nei termini stabiliti; b) mancato ritiro del veicolo nei termini previsti; c) inadempimento di qualsiasi altra obbligazione contrattuale sostanziale; d) falsità delle dichiarazioni rese dal compratore; e) sopravvenuta insolvenza o stato di crisi del compratore. In caso di risoluzione, il venditore ha diritto al risarcimento integrale dei danni subiti, all'incameramento del deposito cauzionale a titolo di penale e al rimborso delle spese legali sostenute, riservandosi ogni ulteriore azione per il maggior danno.</p>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 15 - Normativa applicabile e disposizioni finali</h3>
                            <p>Il presente contratto è regolato dalla legge italiana. Per i rapporti con i consumatori si applicano imperativamente le disposizioni del Codice del Consumo (D.Lgs. 206/2005) e della normativa europea di riferimento. Per i rapporti commerciali tra imprenditori si applicano le disposizioni del Codice Civile e della normativa speciale. Ogni controversia relativa all'interpretazione, esecuzione o risoluzione del presente contratto sarà devoluta alla competenza esclusiva dell'Autorità Giudiziaria del Tribunale di Asti. Il contratto produce i suoi effetti dalla data di sottoscrizione e vincola le parti e i loro successori ed aventi causa a qualsiasi titolo.</p>
                        </div>

                        <div style="margin-top: 10px; padding: 6px; border: 1px solid #333; font-size: 0.5rem;">
                            <p><strong>APPROVAZIONE SPECIFICA (art. 1341-1342 c.c.):</strong> Il compratore dichiara di aver letto, compreso e di approvare espressamente i seguenti articoli delle condizioni generali di vendita: Art. 2 (regolamento generale), Art. 4 (consegna e ritiro), Art. 5 (garanzia di conformità), Art. 8 (foro competente), Art. 12 (limitazione di responsabilità), Art. 14 (clausola risolutiva espressa), Art. 15 (normativa applicabile).</p>
                        </div>

                        <div style="margin-top: 12px;">
                            <div style="text-align: right; margin-bottom: 8px; font-size: 0.6rem;">
                                <strong>${contratto.luogo}, ${new Date(contratto.dataContratto).toLocaleDateString('it-IT')}</strong>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                                <div class="signature-box">
                                    <div class="signature-line"></div>
                                    <strong style="font-size: 0.6rem;">Firma acquirente</strong>
                                </div>
                                <div class="signature-box">
                                    <div class="signature-line"></div>
                                    <strong style="font-size: 0.6rem;">Firma venditore</strong>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 8px; font-size: 0.55rem;">
                            <h3 style="font-size: 0.6rem; margin-bottom: 4px;">Art. 16 - Trattamento dei dati personali (GDPR 2016/679)</h3>
                            <p>Ai sensi del Regolamento UE 2016/679 (GDPR), il Titolare del trattamento PERICAR di Giacomo Perissinotto, con sede in Corso Casale 99, 14100 Asti, P.IVA 01671440053, informa che i dati personali raccolti saranno trattati per le seguenti finalità:</p>
                            <p><strong>a) Finalità contrattuali:</strong> esecuzione del contratto di vendita, gestione del rapporto commerciale, adempimento di obblighi precontrattuali e contrattuali (base giuridica: art. 6, par. 1, lett. b) GDPR);</p>
                            <p><strong>b) Finalità legali:</strong> adempimento di obblighi di legge in materia fiscale, contabile, civilistica e amministrativa (base giuridica: art. 6, par. 1, lett. c) GDPR);</p>
                            <p><strong>c) Finalità di marketing:</strong> invio di comunicazioni commerciali, newsletter, offerte promozionali tramite email, SMS, telefono, posta (base giuridica: consenso dell'interessato ex art. 6, par. 1, lett. a) GDPR).</p>
                            <p><strong>Modalità del trattamento:</strong> I dati saranno trattati con strumenti informatici e cartacei, con logiche strettamente correlate alle finalità e comunque in modo da garantire la sicurezza e la riservatezza dei dati stessi.</p>
                            <p><strong>Conservazione:</strong> I dati saranno conservati per 10 anni dalla cessazione del rapporto contrattuale per finalità fiscali e contabili, salvo diversi termini previsti dalla legge.</p>
                            <p><strong>Comunicazione e diffusione:</strong> I dati potranno essere comunicati a: consulenti fiscali e legali, istituti di credito per pratiche di finanziamento, enti pubblici per adempimenti di legge, fornitori di servizi informatici. I dati non saranno diffusi.</p>
                            <p><strong>Diritti dell'interessato:</strong> L'interessato ha diritto di ottenere dal Titolare: l'accesso ai propri dati personali, la rettifica o la cancellazione degli stessi, la limitazione del trattamento, la portabilità dei dati, l'opposizione al trattamento. Per esercitare tali diritti: giacomo@pericar.it o Corso Casale 99, 14100 Asti. È possibile proporre reclamo al Garante per la Protezione dei Dati Personali.</p>
                            <p><strong>Consenso al marketing:</strong> Il consenso per le finalità di marketing è facoltativo e può essere revocato in qualsiasi momento senza pregiudicare la liceità del trattamento basata sul consenso prestato prima della revoca.</p>
                            
                            <div style="display: flex; gap: 15px; margin: 8px 0; padding: 8px; border: 1px solid #ddd; background: #f9f9f9;">
                                <label style="font-size: 0.5rem; display: flex; align-items: center; gap: 5px;"><input type="checkbox"> <strong>ACCONSENTO</strong> al trattamento dei miei dati personali per finalità di marketing diretto</label>
                                <label style="font-size: 0.5rem; display: flex; align-items: center; gap: 5px;"><input type="checkbox"> <strong>NON ACCONSENTO</strong> al trattamento dei miei dati personali per finalità di marketing diretto</label>
                            </div>
                            
                            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                                    <div style="text-align: center;">
                                        <div style="border-bottom: 2px solid #333; margin-bottom: 8px; height: 40px;"></div>
                                        <strong style="font-size: 0.6rem;">Firma per presa visione<br/>dell'informativa privacy<br/>(Acquirente)</strong>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="border-bottom: 2px solid #333; margin-bottom: 8px; height: 40px;"></div>
                                        <strong style="font-size: 0.6rem;">Firma del Titolare<br/>del trattamento<br/>(PERICAR)</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('contrattoCompleto').innerHTML = html;
            document.getElementById('modalContratto').style.display = 'block';
        }

        function chiudiModalContratto() {
            document.getElementById('modalContratto').style.display = 'none';
        }

        function stampaContratto() {
            const printWindow = window.open('', '_blank');
            const contractContent = document.getElementById('contrattoCompleto').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Contratto</title>
                    <style>
                        body { font-family: Arial, sans-serif; font-size: 0.75rem; line-height: 1.2; margin: 15px; }
                        .contract-preview { background: white; }
                        .contract-header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .contract-section { margin-bottom: 10px; }
                        .contract-section h3 { background: #f8f9fa; padding: 6px; margin-bottom: 8px; border-left: 4px solid #667eea; font-size: 0.85rem; }
                        .signature-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; }
                        .signature-box { text-align: center; padding: 10px 0; }
                        .signature-line { border-bottom: 1px solid #333; margin-bottom: 8px; height: 30px; }
                        table { width: 100%; border-collapse: collapse; font-size: 0.7rem; }
                        td { padding: 6px; border-bottom: 1px solid #ddd; }
                        img { height: 4.2cm; width: auto; display: block; margin: 0 auto 10px auto; }
                        @page { margin: 1cm 1.5cm 1.5cm 1.5cm; size: A4; }
                        @media print {
                            body { font-size: 0.7rem; line-height: 1.1; }
                            .contract-preview { margin: 0; padding: 0; }
                            table { font-size: 0.65rem; }
                            h2 { font-size: 0.9rem; }
                            h3 { font-size: 0.55rem; }
                        }
                    </style>
                </head>
                <body>
                    ${contractContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        function modificaContratto(id) {
            const contratto = contratti.find(c => c.id == id);
            if (!contratto) return;
            
            // Popola i campi del form con i dati del contratto
            document.getElementById('clienteContratto').value = contratto.clienteId;
            document.getElementById('autoContratto').value = contratto.autoId;
            document.getElementById('dataContratto').value = contratto.dataContratto;
            document.getElementById('luogoContratto').value = contratto.luogo;
            
            // Dati permuta
            document.getElementById('marcaPermuta').value = contratto.permuta.marca || '';
            document.getElementById('modelloPermuta').value = contratto.permuta.modello || '';
            document.getElementById('targaPermuta').value = contratto.permuta.targa || '';
            document.getElementById('telaioPermuta').value = contratto.permuta.telaio || '';
            document.getElementById('dataImmatricolazionePermuta').value = contratto.permuta.dataImmatricolazione || '';
            document.getElementById('chilometriPermuta').value = contratto.permuta.chilometri || '';
            document.getElementById('versionePermuta').value = contratto.permuta.versione || '';
            document.getElementById('valutazionePermuta').value = contratto.permuta.valutazione || '';
            
            // Dettagli economici
            document.getElementById('depositoCauzionale').value = contratto.depositoCauzionale || '';
            document.getElementById('speseVoltura').value = contratto.speseVoltura || '';
            
            // Ripristina extra items
            extraItems = [...(contratto.extraItems || [])];
            aggiornaListaExtra();
            
            // Elimina il contratto esistente per permettere la modifica
            eliminaContratto(id);
            
            // Passa al tab contratti
            showTab('contratti');
            document.querySelector('[onclick="showTab(\'contratti\')"]').click();
            
            alert('Contratto caricato per la modifica. Modifica i dati e clicca "Crea Contratto" per salvare.');
        }

        // SALVATAGGIO DATI
        function salvaClienti() {
            localStorage.setItem('clienti', JSON.stringify(clienti));
        }

        function salvaAuto() {
            localStorage.setItem('auto', JSON.stringify(auto));
        }

        function salvaContratti() {
            localStorage.setItem('contratti', JSON.stringify(contratti));
        }

        // GESTIONE SPESE AUTO
        function gestisciSpese(autoId) {
            autoCorrente = auto.find(a => a.id == autoId);
            if (!autoCorrente) return;
            
            // Inizializza array spese se non esiste
            if (!autoCorrente.speseAggiuntive) {
                autoCorrente.speseAggiuntive = [];
            }
            
            document.getElementById('infoAuto').innerHTML = `
                <h3>${autoCorrente.marca} ${autoCorrente.modello} (${autoCorrente.targa})</h3>
                <p><strong>Prezzo Acquisto:</strong> €${autoCorrente.prezzoAcquisto.toLocaleString()}</p>
                <p><strong>Costi Iniziali:</strong> €${(autoCorrente.costiAggiuntivi || 0).toLocaleString()}</p>
                <p><strong>Prezzo Vendita:</strong> €${autoCorrente.prezzoVendita.toLocaleString()}</p>
            `;
            
            // Imposta data odierna
            document.getElementById('dataSpesa').value = new Date().toISOString().split('T')[0];
            
            aggiornaTabellaSpese();
            document.getElementById('modalSpese').style.display = 'block';
        }

        function aggiungiSpesa() {
            if (!autoCorrente) return;
            
            const data = document.getElementById('dataSpesa').value;
            const importo = parseFloat(document.getElementById('importoSpesa').value);
            const categoria = document.getElementById('categoriaSpesa').value;
            const descrizione = document.getElementById('descrizioneSpesa').value;
            
            if (!data || !importo || importo <= 0) {
                alert('Data e importo sono obbligatori!');
                return;
            }
            
            const spesa = {
                id: Date.now(),
                data,
                importo,
                categoria,
                descrizione
            };
            
            autoCorrente.speseAggiuntive.push(spesa);
            salvaAuto();
            aggiornaTabellaSpese();
            aggiornaTabelle();
            aggiornaStatistiche();
            
            // Pulisci form
            document.getElementById('importoSpesa').value = '';
            document.getElementById('descrizioneSpesa').value = '';
        }

        function aggiornaTabellaSpese() {
            if (!autoCorrente) return;
            
            const tbody = document.getElementById('tabellaSpese');
            tbody.innerHTML = '';
            
            const spese = autoCorrente.speseAggiuntive || [];
            let totaleSpese = 0;
            
            spese.forEach(spesa => {
                totaleSpese += spesa.importo;
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(spesa.data).toLocaleDateString('it-IT')}</td>
                    <td><span style="background: #6c757d; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem;">${spesa.categoria}</span></td>
                    <td style="font-weight: bold;">€${spesa.importo.toLocaleString()}</td>
                    <td>${spesa.descrizione || '-'}</td>
                    <td class="actions">
                        <button class="btn btn-danger" onclick="eliminaSpesa(${spesa.id})" style="padding: 4px 8px; font-size: 0.8rem;">🗑️</button>
                    </td>
                `;
            });
            
            // Aggiungi riga totale
            if (spese.length > 0) {
                const row = tbody.insertRow();
                row.style.background = '#f8f9fa';
                row.style.fontWeight = 'bold';
                row.innerHTML = `
                    <td colspan="2"><strong>TOTALE SPESE AGGIUNTIVE</strong></td>
                    <td style="color: #dc3545;"><strong>€${totaleSpese.toLocaleString()}</strong></td>
                    <td colspan="2"></td>
                `;
            }
        }

        function eliminaSpesa(spesaId) {
            if (!autoCorrente || !confirm('Sei sicuro di voler eliminare questa spesa?')) return;
            
            autoCorrente.speseAggiuntive = autoCorrente.speseAggiuntive.filter(s => s.id != spesaId);
            salvaAuto();
            aggiornaTabellaSpese();
            aggiornaTabelle();
            aggiornaStatistiche();
        }

        function chiudiModalSpese() {
            document.getElementById('modalSpese').style.display = 'none';
            autoCorrente = null;
        }

        // REPORT AUTO VENDUTA
        function stampaReportAuto(autoId) {
            const autoObj = auto.find(a => a.id == autoId);
            if (!autoObj) return;
            
            const contratto = contratti.find(c => c.autoId == autoId);
            const speseAggiuntive = autoObj.speseAggiuntive || [];
            const speseAggiuntiveTotali = speseAggiuntive.reduce((sum, spesa) => sum + spesa.importo, 0);
            const costoTotale = autoObj.prezzoAcquisto + (autoObj.costiAggiuntivi || 0) + speseAggiuntiveTotali;
            const margine = autoObj.prezzoVendita - costoTotale;
            
            const printWindow = window.open('', '_blank');
            
            let speseHtml = '';
            if (speseAggiuntive.length > 0) {
                speseHtml = `
                    <h3>Spese Aggiuntive Sostenute</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Data</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Categoria</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Importo</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Descrizione</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${speseAggiuntive.map(spesa => `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${new Date(spesa.data).toLocaleDateString('it-IT')}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${spesa.categoria}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">€${spesa.importo.toLocaleString()}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${spesa.descrizione || '-'}</td>
                                </tr>
                            `).join('')}
                            <tr style="background: #f8f9fa; font-weight: bold;">
                                <td colspan="2" style="border: 1px solid #ddd; padding: 8px;">TOTALE SPESE AGGIUNTIVE</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right; color: #dc3545;">€${speseAggiuntiveTotali.toLocaleString()}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;"></td>
                            </tr>
                        </tbody>
                    </table>
                `;
            }
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Report Auto - ${autoObj.marca} ${autoObj.modello}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
                        .info-box { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
                        .riepilogo { background: #f8f9fa; border: 2px solid #1e40af; padding: 20px; border-radius: 10px; margin-top: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background: #f8f9fa; }
                        .margine-positivo { color: #28a745; font-weight: bold; }
                        .margine-negativo { color: #dc3545; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>REPORT ECONOMICO AUTO VENDUTA</h1>
                        <h2>${autoObj.marca} ${autoObj.modello} (${autoObj.targa})</h2>
                        <p>Data Report: ${new Date().toLocaleDateString('it-IT')}</p>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-box">
                            <h3>Dati Veicolo</h3>
                            <p><strong>Marca:</strong> ${autoObj.marca}</p>
                            <p><strong>Modello:</strong> ${autoObj.modello}</p>
                            <p><strong>Versione:</strong> ${autoObj.versione || '-'}</p>
                            <p><strong>Targa:</strong> ${autoObj.targa}</p>
                            <p><strong>Telaio:</strong> ${autoObj.telaio || '-'}</p>
                            <p><strong>Immatricolazione:</strong> ${autoObj.dataImmatricolazione ? new Date(autoObj.dataImmatricolazione).toLocaleDateString('it-IT') : '-'}</p>
                            <p><strong>Chilometri:</strong> ${autoObj.chilometri.toLocaleString()}</p>
                            <p><strong>Tipo:</strong> ${autoObj.tipo}</p>
                        </div>
                        
                        <div class="info-box">
                            <h3>Dati Vendita</h3>
                            <p><strong>Cliente:</strong> ${contratto ? contratto.cliente.nome : 'N/D'}</p>
                            <p><strong>Data Vendita:</strong> ${contratto ? new Date(contratto.dataContratto).toLocaleDateString('it-IT') : 'N/D'}</p>
                            <p><strong>Prezzo Vendita:</strong> €${autoObj.prezzoVendita.toLocaleString()}</p>
                            ${contratto && contratto.permuta.valutazione > 0 ? `<p><strong>Permuta:</strong> ${contratto.permuta.marca} ${contratto.permuta.modello} - €${contratto.permuta.valutazione.toLocaleString()}</p>` : ''}
                        </div>
                    </div>
                    
                    <h3>Costi Sostenuti</h3>
                    <table style="margin-bottom: 20px;">
                        <thead>
                            <tr>
                                <th>Tipo Costo</th>
                                <th style="text-align: right;">Importo</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Prezzo Acquisto</td>
                                <td style="text-align: right;">€${autoObj.prezzoAcquisto.toLocaleString()}</td>
                                <td>Costo iniziale del veicolo</td>
                            </tr>
                            ${(autoObj.costiAggiuntivi || 0) > 0 ? `
                            <tr>
                                <td>Costi Iniziali</td>
                                <td style="text-align: right;">€${(autoObj.costiAggiuntivi || 0).toLocaleString()}</td>
                                <td>${autoObj.descrizioneCosti || 'Costi sostenuti all\'acquisto'}</td>
                            </tr>
                            ` : ''}
                        </tbody>
                    </table>
                    
                    ${speseHtml}
                    
                    <div class="riepilogo">
                        <h2>RIEPILOGO ECONOMICO</h2>
                        <table>
                            <tr>
                                <td><strong>Prezzo Vendita</strong></td>
                                <td style="text-align: right;"><strong>€${autoObj.prezzoVendita.toLocaleString()}</strong></td>
                            </tr>
                            <tr>
                                <td>Costo Acquisto</td>
                                <td style="text-align: right;">-€${autoObj.prezzoAcquisto.toLocaleString()}</td>
                            </tr>
                            ${(autoObj.costiAggiuntivi || 0) > 0 ? `
                            <tr>
                                <td>Costi Iniziali</td>
                                <td style="text-align: right;">-€${(autoObj.costiAggiuntivi || 0).toLocaleString()}</td>
                            </tr>
                            ` : ''}
                            ${speseAggiuntiveTotali > 0 ? `
                            <tr>
                                <td>Spese Aggiuntive</td>
                                <td style="text-align: right;">-€${speseAggiuntiveTotali.toLocaleString()}</td>
                            </tr>
                            ` : ''}
                            <tr style="border-top: 2px solid #333; font-size: 1.2rem;">
                                <td><strong>MARGINE NETTO</strong></td>
                                <td style="text-align: right;" class="${margine >= 0 ? 'margine-positivo' : 'margine-negativo'}">
                                    <strong>${margine >= 0 ? '+' : ''}€${margine.toLocaleString()}</strong>
                                </td>
                            </tr>
                        </table>
                        
                        <div style="margin-top: 15px; padding: 10px; background: ${margine >= 0 ? '#d4edda' : '#f8d7da'}; border-radius: 5px;">
                            <p style="margin: 0; font-weight: bold; color: ${margine >= 0 ? '#155724' : '#721c24'};">
                                ${margine >= 0 ? '✅ Vendita in UTILE' : '❌ Vendita in PERDITA'}
                            </p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center; font-size: 0.9rem; color: #666;">
                        <p>Report generato da PERICAR - Sistema Gestione Concessionaria</p>
                        <p>Corso Casale 99, 14100 Asti (AT) - Tel: +39 339 6831296</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        // Chiudi modal cliccando fuori
        window.onclick = function(event) {
            const modalModifica = document.getElementById('modalModifica');
            const modalContratto = document.getElementById('modalContratto');
            const modalSpese = document.getElementById('modalSpese');
            
            if (event.target == modalModifica) {
                chiudiModal();
            }
            if (event.target == modalContratto) {
                chiudiModalContratto();
            }
            if (event.target == modalSpese) {
                chiudiModalSpese();
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96bde2f7f484ed6b',t:'MTc1NDY0NDI4OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
